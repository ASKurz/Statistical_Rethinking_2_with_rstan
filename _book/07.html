<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical rethinking 2 with rstan and the tidyverse - 7&nbsp; Ulysses’ Compass</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./06.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./07.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses' Compass</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Statistical rethinking</em> 2 with rstan and the tidyverse</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Golem of Prague</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Small Worlds and Large Worlds</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Haunted DAG &amp; The Causal Terror</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses’ Compass</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-problem-with-parameters" id="toc-the-problem-with-parameters" class="nav-link active" data-scroll-target="#the-problem-with-parameters"><span class="header-section-number">7.1</span> The problem with parameters</a>
  <ul class="collapse">
  <li><a href="#more-parameters-almost-always-improve-fit." id="toc-more-parameters-almost-always-improve-fit." class="nav-link" data-scroll-target="#more-parameters-almost-always-improve-fit."><span class="header-section-number">7.1.1</span> More parameters (almost) always improve fit.</a></li>
  <li><a href="#too-few-parameters-hurts-too." id="toc-too-few-parameters-hurts-too." class="nav-link" data-scroll-target="#too-few-parameters-hurts-too."><span class="header-section-number">7.1.2</span> Too few parameters hurts, too.</a></li>
  </ul></li>
  <li><a href="#entropy-and-accuracy" id="toc-entropy-and-accuracy" class="nav-link" data-scroll-target="#entropy-and-accuracy"><span class="header-section-number">7.2</span> Entropy and accuracy</a>
  <ul class="collapse">
  <li><a href="#firing-the-weatherperson." id="toc-firing-the-weatherperson." class="nav-link" data-scroll-target="#firing-the-weatherperson."><span class="header-section-number">7.2.1</span> Firing the weatherperson.</a></li>
  <li><a href="#information-and-uncertainty." id="toc-information-and-uncertainty." class="nav-link" data-scroll-target="#information-and-uncertainty."><span class="header-section-number">7.2.2</span> Information and uncertainty.</a></li>
  <li><a href="#from-entropy-to-accuracy." id="toc-from-entropy-to-accuracy." class="nav-link" data-scroll-target="#from-entropy-to-accuracy."><span class="header-section-number">7.2.3</span> From entropy to accuracy.</a></li>
  <li><a href="#sec-Estimating-divergence" id="toc-sec-Estimating-divergence" class="nav-link" data-scroll-target="#sec-Estimating-divergence"><span class="header-section-number">7.2.4</span> Estimating divergence.</a></li>
  <li><a href="#scoring-the-right-data." id="toc-scoring-the-right-data." class="nav-link" data-scroll-target="#scoring-the-right-data."><span class="header-section-number">7.2.5</span> Scoring the right data.</a></li>
  </ul></li>
  <li><a href="#golem-taming-regularization" id="toc-golem-taming-regularization" class="nav-link" data-scroll-target="#golem-taming-regularization"><span class="header-section-number">7.3</span> Golem taming: regularization</a></li>
  <li><a href="#predicting-predictive-accuracy" id="toc-predicting-predictive-accuracy" class="nav-link" data-scroll-target="#predicting-predictive-accuracy"><span class="header-section-number">7.4</span> Predicting predictive accuracy</a>
  <ul class="collapse">
  <li><a href="#cross-validation." id="toc-cross-validation." class="nav-link" data-scroll-target="#cross-validation."><span class="header-section-number">7.4.1</span> Cross-validation.</a></li>
  <li><a href="#information-criteria." id="toc-information-criteria." class="nav-link" data-scroll-target="#information-criteria."><span class="header-section-number">7.4.2</span> Information criteria.</a></li>
  <li><a href="#comparing-cv-psis-and-waic." id="toc-comparing-cv-psis-and-waic." class="nav-link" data-scroll-target="#comparing-cv-psis-and-waic."><span class="header-section-number">7.4.3</span> Comparing CV, PSIS, and WAIC.</a></li>
  </ul></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison"><span class="header-section-number">7.5</span> Model comparison</a>
  <ul class="collapse">
  <li><a href="#sec-Model-mis-selection" id="toc-sec-Model-mis-selection" class="nav-link" data-scroll-target="#sec-Model-mis-selection"><span class="header-section-number">7.5.1</span> Model mis-selection.</a></li>
  <li><a href="#sec-Outliers-and-other-illusions" id="toc-sec-Outliers-and-other-illusions" class="nav-link" data-scroll-target="#sec-Outliers-and-other-illusions"><span class="header-section-number">7.5.2</span> Outliers and other illusions.</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">7.6</span> Summary</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses’ Compass</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Load the packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loo)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop grid lines</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="rethinking-stargazing." class="level4" data-number="7.0.0.1">
<h4 data-number="7.0.0.1" class="anchored" data-anchor-id="rethinking-stargazing."><span class="header-section-number">7.0.0.1</span> Rethinking stargazing.</h4>
</section>
<section id="rethinking-is-aic-bayesian" class="level4" data-number="7.0.0.2">
<h4 data-number="7.0.0.2" class="anchored" data-anchor-id="rethinking-is-aic-bayesian"><span class="header-section-number">7.0.0.2</span> Rethinking: Is AIC Bayesian?</h4>
</section>
<section id="the-problem-with-parameters" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="the-problem-with-parameters"><span class="header-section-number">7.1</span> The problem with parameters</h2>
<section id="more-parameters-almost-always-improve-fit." class="level3" data-number="7.1.1">
<h3 data-number="7.1.1" class="anchored" data-anchor-id="more-parameters-almost-always-improve-fit."><span class="header-section-number">7.1.1</span> More parameters (almost) always improve fit.</h3>
<p>We’ll start off by making the data with brain size and body size for seven <code>species</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">species =</span> <span class="fu">c</span>(<span class="st">"afarensis"</span>, <span class="st">"africanus"</span>, <span class="st">"habilis"</span>, <span class="st">"boisei"</span>, <span class="st">"rudolfensis"</span>, <span class="st">"ergaster"</span>, <span class="st">"sapiens"</span>), </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">brain   =</span> <span class="fu">c</span>(<span class="dv">438</span>, <span class="dv">452</span>, <span class="dv">612</span>, <span class="dv">521</span>, <span class="dv">752</span>, <span class="dv">871</span>, <span class="dv">1350</span>), </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mass    =</span> <span class="fu">c</span>(<span class="fl">37.0</span>, <span class="fl">35.5</span>, <span class="fl">34.5</span>, <span class="fl">41.5</span>, <span class="fl">55.5</span>, <span class="fl">61.0</span>, <span class="fl">53.5</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  species     brain  mass
  &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
1 afarensis     438  37  
2 africanus     452  35.5
3 habilis       612  34.5
4 boisei        521  41.5
5 rudolfensis   752  55.5
6 ergaster      871  61  
7 sapiens      1350  53.5</code></pre>
</div>
</div>
<p>Here’s Figure 7.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>  mass, <span class="at">y =</span> brain, <span class="at">label =</span> species)) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>, <span class="at">size =</span> <span class="fl">2.2</span>, <span class="at">vjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"body mass (kg)"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"brain volume (cc)"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Average brain volume by body mass for</span><span class="sc">\n</span><span class="st">six hominin species"</span>) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">30</span>, <span class="dv">65</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="360"></p>
</div>
</div>
<p>Before fitting our models, rescale a couple of the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mass_std  =</span> (mass <span class="sc">-</span> <span class="fu">mean</span>(mass)) <span class="sc">/</span> <span class="fu">sd</span>(mass),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">brain_std =</span> brain <span class="sc">/</span> <span class="fu">max</span>(brain))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our first statistical model will follow the form</p>
<p><span class="math display">\[
\begin{align*}
\text{brain-std}_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i              &amp; = \alpha + \beta \text{mass-std}_i \\
\alpha             &amp; \sim \operatorname{Normal}(0.5, 1) \\
\beta              &amp; \sim \operatorname{Normal}(0, 10) \\
\sigma             &amp; \sim \operatorname{Log-Normal}(0, 1).
\end{align*}
\]</span></p>
<p>A careful study of McElreath’s <strong>R</strong> code 7.3 will show he is modeling <code>log_sigma</code>, rather than <span class="math inline">\(\sigma\)</span>. We’ll consider the implications for that in the code shortly.</p>
<p>Part of the challenge for this section is we’ll be fitting several closely-related models. We could do that one model at a time, but that would require a lot of redundant and inefficient code. Instead, we’ll take the opportunity to show an approach that streamlines the process. But since this requires we adopt several steps we haven’t often used, we’ll spend a lot of time up front describing them one at a time. Then after the exposition, we’ll show the code for the fully developed streamlined approach.</p>
<p>To start, define the <code>stan_data</code> with the <code>compose_data()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(brain_std, mass_std) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ brain_std: num [1:7(1d)] 0.324 0.335 0.453 0.386 0.557 ...
 $ mass_std : num [1:7(1d)] -0.779 -0.917 -1.009 -0.367 0.917 ...
 $ n        : int 7</code></pre>
</div>
</div>
<p>Define the initial <code>model_code_7.1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mass_std;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real b0;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real b1;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real log_sigma;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(b0 + b1 * mass_std, exp(log_sigma));</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b0 ~ normal(0.5, 1);</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b1 ~ normal(0, 10);</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="st">  log_sigma ~ normal(0, 1);</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that whereas we usually define our <span class="math inline">\(\sigma\)</span> parameters as <code>real&lt;lower=0&gt;</code>, we have defined <code>log_sigma</code> as simply <code>real</code>. Also note that we have <code>exp(log_sigma)</code> in the likelihood line, which is how you put the posterior of <code>log_sigma</code> back on the natural zero-bounded <span class="math inline">\(\sigma\)</span> metric.</p>
<p>Compile and fit this initial model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_7<span class="fl">.1</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m7<span class="fl">.1</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

           mean se_mean   sd  5.5% 94.5% n_eff Rhat
b0         0.52    0.00 0.11  0.35  0.69  2032 1.00
b1         0.17    0.00 0.12 -0.02  0.35  1812 1.00
log_sigma -1.40    0.01 0.38 -1.93 -0.75  1134 1.00
lp__       5.89    0.06 1.62  2.82  7.59   834 1.01

Samples were drawn using NUTS(diag_e) at Thu Aug  1 11:13:37 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Here we use <code>as_draws_df()</code> to plot the posterior of the <code>log_sigma</code>, after exponentiation. For comparison, we’ll add the sample standard deviation as the red diamond.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m7<span class="fl">.1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(log_sigma))) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">point_interval =</span> median_qi, <span class="at">.width =</span> <span class="fl">0.89</span>, <span class="at">adjust =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"point"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="fu">sd</span>(d<span class="sc">$</span>brain_std), <span class="at">y =</span> <span class="sc">-</span><span class="fl">0.05</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="408"></p>
</div>
</div>
<p>Now granted, <code>exp(log_sigma)</code> is the <em>residual</em> standard deviation, not the unconditional sample standard deviation. But the two are nevertheless somewhat comparable, and hopefully this helps clarify the <code>log_sigma</code> parameter.</p>
<p>Here’s the point estimate for the <span class="math inline">\(R^2\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m7<span class="fl">.1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(d <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(species, brain_std, mass_std)) <span class="sc">|&gt;</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu =</span> b0 <span class="sc">+</span> b1 <span class="sc">*</span> mass_std) <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> brain_std <span class="sc">-</span> mu) <span class="sc">|&gt;</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species) <span class="sc">|&gt;</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual =</span> <span class="fu">mean</span>(residual),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain_std =</span> <span class="fu">mean</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual_var =</span> <span class="fu">var</span>(residual),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome_var =</span> <span class="fu">var</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r2 =</span> <span class="dv">1</span> <span class="sc">-</span> residual_var <span class="sc">/</span> outcome_var)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  residual_var outcome_var    r2
         &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;
1       0.0291      0.0570 0.490</code></pre>
</div>
</div>
<p>This matches up closely with the book’s value of 0.477 (p.&nbsp;197).</p>
<p>Since <strong>rstan</strong> models do not work for functions like <code>fitted()</code> or <code>predict()</code>, I’m not sure about making a general-purpose <code>R2_is_bad()</code> function for our models. However, we do want a method that will scale to computing <span class="math inline">\(\widehat{R^2}\)</span> from a variety of models, and the current approach won’t work well for that since it will require different equations for <code>mu</code> for each model.</p>
<p>One way to solve this is to include a <code>generated quantities</code> block in the <code>model_code</code>, like we did for <code>m5.4</code> in <a href="05.html#sec-Predictor-residual-plots"><span>Section&nbsp;5.1.5.1</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.1</span>gq <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mass_std;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real b0;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real b1;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real log_sigma;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(b0 + b1 * mass_std, exp(log_sigma));</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b0 ~ normal(0.5, 1);</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b1 ~ normal(0, 10);</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="st">  log_sigma ~ normal(0, 1);</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = b0 + b1 * mass_std;  // Expected values for each case</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compile and fit the second version of the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>gq <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_7<span class="fl">.1</span>gq,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m7<span class="fl">.1</span>gq, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

           mean se_mean   sd  5.5% 94.5% n_eff Rhat
b0         0.52    0.00 0.11  0.35  0.69  2032 1.00
b1         0.17    0.00 0.12 -0.02  0.35  1812 1.00
log_sigma -1.40    0.01 0.38 -1.93 -0.75  1134 1.00
mu[1]      0.40    0.00 0.14  0.16  0.61  1990 1.00
mu[2]      0.37    0.00 0.16  0.13  0.60  1900 1.00
mu[3]      0.36    0.00 0.16  0.10  0.60  1852 1.00
mu[4]      0.46    0.00 0.12  0.29  0.64  2036 1.00
mu[5]      0.68    0.00 0.16  0.45  0.91  1928 1.00
mu[6]      0.76    0.00 0.21  0.45  1.06  1888 1.00
mu[7]      0.65    0.00 0.14  0.44  0.85  1943 1.00
lp__       5.89    0.06 1.62  2.82  7.59   834 1.01

Samples were drawn using NUTS(diag_e) at Thu Aug  1 11:13:42 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Now we have a series of <code>mu[i]</code> posteriors in addition to the usual model parameters. These are our expected or fitted values, one for each of the 7 cases in the data set. Just to check, we can confirm these are the same as the fitted values we might compute by working pushing the observed predictor values for <code>mass_std</code> through the posterior distributions for <code>b0</code> and <code>b1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the posterior draws, and make the `mu[i]` columns long</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m7<span class="fl">.1</span>gq) <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"mu"</span>), <span class="at">values_to =</span> <span class="st">"mu"</span>, <span class="at">names_to =</span> <span class="st">"i"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">str_extract</span>(i, <span class="st">"</span><span class="sc">\\</span><span class="st">d"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.integer</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add in the observed values</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d <span class="sc">|&gt;</span> </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(i)) <span class="sc">|&gt;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the expected values by hand</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> b0 <span class="sc">+</span> b1 <span class="sc">*</span> mass_std) <span class="sc">|&gt;</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare the `mu[i]` values with their hand-made `fitted` counterparts</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">all_equal =</span> <span class="fu">all.equal</span>(mu, fitted))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  all_equal
  &lt;lgl&gt;    
1 TRUE     </code></pre>
</div>
</div>
<p>Recall we can also extract the draws for the <code>mu[i]</code> expectations in a handy long format with <code>spread_draws()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>gq <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(mu[i]) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 28,000
Columns: 5
Groups: i [7]
$ i          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ mu         &lt;dbl&gt; 0.6116193, 0.3411885, 0.4582914, 0.3471304, 0.5020851, 0.46…
$ .chain     &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ .iteration &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …
$ .draw      &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …</code></pre>
</div>
</div>
<p>Thus we can use a slightly more compact <code>spread_draws(mu[i])</code>-based workflow to compute the point estimate for the <span class="math inline">\(R^2\)</span> from the <code>m7.1</code> model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>gq <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(mu[i]) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d <span class="sc">|&gt;</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(i)) <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> brain_std <span class="sc">-</span> mu) <span class="sc">|&gt;</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species) <span class="sc">|&gt;</span> </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual =</span> <span class="fu">mean</span>(residual),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain_std =</span> <span class="fu">mean</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual_var =</span> <span class="fu">var</span>(residual),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome_var =</span> <span class="fu">var</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r2 =</span> <span class="dv">1</span> <span class="sc">-</span> residual_var <span class="sc">/</span> outcome_var)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  residual_var outcome_var    r2
         &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;
1       0.0291      0.0570 0.490</code></pre>
</div>
</div>
<p>To make the fitted line-ribbons displayed in Figure 7.3, we’ll also want a streamlined way to compute those values for several model types. As a first step toward that aim, we will adopt the <code>model.matrix()</code> approach we introduced in <a href="06.html#sec-A-second-method"><span>Section&nbsp;6.3.2.1</span></a>. Here we make a <code>model.matrix()</code> object for the first model called <code>mm_7.1</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a model matrix</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>mm_7<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="at">data =</span> d, <span class="at">object =</span> <span class="sc">~</span>mass_std)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(mm_7<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:7, 1:2] 1 1 1 1 1 ...
 - attr(*, "dimnames")=List of 2
  ..$ : chr [1:7] "1" "2" "3" "4" ...
  ..$ : chr [1:2] "(Intercept)" "mass_std"
 - attr(*, "assign")= int [1:2] 0 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mm_7<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)   mass_std
1           1 -0.7794667
2           1 -0.9170196
3           1 -1.0087216
4           1 -0.3668079
5           1  0.9170196
6           1  1.4213804</code></pre>
</div>
</div>
<p>We can use this <code>mm_7.1</code> object to define two new elements within <code>compose_data()</code>. The first will be <code>X</code>, the entire model matrix <code>mm_7.1</code>. The second will be <code>k</code>, the number of columns (i.e., “predictors”) in the design matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(brain_std, mass_std) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define `X` and `k` right in the `compose_data()` function</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>(<span class="at">X =</span> mm_7<span class="fl">.1</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">k =</span> <span class="fu">ncol</span>(mm_7<span class="fl">.1</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ brain_std: num [1:7(1d)] 0.324 0.335 0.453 0.386 0.557 ...
 $ mass_std : num [1:7(1d)] -0.779 -0.917 -1.009 -0.367 0.917 ...
 $ n        : int 7
 $ X        : num [1:7, 1:2] 1 1 1 1 1 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:7] "1" "2" "3" "4" ...
  .. ..$ : chr [1:2] "(Intercept)" "mass_std"
  ..- attr(*, "assign")= int [1:2] 0 1
 $ k        : int 2</code></pre>
</div>
</div>
<p>Now update the <code>model_code</code> to use the <code>model.matrix()</code> approach to for the blocks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.1</span>mm <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; k;       // Number of coefficients (including intercept)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;  </span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[n, k] X;       // Regressors from the model matrix (including intercept)</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[k] b;     // The beta coefficients are now defined by a vector</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real log_sigma;  </span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(X * b, exp(log_sigma));  // Linear model defined in matrix algebra notation Xb</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="st">  b[1] ~ normal(0.5, 1);                      // Priors for the `b` coefficients now use `[]` indices</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b[2] ~ normal(0, 10);</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="st">  log_sigma ~ normal(0, 1);</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = X * b;  // Expected values computed with matrix algebra notation Xb</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compile and fit the third version of the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>mm <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_7<span class="fl">.1</span>mm,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m7<span class="fl">.1</span>mm, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

           mean se_mean   sd  5.5% 94.5% n_eff Rhat
b[1]       0.53    0.00 0.11  0.36  0.69  2028    1
b[2]       0.17    0.00 0.12 -0.01  0.35  1914    1
log_sigma -1.40    0.01 0.39 -1.95 -0.72  1259    1
mu[1]      0.40    0.00 0.14  0.18  0.61  1859    1
mu[2]      0.38    0.00 0.15  0.14  0.60  1850    1
mu[3]      0.36    0.00 0.16  0.11  0.60  1846    1
mu[4]      0.47    0.00 0.12  0.29  0.64  1925    1
mu[5]      0.68    0.00 0.17  0.45  0.92  2075    1
mu[6]      0.77    0.00 0.21  0.46  1.07  2041    1
mu[7]      0.65    0.00 0.15  0.44  0.87  2085    1
lp__       5.87    0.05 1.64  2.85  7.59   949    1

Samples were drawn using NUTS(diag_e) at Thu Aug  1 11:13:47 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>The results are within HMC simulation variance to the ones from the previous version of the model, <code>m7.1gq</code>. But now the input elements in the various blocks of the <code>model_code</code> are general enough they will scale to models with different predictors.</p>
<p>As a last step, we’ll add another <code>model.matrix()</code> element to the <code>stan_data</code> to support the fitted lines for the six models displayed in Figure 7.3. To make a smooth line and 89%-CI ribbon for each model, we’ll need a way to feed in a tight sequence of body-mass values into each of the models. We here define those values in a data frame called <code>d_pred</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>d_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mass_std =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 1
$ mass_std &lt;dbl&gt; -2.000000, -1.959596, -1.919192, -1.878788, -1.838384, -1.797…</code></pre>
</div>
</div>
<p>Now we have our sequence of predictor values in <code>d_pred</code>, we can add them to the <code>stan_data</code> via the <code>model.matrix()</code> function. Within the <code>stan_data</code>, we’ll call this new matrix <code>Xpred</code>. Here’s what that looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(brain_std, mass_std) <span class="sc">|&gt;</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>(<span class="at">X =</span> mm_7<span class="fl">.1</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>               <span class="co"># This line is new</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">Xpred =</span> <span class="fu">model.matrix</span>(<span class="at">data =</span> d_pred, <span class="at">object =</span> <span class="sc">~</span>mass_std),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">k =</span> <span class="fu">ncol</span>(mm_7<span class="fl">.1</span>))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 6
 $ brain_std: num [1:7(1d)] 0.324 0.335 0.453 0.386 0.557 ...
 $ mass_std : num [1:7(1d)] -0.779 -0.917 -1.009 -0.367 0.917 ...
 $ n        : int 7
 $ X        : num [1:7, 1:2] 1 1 1 1 1 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:7] "1" "2" "3" "4" ...
  .. ..$ : chr [1:2] "(Intercept)" "mass_std"
  ..- attr(*, "assign")= int [1:2] 0 1
 $ Xpred    : num [1:100, 1:2] 1 1 1 1 1 1 1 1 1 1 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:100] "1" "2" "3" "4" ...
  .. ..$ : chr [1:2] "(Intercept)" "mass_std"
  ..- attr(*, "assign")= int [1:2] 0 1
 $ k        : int 2</code></pre>
</div>
</div>
<p>Now update the <code>model_code</code> to include 2 sections in the <code>generated quantities</code> block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.1</span>gq2 <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; k;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;  </span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[n, k] X;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[100, k] Xpred;  // New data for fitted lines</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[k] b;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real log_sigma;  </span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(X * b, exp(log_sigma));</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b[1] ~ normal(0.5, 1);</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b[2] ~ normal(0, 10);</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="st">  log_sigma ~ normal(0, 1);</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = X * b;</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[100] fitted;  // A second section for the fitted lines</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="st">  fitted = Xpred * b;</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compile and fit the final version of the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>gq2 <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_7<span class="fl">.1</span>gq2,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m7<span class="fl">.1</span>gq2, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m suppressing the <code>print()</code> output for the sake of space. Now it contains an additional 100 rows for the new <code>fitted[b]</code> values. But if you’re following along with code on your computer, do give that output a look.</p>
<p>Here’s how to showcase those <code>fitted[b]</code> values in a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute R2 and save as a data frame</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>d_r2 <span class="ot">&lt;-</span> m7<span class="fl">.1</span>gq2 <span class="sc">|&gt;</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(mu[i]) <span class="sc">|&gt;</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d <span class="sc">|&gt;</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(i)) <span class="sc">|&gt;</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> brain_std <span class="sc">-</span> mu) <span class="sc">|&gt;</span> </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species) <span class="sc">|&gt;</span> </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual =</span> <span class="fu">mean</span>(residual),</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain_std =</span> <span class="fu">mean</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual_var =</span> <span class="fu">var</span>(residual),</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome_var =</span> <span class="fu">var</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">r2 =</span> <span class="fu">str_c</span>(<span class="st">"widehat(italic(R)^2)=="</span>, <span class="fu">round</span>(<span class="dv">1</span> <span class="sc">-</span> residual_var <span class="sc">/</span> outcome_var, <span class="at">digits =</span> <span class="dv">2</span>)),</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">mass =</span> <span class="fu">min</span>(d<span class="sc">$</span>mass),</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain =</span> <span class="fu">max</span>(d<span class="sc">$</span>brain))</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Start wrangling the `fitted[]` draws for the plot</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>gq2 <span class="sc">|&gt;</span> </span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(fitted[row]) <span class="sc">|&gt;</span> </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the fitted values back to the `brain` metric</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">brain =</span> fitted <span class="sc">*</span> <span class="fu">max</span>(d<span class="sc">$</span>brain)) <span class="sc">|&gt;</span> </span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join the `d_pred` data</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_pred <span class="sc">|&gt;</span> </span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(row)) <span class="sc">|&gt;</span> </span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the `mass_std` values back to the `mass` metric</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mass =</span> mass_std <span class="sc">*</span> <span class="fu">sd</span>(d<span class="sc">$</span>mass) <span class="sc">+</span> <span class="fu">mean</span>(d<span class="sc">$</span>mass)) <span class="sc">|&gt;</span> </span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot!</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mass, <span class="at">y =</span> brain)) <span class="sc">+</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.67</span>, <span class="fl">0.89</span>), </span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"lightblue4"</span>, <span class="at">linewidth =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d) <span class="sc">+</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add in the R2 estimate</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> d_r2,</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> r2),</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"body mass (kg)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">35</span>, <span class="dv">47</span>, <span class="dv">60</span>)) <span class="sc">+</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"brain volume (cc)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">450</span>, <span class="dv">900</span>, <span class="dv">1300</span>)) <span class="sc">+</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="st">"lightblue2"</span>)) <span class="sc">+</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">32</span>, <span class="dv">63</span>),</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">400</span>, <span class="dv">1400</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Consistent with my <strong>brms</strong> translation, the models fit with <code>stan()</code> consistently show wider 89% intervals than the ones McElreath showed fit with <code>quap()</code> in this part of the text. However, the <code>stan()</code>-based 67% intervals are pretty close to the intervals displayed in Figure 7.3 in the text, so we’ll show both for the plots to come.</p>
<p>Now we have a workflow that supports fitting, summarizing, and plotting the first linear model and it’s curvier variants, we’re ready to work in bulk.</p>
<p>First, we update both the <code>d</code> and <code>d_pred</code> data frames to include <code>mass_std1</code> through <code>mass_std6</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mass_std1 =</span> mass_std,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std2 =</span> mass_std<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std3 =</span> mass_std<span class="sc">^</span><span class="dv">3</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std4 =</span> mass_std<span class="sc">^</span><span class="dv">4</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std5 =</span> mass_std<span class="sc">^</span><span class="dv">5</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std6 =</span> mass_std<span class="sc">^</span><span class="dv">6</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>d_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mass_std1 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">100</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mass_std2 =</span> mass_std1<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std3 =</span> mass_std1<span class="sc">^</span><span class="dv">3</span>,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std4 =</span> mass_std1<span class="sc">^</span><span class="dv">4</span>,</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std5 =</span> mass_std1<span class="sc">^</span><span class="dv">5</span>,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">mass_std6 =</span> mass_std1<span class="sc">^</span><span class="dv">6</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 7
Columns: 11
$ species   &lt;chr&gt; "afarensis", "africanus", "habilis", "boisei", "rudolfensis"…
$ brain     &lt;dbl&gt; 438, 452, 612, 521, 752, 871, 1350
$ mass      &lt;dbl&gt; 37.0, 35.5, 34.5, 41.5, 55.5, 61.0, 53.5
$ mass_std  &lt;dbl&gt; -0.7794667, -0.9170196, -1.0087216, -0.3668079, 0.9170196, 1…
$ brain_std &lt;dbl&gt; 0.3244444, 0.3348148, 0.4533333, 0.3859259, 0.5570370, 0.645…
$ mass_std1 &lt;dbl&gt; -0.7794667, -0.9170196, -1.0087216, -0.3668079, 0.9170196, 1…
$ mass_std2 &lt;dbl&gt; 0.6075683, 0.8409250, 1.0175193, 0.1345480, 0.8409250, 2.020…
$ mass_std3 &lt;dbl&gt; -0.47357927, -0.77114476, -1.02639367, -0.04935326, 0.771144…
$ mass_std4 &lt;dbl&gt; 0.36913927, 0.70715489, 1.03534547, 0.01810317, 0.70715489, …
$ mass_std5 &lt;dbl&gt; -0.287731766, -0.648474917, -1.044375339, -0.006640383, 0.64…
$ mass_std6 &lt;dbl&gt; 0.224277328, 0.594664234, 1.053483965, 0.002435745, 0.594664…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100
Columns: 6
$ mass_std1 &lt;dbl&gt; -2.000000, -1.959596, -1.919192, -1.878788, -1.838384, -1.79…
$ mass_std2 &lt;dbl&gt; 4.000000, 3.840016, 3.683298, 3.529844, 3.379655, 3.232731, …
$ mass_std3 &lt;dbl&gt; -8.000000, -7.524880, -7.068955, -6.631828, -6.213103, -5.81…
$ mass_std4 &lt;dbl&gt; 16.000000, 14.745725, 13.566681, 12.459798, 11.422069, 10.45…
$ mass_std5 &lt;dbl&gt; -32.000000, -28.895664, -26.037065, -23.409317, -20.998147, …
$ mass_std6 &lt;dbl&gt; 64.0000000, 56.6238262, 49.9701253, 43.9811416, 38.6026537, …</code></pre>
</div>
</div>
<p>We are going to fit and store the models and their output within a nested data frame. As a first step, we’ll define the six models by their names in the <code>name</code> column, the number of predictors (excluding the intercept) in the <code>predictors</code> column, and the formulas for their model matrices in a <code>formula</code> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>d_fits <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">model =</span> <span class="fu">str_c</span>(<span class="st">"m7."</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predictors =</span> <span class="fu">str_remove</span>(model, <span class="st">"m7."</span>) <span class="sc">|&gt;</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.integer</span>(),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">formula =</span> <span class="fu">c</span>(</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1 <span class="sc">+</span> mass_std2,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1 <span class="sc">+</span> mass_std2 <span class="sc">+</span> mass_std3,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1 <span class="sc">+</span> mass_std2 <span class="sc">+</span> mass_std3 <span class="sc">+</span> mass_std4,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1 <span class="sc">+</span> mass_std2 <span class="sc">+</span> mass_std3 <span class="sc">+</span> mass_std4 <span class="sc">+</span> mass_std5,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1 <span class="sc">+</span> mass_std2 <span class="sc">+</span> mass_std3 <span class="sc">+</span> mass_std4 <span class="sc">+</span> mass_std5 <span class="sc">+</span> mass_std6)) </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d_fits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  model predictors formula  
  &lt;chr&gt;      &lt;int&gt; &lt;list&gt;   
1 m7.1           1 &lt;formula&gt;
2 m7.2           2 &lt;formula&gt;
3 m7.3           3 &lt;formula&gt;
4 m7.4           4 &lt;formula&gt;
5 m7.5           5 &lt;formula&gt;
6 m7.6           6 &lt;formula&gt;</code></pre>
</div>
</div>
<p>Now compute the <code>model.matrix()</code> output for each using the <code>formula</code> column as input to the <code>object</code> argument, via the <code>map()</code> function, and save the contents as a nested column named <code>mm</code>. Then compute the <code>d_pred</code> data frames for each model using the numbers in the <code>predictors</code> column as input for subsetting the necessary columns from the external object <code>d_pred</code>, via <code>map()</code>. We save the results of that operation as a nested column named <code>d_pred</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>d_fits <span class="ot">&lt;-</span> d_fits <span class="sc">|&gt;</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mm =</span> <span class="fu">map</span>(<span class="at">.x =</span> formula, <span class="at">.f =</span><span class="sc">~</span> <span class="fu">model.matrix</span>(<span class="at">data =</span> d, <span class="at">object =</span> .x)),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">d_pred =</span> <span class="fu">map</span>(<span class="at">.x =</span> predictors, <span class="at">.f =</span><span class="sc">~</span> d_pred <span class="sc">|&gt;</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">select</span>(mass_std1<span class="sc">:</span><span class="fu">str_c</span>(<span class="st">"mass_std"</span>, .x))))</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d_fits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  model predictors formula   mm            d_pred        
  &lt;chr&gt;      &lt;int&gt; &lt;list&gt;    &lt;list&gt;        &lt;list&gt;        
1 m7.1           1 &lt;formula&gt; &lt;dbl [7 × 2]&gt; &lt;df [100 × 1]&gt;
2 m7.2           2 &lt;formula&gt; &lt;dbl [7 × 3]&gt; &lt;df [100 × 2]&gt;
3 m7.3           3 &lt;formula&gt; &lt;dbl [7 × 4]&gt; &lt;df [100 × 3]&gt;
4 m7.4           4 &lt;formula&gt; &lt;dbl [7 × 5]&gt; &lt;df [100 × 4]&gt;
5 m7.5           5 &lt;formula&gt; &lt;dbl [7 × 6]&gt; &lt;df [100 × 5]&gt;
6 m7.6           6 &lt;formula&gt; &lt;dbl [7 × 7]&gt; &lt;df [100 × 6]&gt;</code></pre>
</div>
</div>
<p>Next we compute the <code>stan_data</code> using the <code>mm</code>, <code>d_pred</code>, and <code>formula</code> columns as input for the <code>compose_data()</code> and <code>model.matrix()</code> functions, all via the <code>pmap()</code> function. We save the results in a nested column named <code>stan_data</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>d_fits <span class="ot">&lt;-</span> d_fits <span class="sc">|&gt;</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stan_data =</span> <span class="fu">pmap</span>(<span class="at">.l =</span> <span class="fu">list</span>(mm, d_pred, formula), </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.f =</span><span class="sc">~</span> d <span class="sc">|&gt;</span> </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">select</span>(brain_std<span class="sc">:</span>mass_std6) <span class="sc">|&gt;</span> </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">compose_data</span>(<span class="at">X =</span> ..<span class="dv">1</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">Xpred =</span> <span class="fu">model.matrix</span>(<span class="at">data =</span> ..<span class="dv">2</span>, <span class="at">object =</span> ..<span class="dv">3</span>),</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">k =</span> <span class="fu">ncol</span>(..<span class="dv">1</span>))))</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d_fits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  model predictors formula   mm            d_pred         stan_data        
  &lt;chr&gt;      &lt;int&gt; &lt;list&gt;    &lt;list&gt;        &lt;list&gt;         &lt;list&gt;           
1 m7.1           1 &lt;formula&gt; &lt;dbl [7 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list [11]&gt;
2 m7.2           2 &lt;formula&gt; &lt;dbl [7 × 3]&gt; &lt;df [100 × 2]&gt; &lt;named list [11]&gt;
3 m7.3           3 &lt;formula&gt; &lt;dbl [7 × 4]&gt; &lt;df [100 × 3]&gt; &lt;named list [11]&gt;
4 m7.4           4 &lt;formula&gt; &lt;dbl [7 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list [11]&gt;
5 m7.5           5 &lt;formula&gt; &lt;dbl [7 × 6]&gt; &lt;df [100 × 5]&gt; &lt;named list [11]&gt;
6 m7.6           6 &lt;formula&gt; &lt;dbl [7 × 7]&gt; &lt;df [100 × 6]&gt; &lt;named list [11]&gt;</code></pre>
</div>
</div>
<p>Define a generic <code>model_code</code> for all 6 models. This is the same as the previous one with one last addition: Now we have used the syntax of <code>b[2:k]</code> to refer to all non-intercept <span class="math inline">\(\beta\)</span> parameters within the <code>model</code> block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.1</span>to6 <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; k;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;  </span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[n, k] X;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[100, k] Xpred;</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[k] b;</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real log_sigma; </span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(X * b, exp(log_sigma));</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b[1] ~ normal(0.5, 1);</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b[2:k] ~ normal(0, 10);  // New general-purpose notation for the non-intercept `beta[k]` priors</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="st">  log_sigma ~ normal(0, 1);</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[100] fitted;</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = X * b;</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="st">  fitted = Xpred * b;</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compile with <code>stan_model()</code> and save the DSO as <code>stan_dso</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>stan_dso <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> model_code_7<span class="fl">.1</span>to6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now draw from the posterior distributions of all 6 models by using the <code>sampling()</code> function within <code>map()</code>, saving the results in a nested column called <code>sampling</code> within the <code>d_fits</code> data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>d_fits <span class="ot">&lt;-</span> d_fits <span class="sc">|&gt;</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sampling =</span> <span class="fu">map</span>(<span class="at">.x =</span> stan_data, </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span><span class="sc">~</span> <span class="fu">sampling</span>(</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">object =</span> stan_dso, </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> .x,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="dv">7</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extract the <code>as_draws_df()</code> output from each model with <code>map()</code>, saving the results in a column named <code>as_draws_df</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>d_fits <span class="ot">&lt;-</span> d_fits <span class="sc">|&gt;</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">as_draws_df =</span> <span class="fu">map</span>(<span class="at">.x =</span> sampling, <span class="at">.f =</span> as_draws_df))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>d_fits <span class="sc">|&gt;</span> </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, sampling, as_draws_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  model sampling          as_draws_df             
  &lt;chr&gt; &lt;list&gt;            &lt;list&gt;                  
1 m7.1  &lt;stanfit[,4,111]&gt; &lt;draws_df [4,000 × 114]&gt;
2 m7.2  &lt;stanfit[,4,112]&gt; &lt;draws_df [4,000 × 115]&gt;
3 m7.3  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;
4 m7.4  &lt;stanfit[,4,114]&gt; &lt;draws_df [4,000 × 117]&gt;
5 m7.5  &lt;stanfit[,4,115]&gt; &lt;draws_df [4,000 × 118]&gt;
6 m7.6  &lt;stanfit[,4,116]&gt; &lt;draws_df [4,000 × 119]&gt;</code></pre>
</div>
</div>
<p>Update the <code>d_r2</code> for all models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>d_r2 <span class="ot">&lt;-</span> d_fits <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, .draw, <span class="fu">starts_with</span>(<span class="st">"mu"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"mu"</span>), <span class="at">names_to =</span> <span class="st">"i"</span>, <span class="at">values_to =</span> <span class="st">"mu"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">str_extract</span>(i, <span class="st">"</span><span class="sc">\\</span><span class="st">d"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.integer</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d <span class="sc">|&gt;</span> </span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(i)) <span class="sc">|&gt;</span> </span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> brain_std <span class="sc">-</span> mu) <span class="sc">|&gt;</span> </span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, species) <span class="sc">|&gt;</span> </span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual =</span> <span class="fu">mean</span>(residual),</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain_std =</span> <span class="fu">mean</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual_var =</span> <span class="fu">var</span>(residual),</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome_var =</span> <span class="fu">var</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">model =</span> model, </span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">r2 =</span> <span class="fu">str_c</span>(<span class="st">"widehat(italic(R)^2)=="</span>, <span class="fu">round</span>(<span class="dv">1</span> <span class="sc">-</span> residual_var <span class="sc">/</span> outcome_var, <span class="at">digits =</span> <span class="dv">2</span>)),</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">mass =</span> <span class="fu">min</span>(d<span class="sc">$</span>mass),</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain =</span> <span class="fu">max</span>(d<span class="sc">$</span>brain))</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d_r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  model r2                          mass brain
  &lt;chr&gt; &lt;chr&gt;                      &lt;dbl&gt; &lt;dbl&gt;
1 m7.1  widehat(italic(R)^2)==0.49  34.5  1350
2 m7.2  widehat(italic(R)^2)==0.54  34.5  1350
3 m7.3  widehat(italic(R)^2)==0.68  34.5  1350
4 m7.4  widehat(italic(R)^2)==0.8   34.5  1350
5 m7.5  widehat(italic(R)^2)==0.94  34.5  1350
6 m7.6  widehat(italic(R)^2)==0.93  34.5  1350</code></pre>
</div>
</div>
<p>Make the full version of Figure 7.3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>d_fits <span class="sc">|&gt;</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, .draw, <span class="fu">starts_with</span>(<span class="st">"fitted"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"fitted"</span>), <span class="at">names_to =</span> <span class="st">"row"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">str_extract</span>(row, <span class="st">"</span><span class="sc">\\</span><span class="st">d+"</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">brain =</span> value <span class="sc">*</span> <span class="fu">max</span>(d<span class="sc">$</span>brain)) <span class="sc">|&gt;</span> </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_pred <span class="sc">|&gt;</span> </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(row)) <span class="sc">|&gt;</span> </span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mass =</span> mass_std1 <span class="sc">*</span> <span class="fu">sd</span>(d<span class="sc">$</span>mass) <span class="sc">+</span> <span class="fu">mean</span>(d<span class="sc">$</span>mass)) <span class="sc">|&gt;</span> </span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mass, <span class="at">y =</span> brain)) <span class="sc">+</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.67</span>, <span class="fl">0.89</span>), </span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"lightblue4"</span>, <span class="at">linewidth =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d) <span class="sc">+</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> d_r2,</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> r2),</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"body mass (kg)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">35</span>, <span class="dv">47</span>, <span class="dv">60</span>)) <span class="sc">+</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"brain volume (cc)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">450</span>, <span class="dv">900</span>, <span class="dv">1300</span>)) <span class="sc">+</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="st">"lightblue2"</span>)) <span class="sc">+</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">32</span>, <span class="dv">63</span>),</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">400</span>, <span class="dv">1400</span>)) <span class="sc">+</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Though the fitted lines for all our models are much less certain than the <code>quap()</code>-based ones McElreath displayed in the text, they’re most notably so for the last model <code>m7.6</code>. This phenomena is connected at least in part to the increasing uncertainty in the <code>exp(log_sigma)</code> posterior for the models. Here they are in a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>d_fits <span class="sc">|&gt;</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(log_sigma), <span class="at">y =</span> model)) <span class="sc">+</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">.width =</span> <span class="fl">0.89</span>) <span class="sc">+</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>But McElreath wrote:</p>
<blockquote class="blockquote">
<p>That last model, <code>m7.6</code>, has one trick in it. The standard deviation is replaced with a constant value 0.001. (p.&nbsp;198)</p>
</blockquote>
<p>We can do that with <code>stan()</code>, too. But here we’ll abandon our bulk data frame work flow and fit this version of the model separate. First, define <code>model_code_7.6b</code> with <span class="math inline">\(\sigma\)</span> fixed to a constant 0.001.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.6</span>b <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; k;</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;  </span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[n, k] X;</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[100, k] Xpred;</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[k] b;</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(X * b, 0.001);  // Set sigma to a constant</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="st">  b[1] ~ normal(0.5, 1);</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b[2:k] ~ normal(0, 10);</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="st">  // Note how `sigma`, or `log_sigma` for that matter, no longer has a prior</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = X * b;</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[100] fitted;</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a><span class="st">  fitted = Xpred * b;</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compile and fit the special version of the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.6</span>b <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note how we're reusing the `stan_data` from `d_fits`</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d_fits <span class="sc">|&gt;</span> </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">6</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(stan_data) <span class="sc">|&gt;</span> </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(stan_data),</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_7<span class="fl">.6</span>b,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we’ll restrict the model summary by using the <code>pars</code> argument within <code>print()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m7<span class="fl">.6</span>b, <span class="at">pars =</span> <span class="st">"b"</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

      mean se_mean   sd    5% 94.5% n_eff Rhat
b[1]  0.51       0 0.01  0.49  0.52   200 1.01
b[2]  0.88       0 0.01  0.86  0.90   201 1.01
b[3]  1.70       0 0.04  1.64  1.76   199 1.01
b[4] -0.61       0 0.04 -0.67 -0.56   197 1.01
b[5] -3.47       0 0.06 -3.57 -3.38   198 1.01
b[6] -0.35       0 0.02 -0.38 -0.31   196 1.01
b[7]  1.63       0 0.03  1.58  1.67   197 1.01

Samples were drawn using NUTS(diag_e) at Thu Aug  1 11:14:20 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Because we used the <code>0.001</code> constant in the likelihood, we nave no <code>sigma</code> or <code>log_sigma</code> parameter. It’s a constant. Anyway, here’s the plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute R2 and save as a data frame</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>d_r2 <span class="ot">&lt;-</span> m7<span class="fl">.6</span>b <span class="sc">|&gt;</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(mu[i]) <span class="sc">|&gt;</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d <span class="sc">|&gt;</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(i)) <span class="sc">|&gt;</span> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> brain_std <span class="sc">-</span> mu) <span class="sc">|&gt;</span> </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species) <span class="sc">|&gt;</span> </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual =</span> <span class="fu">mean</span>(residual),</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain_std =</span> <span class="fu">mean</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">residual_var =</span> <span class="fu">var</span>(residual),</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome_var =</span> <span class="fu">var</span>(brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">r2 =</span> <span class="fu">str_c</span>(<span class="st">"widehat(italic(R)^2)=="</span>, <span class="fu">round</span>(<span class="dv">1</span> <span class="sc">-</span> residual_var <span class="sc">/</span> outcome_var, <span class="at">digits =</span> <span class="dv">2</span>)),</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">mass =</span> <span class="fu">min</span>(d<span class="sc">$</span>mass),</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">brain =</span> <span class="dv">1900</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Start wrangling the `fitted[]` draws for the plot</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.6</span>b <span class="sc">|&gt;</span> </span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(fitted[row]) <span class="sc">|&gt;</span> </span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the fitted values back to the `brain` metric</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">brain =</span> fitted <span class="sc">*</span> <span class="fu">max</span>(d<span class="sc">$</span>brain)) <span class="sc">|&gt;</span> </span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join the `d_pred` data</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_pred <span class="sc">|&gt;</span> </span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(row)) <span class="sc">|&gt;</span> </span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the `mass_std` values back to the `mass` metric</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mass =</span> mass_std1 <span class="sc">*</span> <span class="fu">sd</span>(d<span class="sc">$</span>mass) <span class="sc">+</span> <span class="fu">mean</span>(d<span class="sc">$</span>mass)) <span class="sc">|&gt;</span> </span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot!</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mass, <span class="at">y =</span> brain)) <span class="sc">+</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.67</span>, <span class="fl">0.89</span>), </span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"lightblue4"</span>, <span class="at">linewidth =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d) <span class="sc">+</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add in the R2 estimate</span></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> d_r2,</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> r2),</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"body mass (kg)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">35</span>, <span class="dv">47</span>, <span class="dv">60</span>)) <span class="sc">+</span></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"brain volume (cc)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">450</span>, <span class="dv">1300</span>)) <span class="sc">+</span></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="st">"lightblue2"</span>)) <span class="sc">+</span></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">32</span>, <span class="dv">63</span>),</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">400</span>, <span class="dv">2000</span>)) <span class="sc">+</span></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"m7.6b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Now the results are very close to those McElreath displayed in the text.</p>
<section id="rethinking-model-fitting-as-compression." class="level4" data-number="7.1.1.1">
<h4 data-number="7.1.1.1" class="anchored" data-anchor-id="rethinking-model-fitting-as-compression."><span class="header-section-number">7.1.1.1</span> Rethinking: Model fitting as compression.</h4>
</section>
</section>
<section id="too-few-parameters-hurts-too." class="level3" data-number="7.1.2">
<h3 data-number="7.1.2" class="anchored" data-anchor-id="too-few-parameters-hurts-too."><span class="header-section-number">7.1.2</span> Too few parameters hurts, too.</h3>
<p>To explore the distinctions between overfitting and underfitting, we’ll need to refit <code>b7.1</code> and <code>b7.4</code> several times after serially dropping one of the rows in the data. You can <code>filter()</code> by <code>row_number()</code> to drop rows. For example, we can drop the second row of <code>d</code> like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">!=</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
  species brain  mass mass_std brain_std mass_std1 mass_std2 mass_std3 mass_std4
  &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 afaren…   438  37     -0.779     0.324    -0.779     0.608   -0.474     0.369 
2 habilis   612  34.5   -1.01      0.453    -1.01      1.02    -1.03      1.04  
3 boisei    521  41.5   -0.367     0.386    -0.367     0.135   -0.0494    0.0181
4 rudolf…   752  55.5    0.917     0.557     0.917     0.841    0.771     0.707 
5 ergast…   871  61      1.42      0.645     1.42      2.02     2.87      4.08  
6 sapiens  1350  53.5    0.734     1         0.734     0.538    0.395     0.290 
# ℹ 3 more variables: mass_std5 &lt;dbl&gt;, mass_std6 &lt;dbl&gt;, row &lt;int&gt;</code></pre>
</div>
</div>
<p>In his <strong>Overthinking: Dropping rows</strong> box (p.&nbsp;202), McElreath encouraged us to take a look at the <code>brain_loo_plot()</code> function to get a sense of how he made his Figure 7.4. You can do so by executing <code>rethinking::brain_loo_plot</code> in your console. Our approach will be different. We’ll begin by defining a <code>d_fits_subset</code> data frame starting with <code>model</code>, <code>predictors</code>, and <code>formula</code> columns like before. This time we add a new column called <code>row</code>, which we’ll use to reference which row we’d like to drop for a given iteration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>d_fits_subset <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">model =</span> <span class="fu">str_c</span>(<span class="st">"m7."</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predictors =</span> <span class="fu">str_remove</span>(model, <span class="st">"m7."</span>) <span class="sc">|&gt;</span> </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.integer</span>(),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">formula =</span> <span class="fu">c</span>(</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span> mass_std1 <span class="sc">+</span> mass_std2 <span class="sc">+</span> mass_std3 <span class="sc">+</span> mass_std4)) <span class="sc">|&gt;</span> </span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d_fits_subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 14
Columns: 4
$ model      &lt;chr&gt; "m7.1", "m7.1", "m7.1", "m7.1", "m7.1", "m7.1", "m7.1", "m7…
$ predictors &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 4
$ formula    &lt;list&gt; &lt;~mass_std1&gt;, &lt;~mass_std1&gt;, &lt;~mass_std1&gt;, &lt;~mass_std1&gt;, &lt;~m…
$ row        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7</code></pre>
</div>
</div>
<p>Add a <code>mm</code> column based on <code>model.matrix()</code> output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>d_fits_subset <span class="ot">&lt;-</span> d_fits_subset <span class="sc">|&gt;</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mm =</span> <span class="fu">map2</span>(<span class="at">.x =</span> row,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">.y =</span> formula,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">.f =</span><span class="sc">~</span> <span class="fu">model.matrix</span>(<span class="at">data =</span> d <span class="sc">|&gt;</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">!=</span> .x),</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">object =</span> .y)))</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d_fits_subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 5
   model predictors formula     row mm           
   &lt;chr&gt;      &lt;int&gt; &lt;list&gt;    &lt;int&gt; &lt;list&gt;       
 1 m7.1           1 &lt;formula&gt;     1 &lt;dbl [6 × 2]&gt;
 2 m7.1           1 &lt;formula&gt;     2 &lt;dbl [6 × 2]&gt;
 3 m7.1           1 &lt;formula&gt;     3 &lt;dbl [6 × 2]&gt;
 4 m7.1           1 &lt;formula&gt;     4 &lt;dbl [6 × 2]&gt;
 5 m7.1           1 &lt;formula&gt;     5 &lt;dbl [6 × 2]&gt;
 6 m7.1           1 &lt;formula&gt;     6 &lt;dbl [6 × 2]&gt;
 7 m7.1           1 &lt;formula&gt;     7 &lt;dbl [6 × 2]&gt;
 8 m7.4           4 &lt;formula&gt;     1 &lt;dbl [6 × 5]&gt;
 9 m7.4           4 &lt;formula&gt;     2 &lt;dbl [6 × 5]&gt;
10 m7.4           4 &lt;formula&gt;     3 &lt;dbl [6 × 5]&gt;
11 m7.4           4 &lt;formula&gt;     4 &lt;dbl [6 × 5]&gt;
12 m7.4           4 &lt;formula&gt;     5 &lt;dbl [6 × 5]&gt;
13 m7.4           4 &lt;formula&gt;     6 &lt;dbl [6 × 5]&gt;
14 m7.4           4 &lt;formula&gt;     7 &lt;dbl [6 × 5]&gt;</code></pre>
</div>
</div>
<p>Next we add the <code>d_pred</code> column like before. When we define the <code>stan_data</code> this time, we also include the <code>row</code> column as one of the inputs in <code>pmap()</code>, which will allow us to subset the <code>d</code> data we input to <code>compose_data()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>d_fits_subset <span class="ot">&lt;-</span> d_fits_subset <span class="sc">|&gt;</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d_pred =</span> <span class="fu">map</span>(<span class="at">.x =</span> predictors, <span class="at">.f =</span><span class="sc">~</span> d_pred <span class="sc">|&gt;</span> </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">select</span>(mass_std1<span class="sc">:</span><span class="fu">str_c</span>(<span class="st">"mass_std"</span>, .x)))) <span class="sc">|&gt;</span> </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stan_data =</span> <span class="fu">pmap</span>(<span class="at">.l =</span> <span class="fu">list</span>(row, mm, d_pred, formula), </span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.f =</span><span class="sc">~</span> d <span class="sc">|&gt;</span> </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">!=</span> ..<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">select</span>(brain_std<span class="sc">:</span>mass_std6) <span class="sc">|&gt;</span> </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">compose_data</span>(<span class="at">X =</span> ..<span class="dv">2</span>,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">Xpred =</span> <span class="fu">model.matrix</span>(<span class="at">data =</span> ..<span class="dv">3</span>, <span class="at">object =</span> ..<span class="dv">4</span>),</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">k =</span> <span class="fu">ncol</span>(..<span class="dv">2</span>))))</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(d_fits_subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 7
   model predictors formula     row mm            d_pred         stan_data   
   &lt;chr&gt;      &lt;int&gt; &lt;list&gt;    &lt;int&gt; &lt;list&gt;        &lt;list&gt;         &lt;list&gt;      
 1 m7.1           1 &lt;formula&gt;     1 &lt;dbl [6 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list&gt;
 2 m7.1           1 &lt;formula&gt;     2 &lt;dbl [6 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list&gt;
 3 m7.1           1 &lt;formula&gt;     3 &lt;dbl [6 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list&gt;
 4 m7.1           1 &lt;formula&gt;     4 &lt;dbl [6 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list&gt;
 5 m7.1           1 &lt;formula&gt;     5 &lt;dbl [6 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list&gt;
 6 m7.1           1 &lt;formula&gt;     6 &lt;dbl [6 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list&gt;
 7 m7.1           1 &lt;formula&gt;     7 &lt;dbl [6 × 2]&gt; &lt;df [100 × 1]&gt; &lt;named list&gt;
 8 m7.4           4 &lt;formula&gt;     1 &lt;dbl [6 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list&gt;
 9 m7.4           4 &lt;formula&gt;     2 &lt;dbl [6 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list&gt;
10 m7.4           4 &lt;formula&gt;     3 &lt;dbl [6 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list&gt;
11 m7.4           4 &lt;formula&gt;     4 &lt;dbl [6 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list&gt;
12 m7.4           4 &lt;formula&gt;     5 &lt;dbl [6 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list&gt;
13 m7.4           4 &lt;formula&gt;     6 &lt;dbl [6 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list&gt;
14 m7.4           4 &lt;formula&gt;     7 &lt;dbl [6 × 5]&gt; &lt;df [100 × 4]&gt; &lt;named list&gt;</code></pre>
</div>
</div>
<p>Now fit the models with <code>sampling()</code> within <code>map()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>d_fits_subset <span class="ot">&lt;-</span> d_fits_subset <span class="sc">|&gt;</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sampling =</span> <span class="fu">map</span>(<span class="at">.x =</span> stan_data, </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span><span class="sc">~</span> <span class="fu">sampling</span>(</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">object =</span> stan_dso, </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> .x,</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="dv">7</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extract the <code>as_draws_df()</code> output from each model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>d_fits_subset <span class="ot">&lt;-</span> d_fits_subset <span class="sc">|&gt;</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">as_draws_df =</span> <span class="fu">map</span>(<span class="at">.x =</span> sampling, <span class="at">.f =</span> as_draws_df))</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>d_fits_subset <span class="sc">|&gt;</span> </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, sampling, as_draws_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 3
   model sampling          as_draws_df             
   &lt;chr&gt; &lt;list&gt;            &lt;list&gt;                  
 1 m7.1  &lt;stanfit[,4,110]&gt; &lt;draws_df [4,000 × 113]&gt;
 2 m7.1  &lt;stanfit[,4,110]&gt; &lt;draws_df [4,000 × 113]&gt;
 3 m7.1  &lt;stanfit[,4,110]&gt; &lt;draws_df [4,000 × 113]&gt;
 4 m7.1  &lt;stanfit[,4,110]&gt; &lt;draws_df [4,000 × 113]&gt;
 5 m7.1  &lt;stanfit[,4,110]&gt; &lt;draws_df [4,000 × 113]&gt;
 6 m7.1  &lt;stanfit[,4,110]&gt; &lt;draws_df [4,000 × 113]&gt;
 7 m7.1  &lt;stanfit[,4,110]&gt; &lt;draws_df [4,000 × 113]&gt;
 8 m7.4  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;
 9 m7.4  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;
10 m7.4  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;
11 m7.4  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;
12 m7.4  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;
13 m7.4  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;
14 m7.4  &lt;stanfit[,4,113]&gt; &lt;draws_df [4,000 × 116]&gt;</code></pre>
</div>
</div>
<p>Here’s our version of Figure 7.4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>d_fits_subset <span class="sc">|&gt;</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, row, as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"fitted"</span>), <span class="at">names_to =</span> <span class="st">"m"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">m =</span> <span class="fu">str_extract</span>(m, <span class="st">"</span><span class="sc">\\</span><span class="st">d+"</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">brain =</span> value <span class="sc">*</span> <span class="fu">max</span>(d<span class="sc">$</span>brain)) <span class="sc">|&gt;</span> </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_pred <span class="sc">|&gt;</span> </span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">m =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(m)) <span class="sc">|&gt;</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mass =</span> mass_std1 <span class="sc">*</span> <span class="fu">sd</span>(d<span class="sc">$</span>mass) <span class="sc">+</span> <span class="fu">mean</span>(d<span class="sc">$</span>mass)) <span class="sc">|&gt;</span> </span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mass, <span class="at">y =</span> brain)) <span class="sc">+</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">group =</span> row),</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="dv">0</span>, </span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">color =</span> <span class="st">"lightblue4"</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d) <span class="sc">+</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"body mass (kg)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">35</span>, <span class="dv">47</span>, <span class="dv">60</span>)) <span class="sc">+</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"brain volume (cc)"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">450</span>, <span class="dv">900</span>, <span class="dv">1300</span>, <span class="dv">2000</span>)) <span class="sc">+</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">34</span>, <span class="dv">61</span>),</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2000</span>)) <span class="sc">+</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="504"></p>
</div>
</div>
<section id="rethinking-bias-and-variance." class="level4" data-number="7.1.2.1">
<h4 data-number="7.1.2.1" class="anchored" data-anchor-id="rethinking-bias-and-variance."><span class="header-section-number">7.1.2.1</span> Rethinking: Bias and variance.</h4>
</section>
</section>
</section>
<section id="entropy-and-accuracy" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="entropy-and-accuracy"><span class="header-section-number">7.2</span> Entropy and accuracy</h2>
<section id="firing-the-weatherperson." class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="firing-the-weatherperson."><span class="header-section-number">7.2.1</span> Firing the weatherperson.</h3>
<section id="costs-and-benefits." class="level4" data-number="7.2.1.1">
<h4 data-number="7.2.1.1" class="anchored" data-anchor-id="costs-and-benefits."><span class="header-section-number">7.2.1.1</span> Costs and benefits.</h4>
</section>
<section id="measuring-accuracy." class="level4" data-number="7.2.1.2">
<h4 data-number="7.2.1.2" class="anchored" data-anchor-id="measuring-accuracy."><span class="header-section-number">7.2.1.2</span> Measuring accuracy.</h4>
</section>
<section id="rethinking-calibration-is-overrated." class="level4" data-number="7.2.1.3">
<h4 data-number="7.2.1.3" class="anchored" data-anchor-id="rethinking-calibration-is-overrated."><span class="header-section-number">7.2.1.3</span> Rethinking: Calibration is overrated.</h4>
</section>
</section>
<section id="information-and-uncertainty." class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="information-and-uncertainty."><span class="header-section-number">7.2.2</span> Information and uncertainty.</h3>
<p>The formula for information entropy is:</p>
<p><span class="math display">\[H(p) = - \text E \log (p_i) = - \sum_{i = 1}^n p_i \log (p_i).\]</span></p>
<p>McElreath put it in words as: “The uncertainty contained in a probability distribution is the average log-probability of an event.” (p.&nbsp;206). We’ll compute the information entropy for weather at the first unnamed location, which we’ll call <code>McElreath's house</code>, and <code>Abu Dhabi</code> at once.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">place  =</span> <span class="fu">c</span>(<span class="st">"McElreath's house"</span>, <span class="st">"Abu Dhabi"</span>),</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">p_rain =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.01</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_shine =</span> <span class="dv">1</span> <span class="sc">-</span> p_rain) <span class="sc">|&gt;</span> </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(place) <span class="sc">|&gt;</span> </span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">h_p =</span> (p_rain <span class="sc">*</span> <span class="fu">log</span>(p_rain) <span class="sc">+</span> p_shine <span class="sc">*</span> <span class="fu">log</span>(p_shine)) <span class="sc">|&gt;</span> <span class="fu">mean</span>() <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
# Groups:   place [2]
  place             p_rain p_shine    h_p
  &lt;chr&gt;              &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
1 McElreath's house   0.3     0.7  0.611 
2 Abu Dhabi           0.01    0.99 0.0560</code></pre>
</div>
</div>
<p>If you have sun, rain and snow, the entropy for weather is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="fu">sum</span>(p <span class="sc">*</span> <span class="fu">log</span>(p))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8188085</code></pre>
</div>
</div>
<section id="overthinking-more-on-entropy." class="level4" data-number="7.2.2.1">
<h4 data-number="7.2.2.1" class="anchored" data-anchor-id="overthinking-more-on-entropy."><span class="header-section-number">7.2.2.1</span> Overthinking: More on entropy.</h4>
</section>
<section id="rethinking-the-benefits-of-maximizing-uncertainty." class="level4" data-number="7.2.2.2">
<h4 data-number="7.2.2.2" class="anchored" data-anchor-id="rethinking-the-benefits-of-maximizing-uncertainty."><span class="header-section-number">7.2.2.2</span> Rethinking: The benefits of maximizing uncertainty.</h4>
</section>
</section>
<section id="from-entropy-to-accuracy." class="level3" data-number="7.2.3">
<h3 data-number="7.2.3" class="anchored" data-anchor-id="from-entropy-to-accuracy."><span class="header-section-number">7.2.3</span> From entropy to accuracy.</h3>
<section id="overthinking-cross-entropy-and-divergence." class="level4" data-number="7.2.3.1">
<h4 data-number="7.2.3.1" class="anchored" data-anchor-id="overthinking-cross-entropy-and-divergence."><span class="header-section-number">7.2.3.1</span> Overthinking: Cross entropy and divergence.</h4>
</section>
<section id="rethinking-divergence-depends-upon-direction." class="level4" data-number="7.2.3.2">
<h4 data-number="7.2.3.2" class="anchored" data-anchor-id="rethinking-divergence-depends-upon-direction."><span class="header-section-number">7.2.3.2</span> Rethinking: Divergence depends upon direction.</h4>
<p>Here we see <span class="math inline">\(H(p, q) \neq H(q, p)\)</span>. That is, direction matters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">direction =</span> <span class="fu">c</span>(<span class="st">"Earth to Mars"</span>, <span class="st">"Mars to Earth"</span>),</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">p_1       =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.7</span>),</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">q_1       =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.01</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_2 =</span> <span class="dv">1</span> <span class="sc">-</span> p_1,</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">q_2 =</span> <span class="dv">1</span> <span class="sc">-</span> q_1) <span class="sc">|&gt;</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d_kl =</span> (p_1 <span class="sc">*</span> <span class="fu">log</span>(p_1 <span class="sc">/</span> q_1)) <span class="sc">+</span> (p_2 <span class="sc">*</span> <span class="fu">log</span>(p_2 <span class="sc">/</span> q_2)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  direction       p_1   q_1   p_2   q_2  d_kl
  &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Earth to Mars  0.01  0.7   0.99  0.3   1.14
2 Mars to Earth  0.7   0.01  0.3   0.99  2.62</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-Estimating-divergence" class="level3" data-number="7.2.4">
<h3 data-number="7.2.4" class="anchored" data-anchor-id="sec-Estimating-divergence"><span class="header-section-number">7.2.4</span> Estimating divergence.</h3>
<p>We define deviance as</p>
<p><span class="math display">\[D(q) = -2 \sum_i \log (q_i),\]</span></p>
<p>where <span class="math inline">\(i\)</span> indexes each case and <span class="math inline">\(q_i\)</span> is the likelihood for each case. Here’s the deviance from the OLS version of model <code>m7.1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="at">data =</span> d, brain_std <span class="sc">~</span> mass_std) <span class="sc">|&gt;</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logLik</span>() <span class="sc">*</span> <span class="sc">-</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -5.985049 (df=3)</code></pre>
</div>
</div>
<p>In our <span class="math inline">\(D(q)\)</span> formula, did you notice how we ended up multiplying <span class="math inline">\(\sum_i \log (p_i)\)</span> by <span class="math inline">\(-2\)</span>? Frequentists and Bayesians alike make use of information theory, KL divergence, and deviance. It turns out that the differences between two <span class="math inline">\(D(q)\)</span> values follows a <span class="math inline">\(\chi^2\)</span> distribution <span class="citation" data-cites="wilksLargesampleDistributionLikelihood1938">(<a href="references.html#ref-wilksLargesampleDistributionLikelihood1938" role="doc-biblioref">Wilks, 1938</a>)</span>, which frequentists like to reference for the purpose of null-hypothesis significance testing. Some Bayesians, however, are not into all that significance-testing stuff and they aren’t as inclined to multiply <span class="math inline">\(\sum_i \log (p_i)\)</span> by <span class="math inline">\(-2\)</span> for the simple purpose of scaling the associated difference distribution to follow the <span class="math inline">\(\chi^2\)</span>. If we leave that part out of the equation, we end up with</p>
<p><span class="math display">\[S(q) = \sum_i \log (q_i),\]</span></p>
<p>which we can think of as a log-probability score which is “the gold standard way to compare the predictive accuracy of different models. It is an estimate of <span class="math inline">\(\text E \log (q_i)\)</span>, just without the final step of dividing by the number of observations” (p.&nbsp;210).</p>
<p>When Bayesians compute <span class="math inline">\(S(q)\)</span>, they do so over the entire posterior distribution. The <strong>rstan</strong> package does not have a convenience function for computing the log likelihood, and the log likelihood is not computed automatically for <code>stan()</code> models. From the <code>loo.stanfit</code> section of the current version (2.32.6) of the <a href="https://CRAN.R-project.org/package=rstan/rstan.pdf"><strong>rstan</strong> reference manual</a> <span class="citation" data-cites="rstan2024RM">(<a href="references.html#ref-rstan2024RM" role="doc-biblioref">Guo et al., 2024</a>)</span>, we read:</p>
<blockquote class="blockquote">
<p>Stan does not automatically compute and store the log-likelihood. It is up to the user to incorporate it into the Stan program if it is to be extracted after fitting the model. In a Stan program, the pointwise log likelihood can be coded as a vector in the transformed parameters block (and then summed up in the model block) or it can be coded entirely in the generated quantities block. We recommend using the generated quantities block so that the computations are carried out only once per iteration rather than once per HMC leapfrog step.</p>
<p>For example, the following is the <code>generated quantities</code> block for computing and saving the loglikelihood for a linear regression model with <code>N</code> data points, outcome <code>y</code>, predictor matrix <code>X</code> (including column of 1s for intercept), coefficients <code>beta</code>, and standard deviation <code>sigma</code>:</p>
<p><code>vector[N] log_lik;</code> <code>for (n in 1:N) log_lik[n] = normal_lpdf(y[n] | X[n, ] * beta, sigma);</code></p>
</blockquote>
<p>Here’s how to update the <code>model_code</code> for model <code>m7.1</code> to include <code>log_lik</code> within the <code>generated quantities</code> block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.1</span>ll <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; k;</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;  </span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[n, k] X;</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[100, k] Xpred;  // New data for fitted lines</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[k] b;</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real log_sigma;  </span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(X * b, exp(log_sigma));</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b[1] ~ normal(0.5, 1);</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b[2] ~ normal(0, 10);</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a><span class="st">  log_sigma ~ normal(0, 1);</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = normal_lpdf(brain_std[i] | X[i, ] * b, exp(log_sigma));</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compile and fit this version the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>ll <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_7<span class="fl">.1</span>ll,</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice the seven <code>log_lik[i]</code> rows in the <code>print()</code> output, one for each case in the sample data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m7<span class="fl">.1</span>ll, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

            mean se_mean   sd  5.5% 94.5% n_eff Rhat
b[1]        0.53    0.00 0.11  0.36  0.69  2028    1
b[2]        0.17    0.00 0.12 -0.01  0.35  1914    1
log_sigma  -1.40    0.01 0.39 -1.95 -0.72  1259    1
log_lik[1]  0.30    0.01 0.42 -0.43  0.91  1165    1
log_lik[2]  0.32    0.01 0.43 -0.43  0.94  1086    1
log_lik[3]  0.24    0.01 0.45 -0.56  0.86  1245    1
log_lik[4]  0.32    0.01 0.39 -0.37  0.89  1177    1
log_lik[5]  0.16    0.01 0.47 -0.68  0.81  1513    1
log_lik[6]  0.07    0.01 0.60 -1.01  0.82  1580    1
log_lik[7] -0.92    0.02 0.97 -2.87  0.15  2512    1
lp__        5.87    0.05 1.64  2.85  7.59   949    1

Samples were drawn using NUTS(diag_e) at Thu Aug  1 12:53:23 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Because we have computed the <code>log_lik</code> values in the <code>generated quantities</code> block of the model program, we can also use the <code>rstan::loo()</code> function, which searchers for a <code>log_lik</code> parameter vector in the model fit, by the default setting <code>pars = "log_lik"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>l7<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">loo</span>(m7<span class="fl">.1</span>ll, <span class="at">pars =</span> <span class="st">"log_lik"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can convert these <code>log_lik[i]</code> values into log probability scores like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>ll <span class="sc">|&gt;</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(log_lik[i]) <span class="sc">|&gt;</span> </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prob =</span> <span class="fu">exp</span>(log_lik)) <span class="sc">|&gt;</span> </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">log_probability_score =</span> <span class="fu">mean</span>(prob) <span class="sc">|&gt;</span> <span class="fu">log</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
      i log_probability_score
  &lt;int&gt;                 &lt;dbl&gt;
1     1                 0.381
2     2                 0.407
3     3                 0.329
4     4                 0.394
5     5                 0.259
6     6                 0.216
7     7                -0.603</code></pre>
</div>
</div>
<p>“If you sum these values, you’ll have the total log-probability score for the model and data” (p.&nbsp;210). Here we sum those <span class="math inline">\(\log (q_i)\)</span> values up to compute <span class="math inline">\(S(q)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>ll <span class="sc">|&gt;</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(log_lik[i]) <span class="sc">|&gt;</span> </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prob =</span> <span class="fu">exp</span>(log_lik)) <span class="sc">|&gt;</span> </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">log_probability_score =</span> <span class="fu">mean</span>(prob) <span class="sc">|&gt;</span> <span class="fu">log</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is the only new step from the last code block</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_log_probability_score =</span> <span class="fu">sum</span>(log_probability_score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  total_log_probability_score
                        &lt;dbl&gt;
1                        1.38</code></pre>
</div>
</div>
<section id="overthinking-computing-the-lppd." class="level4" data-number="7.2.4.1">
<h4 data-number="7.2.4.1" class="anchored" data-anchor-id="overthinking-computing-the-lppd."><span class="header-section-number">7.2.4.1</span> Overthinking: Computing the lppd.</h4>
<p>The Bayesian version of the log-probability score, what we’ve been calling the lppd, has to account for the data and the posterior distribution. It follows the form</p>
<p><span class="math display">\[\text{lppd}(y, \Theta) = \sum_i \log \frac{1}{S} \sum_s p (y_i | \Theta_s),\]</span></p>
<blockquote class="blockquote">
<p>where <span class="math inline">\(S\)</span> is the number of samples and <span class="math inline">\(\Theta_s\)</span> is the <span class="math inline">\(s\)</span>-th set of sampled parameter values in the posterior distribution. While in principle this is easy–you just need to compute the probability (density) of each observation <span class="math inline">\(i\)</span> for each sample <span class="math inline">\(s\)</span>, take the average, and then the logarithm–in practice it is not so easy. The reason is that doing arithmetic in a computer often requires some tricks to retain precision. (p.&nbsp;210)</p>
</blockquote>
<p>Though we computed these values above with the <code>log_lik[i]</code> values defined in the <code>generated quantities</code> block of the <code>model_code</code>, we can also do it by hand with the posterior distribution and the sample data. When we pull the posterior draws with <code>as_draws_df()</code>, the HMC draws, what McElreath called <span class="math inline">\(s\)</span>, are indexed in the <code>.draw</code> column. We’ll rename that column <code>s</code>. The term <span class="math inline">\(p (y_i | \Theta_s)\)</span> is the probability of the <code>brain_std</code> values for each of the rows of the data, which we’ve indexed by the <code>i</code> column, given the samples form the posterior distribution <span class="math inline">\(\Theta_s\)</span>. Those <span class="math inline">\(\Theta_s\)</span> values are our <code>b[1]</code>, <code>b[2]</code> and <code>log_sigma</code> columns, seen through the lens of the Gaussian likelihood. Thus we compute <span class="math inline">\(p (y_i | \Theta_s)\)</span> within the <code>dnorm()</code> function, which we save as <code>density[i][s]</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>log_prob_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m7<span class="fl">.1</span>ll) <span class="sc">|&gt;</span> </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Index the samples using McElreath's notation</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">s =</span> .draw) <span class="sc">|&gt;</span> </span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the sample data</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(d <span class="sc">|&gt;</span> </span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(i, species<span class="sc">:</span>brain_std)) <span class="sc">|&gt;</span> </span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Not needed, but simplifies the output</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(s, i, species, brain_std, mass_std, <span class="st">`</span><span class="at">b[1]</span><span class="st">`</span>, <span class="st">`</span><span class="at">b[2]</span><span class="st">`</span>, log_sigma) <span class="sc">|&gt;</span> </span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define p(y[i] | Theta[s])</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">density[i][s]</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dnorm</span>(<span class="at">x =</span> brain_std, </span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">mean =</span> <span class="st">`</span><span class="at">b[1]</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">b[2]</span><span class="st">`</span> <span class="sc">*</span> mass_std,</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sd =</span> <span class="fu">exp</span>(log_sigma)))</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(log_prob_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 28,000
Columns: 9
$ s               &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, …
$ i               &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, …
$ species         &lt;chr&gt; "afarensis", "africanus", "habilis", "boisei", "rudolf…
$ brain_std       &lt;dbl&gt; 0.3244444, 0.3348148, 0.4533333, 0.3859259, 0.5570370,…
$ mass_std        &lt;dbl&gt; -0.7794667, -0.9170196, -1.0087216, -0.3668079, 0.9170…
$ `b[1]`          &lt;dbl&gt; 0.5111734, 0.5111734, 0.5111734, 0.5111734, 0.5111734,…
$ `b[2]`          &lt;dbl&gt; 0.6746181, 0.6746181, 0.6746181, 0.6746181, 0.6746181,…
$ log_sigma       &lt;dbl&gt; -0.4891425, -0.4891425, -0.4891425, -0.4891425, -0.489…
$ `density[i][s]` &lt;dbl&gt; 0.5583681, 0.5016021, 0.3885140, 0.6378460, 0.4205836,…</code></pre>
</div>
</div>
<p>By <span class="math inline">\(\frac{1}{S} \sum_s p (y_i | \Theta_s)\)</span>, we are computing the average density value separately for each row in the sample data, <code>i</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>log_prob_df <span class="sc">|&gt;</span> </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="st">`</span><span class="at">mean_density[i]</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(<span class="st">`</span><span class="at">density[i][s]</span><span class="st">`</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
      i `mean_density[i]`
  &lt;int&gt;             &lt;dbl&gt;
1     1             1.46 
2     2             1.50 
3     3             1.39 
4     4             1.48 
5     5             1.30 
6     6             1.24 
7     7             0.547</code></pre>
</div>
</div>
<p>Then by the rightmost terms in the equation, <span class="math inline">\(\sum_i \log \cdot\)</span>, we take the log of those values and sum them up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>log_prob_df <span class="sc">|&gt;</span> </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="st">`</span><span class="at">mean_density[i]</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(<span class="st">`</span><span class="at">density[i][s]</span><span class="st">`</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_log_probability_score =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">mean_density[i]</span><span class="st">`</span>) <span class="sc">|&gt;</span> <span class="fu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  total_log_probability_score
                        &lt;dbl&gt;
1                        1.38</code></pre>
</div>
</div>
<p>That is the log-pointwise-predictive-density, <span class="math inline">\(\text{lppd}(y, \Theta)\)</span>, computed by hand.</p>
</section>
</section>
<section id="scoring-the-right-data." class="level3" data-number="7.2.5">
<h3 data-number="7.2.5" class="anchored" data-anchor-id="scoring-the-right-data."><span class="header-section-number">7.2.5</span> Scoring the right data.</h3>
<p>Since our <code>stan()</code> models from above do not have log-likelihood values saved from each, we have to options to make an alternative to McElreath’s R code 7.15:</p>
<ul>
<li>we can compute each by hand, like in the last section, but with a custom-defined linear function within <code>dnorm()</code>, or</li>
<li>we can refit the models after adding <code>log_lik[i]</code> definitions in the <code>generated quantities</code> block of the model program.</li>
</ul>
<p>I’m opting for the latter. To that end, define the <code>model_code_7.1to6ll</code> object with a <code>generated quantities</code> block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.1</span>to6ll <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; k;</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] brain_std;  </span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[n, k] X;</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[100, k] Xpred;</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[k] b;</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real log_sigma;</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="st">  brain_std ~ normal(X * b, exp(log_sigma));</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b[1] ~ normal(0.5, 1);</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="st">  b[2:k] ~ normal(0, 10);</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="st">  log_sigma ~ normal(0, 1);</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="st">  // Define and compute the log likelihood</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = normal_lpdf(brain_std[i] | X[i, ] * b, exp(log_sigma));</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compile and save the <code>stan_dso_ll</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>stan_dso_ll <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> model_code_7<span class="fl">.1</span>to6ll)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now draw from the posterior distributions of all 6 models by using the <code>sampling()</code> function within <code>map()</code>, and then extract the <code>log_lik</code> estimates from each model with <code>spread_draws()</code> within <code>map()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>d_fits_ll <span class="ot">&lt;-</span> d_fits <span class="sc">|&gt;</span> </span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset the data frame</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, stan_data) <span class="sc">|&gt;</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample from each model</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sampling =</span> <span class="fu">map</span>(<span class="at">.x =</span> stan_data, </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span><span class="sc">~</span> <span class="fu">sampling</span>(</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">object =</span> stan_dso_ll, </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> .x,</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="dv">7</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the posterior draws for the `log_lik` estimates </span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spread_draws =</span> <span class="fu">map</span>(<span class="at">.x =</span> sampling, </span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">.f =</span><span class="sc">~</span> <span class="fu">spread_draws</span>(</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">model =</span> .x,</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>                              log_lik[i])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compute the <code>total_log_probability_score</code> for each model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>d_fits_ll <span class="sc">|&gt;</span> </span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(model, spread_draws) <span class="sc">|&gt;</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(spread_draws) <span class="sc">|&gt;</span> </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">s =</span> .draw) <span class="sc">|&gt;</span> </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">density[i][s]</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">exp</span>(log_lik)) <span class="sc">|&gt;</span> </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, i) <span class="sc">|&gt;</span> </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="st">`</span><span class="at">mean_density[i]</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(<span class="st">`</span><span class="at">density[i][s]</span><span class="st">`</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model) <span class="sc">|&gt;</span> </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_log_probability_score =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">mean_density[i]</span><span class="st">`</span>) <span class="sc">|&gt;</span> <span class="fu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'model'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  model total_log_probability_score
  &lt;chr&gt;                       &lt;dbl&gt;
1 m7.1                       1.38  
2 m7.2                       0.712 
3 m7.3                       0.640 
4 m7.4                       0.273 
5 m7.5                       0.0968
6 m7.6                      -2.16  </code></pre>
</div>
</div>
<section id="overthinking-simulated-training-and-testing." class="level4" data-number="7.2.5.1">
<h4 data-number="7.2.5.1" class="anchored" data-anchor-id="overthinking-simulated-training-and-testing."><span class="header-section-number">7.2.5.1</span> Overthinking: Simulated training and testing.</h4>
<p>I’m leaving this out, for now. If you want a sense of how to do this, check out this section in my <strong>brms</strong> translation (<a href="https://bookdown.org/content/4857/ulysses-compass.html#overthinking-simulated-training-and-testing.">here</a>).</p>
</section>
</section>
</section>
<section id="golem-taming-regularization" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="golem-taming-regularization"><span class="header-section-number">7.3</span> Golem taming: regularization</h2>
<p>I’ll leave the simulation for Figure 7.8 for another day. If you want a sense of how to do this, check out this section in my <strong>brms</strong> translation (<a href="https://bookdown.org/content/4857/ulysses-compass.html#golem-taming-regularization">here</a>).</p>
<section id="rethinking-ridge-regression." class="level4" data-number="7.3.0.1">
<h4 data-number="7.3.0.1" class="anchored" data-anchor-id="rethinking-ridge-regression."><span class="header-section-number">7.3.0.1</span> Rethinking: Ridge regression.</h4>
</section>
</section>
<section id="predicting-predictive-accuracy" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="predicting-predictive-accuracy"><span class="header-section-number">7.4</span> Predicting predictive accuracy</h2>
<section id="cross-validation." class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="cross-validation."><span class="header-section-number">7.4.1</span> Cross-validation.</h3>
<section id="overthinking-pareto-smoothed-cross-validation." class="level4" data-number="7.4.1.1">
<h4 data-number="7.4.1.1" class="anchored" data-anchor-id="overthinking-pareto-smoothed-cross-validation."><span class="header-section-number">7.4.1.1</span> Overthinking: Pareto-smoothed cross-validation.</h4>
</section>
</section>
<section id="information-criteria." class="level3" data-number="7.4.2">
<h3 data-number="7.4.2" class="anchored" data-anchor-id="information-criteria."><span class="header-section-number">7.4.2</span> Information criteria.</h3>
<p>We define the widely applicable information criterion (WAIC) as</p>
<p><span class="math display">\[\text{WAIC}(y, \Theta) = -2 \big ( \text{lppd} - {\color{blue}{\sum_i \operatorname{var}_\theta \log p (y_i \mid \theta)}} \big),\]</span></p>
<p>where <span class="math inline">\(y\)</span> is the criterion, <span class="math inline">\(\Theta\)</span> is the posterior distribution, and the terms in the blue font make up the complexity penalty.</p>
<section id="overthinking-the-akaike-inspiration-criterion." class="level4" data-number="7.4.2.1">
<h4 data-number="7.4.2.1" class="anchored" data-anchor-id="overthinking-the-akaike-inspiration-criterion."><span class="header-section-number">7.4.2.1</span> Overthinking: The Akaike inspiration criterion.</h4>
</section>
<section id="rethinking-information-criteria-and-consistency." class="level4" data-number="7.4.2.2">
<h4 data-number="7.4.2.2" class="anchored" data-anchor-id="rethinking-information-criteria-and-consistency."><span class="header-section-number">7.4.2.2</span> Rethinking: Information criteria and consistency.</h4>
</section>
<section id="rethinking-what-about-bic-and-bayes-factors" class="level4" data-number="7.4.2.3">
<h4 data-number="7.4.2.3" class="anchored" data-anchor-id="rethinking-what-about-bic-and-bayes-factors"><span class="header-section-number">7.4.2.3</span> Rethinking: What about BIC and Bayes factors?</h4>
</section>
<section id="overthinking-waic-calculations." class="level4" data-number="7.4.2.4">
<h4 data-number="7.4.2.4" class="anchored" data-anchor-id="overthinking-waic-calculations."><span class="header-section-number">7.4.2.4</span> Overthinking: WAIC calculations.</h4>
<p>Here is how to fit the pre-WAIC model with <strong>brms</strong>.</p>
<p>Define the <code>stan_data</code> version of the <code>cars</code> data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> cars <span class="sc">|&gt;</span> </span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ speed: num [1:50(1d)] 4 4 7 7 8 9 10 10 10 11 ...
 $ dist : num [1:50(1d)] 2 10 4 22 16 10 18 26 34 17 ...
 $ n    : int 50</code></pre>
</div>
</div>
<p>Define <code>model_code_7.7</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>model_code_7<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] speed;</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] dist;</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real b0;</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real b1;</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;  </span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="st">  dist ~ normal(b0 + b1 * speed, sigma);</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="st">  b0 ~ normal(0, 100);</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a><span class="st">  b1 ~ normal(0, 10);</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ exponential(1);</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a><span class="st">  // Define and compute the log likelihood</span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = normal_lpdf(dist[i] | b0 + b1 * speed[i], sigma);</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit <code>m7.7</code> with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_7<span class="fl">.7</span>,</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m7<span class="fl">.7</span>, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b0"</span>, <span class="st">"b1"</span>, <span class="st">"sigma"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

        mean se_mean   sd   5.5% 94.5% n_eff Rhat
b0    -17.50    0.17 6.09 -27.29 -7.73  1324    1
b1      3.93    0.01 0.37   3.33  4.53  1316    1
sigma  13.82    0.03 1.22  12.03 15.89  1842    1

Samples were drawn using NUTS(diag_e) at Fri Aug  2 13:06:15 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>For the sake of practice, here’s the fitted line plotted against the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># range(cars$speed)  # 4 25</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m7<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">speed =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">25</span>) <span class="sc">|&gt;</span> </span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dist =</span> b0 <span class="sc">+</span> b1 <span class="sc">*</span> speed) <span class="sc">|&gt;</span> </span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> speed, <span class="at">y =</span> dist)) <span class="sc">+</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">.width =</span> <span class="fl">0.89</span>, <span class="at">fill =</span> <span class="st">"gray67"</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> cars,</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">color =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid" width="432"></p>
</div>
</div>
<p>As the the log likelihood and the WAIC, because of our <code>generated quantities</code> block, our <code>m7.7</code> object has a vector of <code>log_lik</code> values for each case in the data. We’ll make explicit use of those in a moment. But since this is such a simple model, we’ll first practice by hand. Here we extract the posterior draws just for the model parameters <code>b0</code>, <code>b1</code> and <code>sigma</code> from <code>m7.7</code>, use <code>expand_grid()</code> to add in the <code>cars</code> data, compute the <code>log_lik</code> values with <code>dnorm(log = TRUE)</code>, exponentiate those values back to the <code>likelihood</code> metric with <code>exp()</code>, and save the results as a data frame called <code>d_log_lik</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>d_log_lik <span class="ot">&lt;-</span> m7<span class="fl">.7</span> <span class="sc">|&gt;</span> </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(b0, b1, sigma) <span class="sc">|&gt;</span> </span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(cars <span class="sc">|&gt;</span> </span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(i, <span class="fu">everything</span>())) <span class="sc">|&gt;</span> </span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># In R code 7.20, McElreath called this `logprob`</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_lik =</span> <span class="fu">dnorm</span>(<span class="at">x =</span> dist, </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean =</span>  b0 <span class="sc">+</span> b1 <span class="sc">*</span> speed, </span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sd =</span> sigma, </span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lik =</span> <span class="fu">exp</span>(log_lik))</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d_log_lik)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 200,000
Columns: 11
$ .chain     &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ .iteration &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ .draw      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ b0         &lt;dbl&gt; -11.39182, -11.39182, -11.39182, -11.39182, -11.39182, -11.…
$ b1         &lt;dbl&gt; 3.672345, 3.672345, 3.672345, 3.672345, 3.672345, 3.672345,…
$ sigma      &lt;dbl&gt; 14.86227, 14.86227, 14.86227, 14.86227, 14.86227, 14.86227,…
$ i          &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …
$ speed      &lt;dbl&gt; 4, 4, 7, 7, 8, 9, 10, 10, 10, 11, 11, 12, 12, 12, 12, 13, 1…
$ dist       &lt;dbl&gt; 2, 10, 4, 22, 16, 10, 18, 26, 34, 17, 28, 14, 20, 24, 28, 2…
$ log_lik    &lt;dbl&gt; -3.621575, -3.719451, -3.858590, -3.751465, -3.626701, -3.9…
$ lik        &lt;dbl&gt; 0.0267405229, 0.0242472711, 0.0210977186, 0.0234833221, 0.0…</code></pre>
</div>
</div>
<p>Recall the formula for the <span class="math inline">\(\text{lppd}\)</span> was</p>
<p><span class="math display">\[\text{lppd}(y, \Theta) = \sum_i \log \frac{1}{S} \sum_s p (y_i | \Theta_s),\]</span></p>
<p>where <span class="math inline">\(p (y_i | \Theta_s)\)</span> is the likelihood of case <span class="math inline">\(i\)</span> on posterior draw <span class="math inline">\(s\)</span>. For each case <span class="math inline">\(i\)</span> (i.e., <span class="math inline">\(\sum_i\)</span>), we then take the average likelihood value [i.e., <span class="math inline">\(\frac{1}{S} \sum_s p (y_i | \Theta_s)\)</span>] and transform the result by taking its log [i.e., <span class="math inline">\(\log \left (\frac{1}{S} \sum_s p (y_i | \Theta_s) \right )\)</span>]. When we sum those values up, we have the <span class="math inline">\(\text{lppd}\)</span>, which we’ll save as a scalar named <code>lppd</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>lppd <span class="ot">&lt;-</span> d_log_lik <span class="sc">|&gt;</span> </span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">log_mean_likelihood =</span> <span class="fu">mean</span>(lik) <span class="sc">|&gt;</span> <span class="fu">log</span>()) <span class="sc">|&gt;</span>  </span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lppd =</span> <span class="fu">sum</span>(log_mean_likelihood)) <span class="sc">|&gt;</span> </span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(lppd)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lppd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -206.6241</code></pre>
</div>
</div>
<p>It’s a little easier to compute the effective number of parameters, <span class="math inline">\(p_\text{WAIC}\)</span>. First, let’s use a shorthand notation and define <span class="math inline">\(V(y_i)\)</span> as the variance in log-likelihood for the <span class="math inline">\(i^\text{th}\)</span> case across all <span class="math inline">\(S\)</span> samples. We define <span class="math inline">\(p_\text{WAIC}\)</span> as their sum</p>
<p><span class="math display">\[p_\text{WAIC} = \sum_{i=1}^N V (y_i).\]</span></p>
<p>We’ll name the pointwise results [i.e., <span class="math inline">\(V (y_i)\)</span>] as <code>var_log_lik</code>, and we’ll save their sum [i.e., <span class="math inline">\(\sum_{i=1}^N V (y_i)\)</span>] as a scalar named <code>pwaic</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>pwaic <span class="ot">&lt;-</span> d_log_lik <span class="sc">|&gt;</span> </span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">var_log_lik =</span> <span class="fu">var</span>(log_lik)) <span class="sc">|&gt;</span> </span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">pwaic =</span> <span class="fu">sum</span>(var_log_lik)) <span class="sc">|&gt;</span> </span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(pwaic)</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pwaic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.086416</code></pre>
</div>
</div>
<p>Now we can finally plug our hand-made <code>lppd</code> and <code>pwaic</code> values into the formula <span class="math inline">\(-2 (\text{lppd} - p_\text{WAIC})\)</span> to compute the WAIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WAIC</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (lppd <span class="sc">-</span> pwaic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 421.4209</code></pre>
</div>
</div>
<p>Now we’re finally ready to use those <code>log_lik</code> vectors from our <code>generated quantities</code> block. The <strong>loo</strong> package has a <code>extract_log_lik()</code> function that expects a vector named <code>log_lik</code>. This will convert them to a matrix with as many rows as posterior draws, and as many columns as cases in the sample data. In our case, That will make for a <span class="math inline">\(4{,}000 \times 50\)</span> matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extract_log_lik</span>(m7<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:4000, 1:50] -3.62 -3.49 -3.66 -3.83 -3.65 ...</code></pre>
</div>
</div>
<p>We can then pump this log-likelihood matrix directly into the <code>loo::waic()</code> function, the results of which we’ll save as <code>w7.7</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>w7<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(m7<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">waic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can get a nice summary with <code>print()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(w7<span class="fl">.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 50 log-likelihood matrix.

          Estimate   SE
elpd_waic   -210.7  8.2
p_waic         4.1  1.6
waic         421.4 16.4

2 (4.0%) p_waic estimates greater than 0.4. We recommend trying loo instead. </code></pre>
</div>
</div>
<p>Lo and behold, the value in the <code>Estimate</code> column of the <code>waic</code> row matches the <code>waic</code> scalar we hand-computed just a few code blocks above.</p>
<p>Before we move on, did you notice the <code>elpd_waic</code> row? That value is the <code>lppd</code> minus the <code>pwaic</code>, but without multiplying the result by -2. Here’s how that matches up with our hand-computed scalars.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>(lppd <span class="sc">-</span> pwaic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -210.7105</code></pre>
</div>
</div>
<p>Recalling some of the intermediary steps from above, here’s how we might compute the WAIC standard error by hand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>n_cases <span class="ot">&lt;-</span> <span class="fu">nrow</span>(cars)  <span class="co"># 50</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>d_log_lik <span class="sc">|&gt;</span> </span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">log_mean_likelihood =</span> <span class="fu">mean</span>(lik) <span class="sc">|&gt;</span> <span class="fu">log</span>(),</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">var_log_lik =</span> <span class="fu">var</span>(log_lik)) <span class="sc">|&gt;</span> </span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the pointwise waic values</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pointwise_waic =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (log_mean_likelihood <span class="sc">-</span> var_log_lik)) <span class="sc">|&gt;</span> </span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">waic_se =</span> <span class="fu">sqrt</span>(n_cases <span class="sc">*</span> <span class="fu">var</span>(pointwise_waic)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  waic_se
    &lt;dbl&gt;
1    16.4</code></pre>
</div>
</div>
<p>If you’d like the pointwise WAIC values from <code>waic()</code> output, just index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>w7<span class="fl">.7</span><span class="sc">$</span>pointwise <span class="sc">|&gt;</span> </span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     elpd_waic     p_waic     waic
[1,] -3.648848 0.02209327 7.297696
[2,] -4.022936 0.09582308 8.045871
[3,] -3.684862 0.02091625 7.369725
[4,] -3.994271 0.06003729 7.988543
[5,] -3.587983 0.01035827 7.175966
[6,] -3.742794 0.02106961 7.485588</code></pre>
</div>
</div>
</section>
</section>
<section id="comparing-cv-psis-and-waic." class="level3" data-number="7.4.3">
<h3 data-number="7.4.3" class="anchored" data-anchor-id="comparing-cv-psis-and-waic."><span class="header-section-number">7.4.3</span> Comparing CV, PSIS, and WAIC.</h3>
<p>I’ll leave the simulation for Figure 7.9 for another day.</p>
<p>However, when it comes to the LOO-CV for <code>stan()</code> models, we can use the convenience function <code>loo::loo()</code> in much the same we used the <code>waic()</code>. Here’s what that looks like for <code>m7.7</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extract_log_lik</span>(m7<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 50 log-likelihood matrix.

         Estimate   SE
elpd_loo   -210.8  8.3
p_loo         4.2  1.6
looic       421.6 16.5
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>As long as you compute the <code>log_lik</code> values in the <code>generated quantities</code> block for input to <code>stan()</code>, the workflow is smooth. However, if you’re ever in a situation where you haven’t done that, you can do this all by hand. For example, this is how you can get the <code>loo()</code> summary for hand-computed <code>log_lik</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.7</span> <span class="sc">|&gt;</span> </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(b0, b1, sigma) <span class="sc">|&gt;</span> </span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(cars <span class="sc">|&gt;</span> </span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(i, <span class="fu">everything</span>())) <span class="sc">|&gt;</span> </span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_lik =</span> <span class="fu">dnorm</span>(<span class="at">x =</span> dist, </span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean =</span>  b0 <span class="sc">+</span> b1 <span class="sc">*</span> speed, </span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sd =</span> sigma, </span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Everything up to this point is a repeat from earlier</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw, i, log_lik) <span class="sc">|&gt;</span> </span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> i, <span class="at">values_from =</span> log_lik) <span class="sc">|&gt;</span> </span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.draw) <span class="sc">|&gt;</span> </span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span> </span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 50 log-likelihood matrix.

         Estimate   SE
elpd_loo   -210.8  8.3
p_loo         4.2  1.6
looic       421.6 16.5
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>Hopefully you’ll never have to do that, though.</p>
<section id="rethinking-diverse-prediction-frameworks." class="level4" data-number="7.4.3.1">
<h4 data-number="7.4.3.1" class="anchored" data-anchor-id="rethinking-diverse-prediction-frameworks."><span class="header-section-number">7.4.3.1</span> Rethinking: Diverse prediction frameworks.</h4>
</section>
</section>
</section>
<section id="model-comparison" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="model-comparison"><span class="header-section-number">7.5</span> Model comparison</h2>
<section id="sec-Model-mis-selection" class="level3" data-number="7.5.1">
<h3 data-number="7.5.1" class="anchored" data-anchor-id="sec-Model-mis-selection"><span class="header-section-number">7.5.1</span> Model mis-selection.</h3>
<p>Once again we return to the plant growth models from back in <a href="06.html#sec-Post-treatment-bias"><span>Section&nbsp;6.2</span></a>, models <code>m6.6</code>, <code>m6.7</code>, and <code>m6.8</code>. If you were following along closely, you may have notices we defined the <code>log_lik</code> values in the <code>generated quantities</code> block for each, but put off their discussion until now. Here we’ll use out <code>extract_log_lik |&gt; waic()</code> workflow to compute the WAIC summaries for each, and save them as objects named <code>w6.6</code> through <code>w6.8</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>w6<span class="fl">.6</span> <span class="ot">&lt;-</span> m6<span class="fl">.6</span> <span class="sc">|&gt;</span> </span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">waic</span>()</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>w6<span class="fl">.7</span> <span class="ot">&lt;-</span> m6<span class="fl">.7</span> <span class="sc">|&gt;</span> </span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">waic</span>()</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>w6<span class="fl">.8</span> <span class="ot">&lt;-</span> m6<span class="fl">.8</span> <span class="sc">|&gt;</span> </span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">waic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Like in the text (p.&nbsp;226), here’s the <code>waic()</code> output for <code>m6.7</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(w6<span class="fl">.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 100 log-likelihood matrix.

          Estimate   SE
elpd_waic   -180.6  6.7
p_waic         3.4  0.5
waic         361.3 13.4</code></pre>
</div>
</div>
<p>For our <strong>rstan</strong> + <strong>loo</strong> based workflow, we can compare multiple models by their WAIC with the <code>loo_compare()</code> function. The name of the function implies you should be using the LOO-CV, rather than the WAIC. Given the preferences of the package’s authors, that’s no surprise (e.g., see the opening paragraph <a href="https://mc-stan.org/loo/reference/waic.html">here</a>). But yes, you can also use <code>loo_compare()</code> function to compare models by their WAIC estimates. Here we save the output as an object called <code>w_difference</code>, and then display a summary of the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>w_difference <span class="ot">&lt;-</span> <span class="fu">loo_compare</span>(w6<span class="fl">.6</span>, w6<span class="fl">.7</span>, w6<span class="fl">.8</span>)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>w_difference <span class="sc">|&gt;</span> </span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
model2    0.0       0.0  -180.6       6.7          3.4    0.5     361.3   13.4 
model3  -20.6       4.9  -201.2       5.4          2.5    0.3     402.5   10.7 
model1  -22.4       5.8  -203.1       5.7          1.6    0.2     406.1   11.4 </code></pre>
</div>
</div>
<p>Though the format is a little different, out output largely matches what McElreath displayed on page 227 of the text. With respect to our <code>loo_compare()</code> output, notice the <code>elpd_diff</code> column and the adjacent <code>se_diff</code> column. Those are our WAIC differences in the elpd metric. The models have been rank ordered from the highest (i.e., <code>m6.7</code>, called <code>model2</code>) to the lowest (i.e., <code>m6.6</code>, called <code>model1</code>). The scores listed are the differences of <code>m6.7</code> minus the comparison model. Since <code>m6.7</code> is the comparison model in the top row, the values are naturally 0 (i.e., <span class="math inline">\(x - x = 0\)</span>). But now here’s another critical thing to understand: WAIC and LOO differences are no longer reported in the <span class="math inline">\(-2 \times x\)</span> metric. Remember how multiplying <code>(lppd - pwaic)</code> by -2 is a historic artifact associated with the frequentist <span class="math inline">\(\chi^2\)</span> test? We’ll, the makers of the <strong>loo</strong> package aren’t fans, and they no longer support the conversion.</p>
<p>So here’s the deal: The substantive interpretations of the differences presented in an <code>elpd_diff</code> metric will be the same as if presented in a WAIC metric. But if we want to compare our <code>elpd_diff</code> results to those in the text, we will have to multiply them by -2. And also, if we want the associated standard error in the same metric, we’ll need to multiply the <code>se_diff</code> column by 2. You wouldn’t multiply by -2 because that would return a negative standard error, which would be silly. Here’s a quick way to do those conversions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">waic_diff =</span> w_difference[, <span class="dv">1</span>] <span class="sc">*</span> <span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">se        =</span> w_difference[, <span class="dv">2</span>] <span class="sc">*</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       waic_diff        se
model2   0.00000  0.000000
model3  41.21758  9.787452
model1  44.83923 11.568710</code></pre>
</div>
</div>
<p>Now those match up reasonably well with the values in McElreath’s <code>dWAIC</code> and <code>dSE</code> columns.</p>
<p>Anyway, here’s how to compute the standard error for the WAIC difference for <code>m6.7</code> and <code>m6.8</code>, by hand, like McElreath did in the top of page 228.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">m6.7 =</span> w6<span class="fl">.7</span><span class="sc">$</span>pointwise[, <span class="st">"waic"</span>],</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">m6.8 =</span> w6<span class="fl">.8</span><span class="sc">$</span>pointwise[, <span class="st">"waic"</span>]) <span class="sc">|&gt;</span> </span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff_m6.7_m6.8 =</span> m6<span class="fl">.7</span> <span class="sc">-</span> m6<span class="fl">.8</span>) <span class="sc">|&gt;</span> </span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">se =</span> <span class="fu">sqrt</span>(<span class="fu">n</span>() <span class="sc">*</span> <span class="fu">var</span>(diff_m6<span class="fl">.7</span>_m6<span class="fl">.8</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
     se
  &lt;dbl&gt;
1  9.79</code></pre>
</div>
</div>
<p>For us, the 99% interval for the difference distribution would be about so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fl">41.2</span> <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">9.8</span> <span class="sc">*</span> <span class="fl">2.6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15.72 66.68</code></pre>
</div>
</div>
<p>Here’s our version of a WAIC coefficient plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(w6<span class="fl">.6</span><span class="sc">$</span>estimates[<span class="st">"waic"</span>, ],</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>          w6<span class="fl">.7</span><span class="sc">$</span>estimates[<span class="st">"waic"</span>, ],</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>          w6<span class="fl">.8</span><span class="sc">$</span>estimates[<span class="st">"waic"</span>, ]) <span class="sc">|&gt;</span> </span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">str_c</span>(<span class="st">"m6."</span>, <span class="dv">6</span><span class="sc">:</span><span class="dv">8</span>) <span class="sc">|&gt;</span> </span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">fct_reorder</span>(Estimate, <span class="at">.desc =</span> <span class="cn">TRUE</span>),</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower =</span> Estimate <span class="sc">-</span> SE,</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper =</span> Estimate <span class="sc">+</span> SE) <span class="sc">|&gt;</span> </span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Estimate, <span class="at">xmin =</span> lower, <span class="at">xmax =</span> upper, <span class="at">y =</span> model)) <span class="sc">+</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"WAIC"</span>,</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-101-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>We don’t get the deviance points with this method, but that’s okay. Our primary focus is on the WAIC and its standard errors. IMO, the deviance points are mainly of pedagogical interest.</p>
<p>As far as WAIC weights go, I’m not aware there is a quick and convenient way to compute WAIC weights for an <strong>rstan</strong> model. But if we look to the vignette <a href="https://mc-stan.org/loo/articles/loo2-weights.html">here</a>, we can compute them by hand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>w_difference <span class="sc">|&gt;</span> </span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">exp</span>(elpd_waic) <span class="sc">/</span> <span class="fu">sum</span>(<span class="fu">exp</span>(elpd_waic))) <span class="sc">|&gt;</span> </span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(waic, weight) <span class="sc">|&gt;</span> </span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Just to make the output nicer</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         waic weight
model2 361.28      1
model3 402.50      0
model1 406.12      0</code></pre>
</div>
</div>
<p>Before we move on, I should point out you can do all of this for the <code>loo()</code>, as well. For example, here’s a quick way to get the <code>loo_compare()</code> summary for the LOO estimates from our three models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m6<span class="fl">.6</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m6<span class="fl">.7</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m6<span class="fl">.8</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>()</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
model2    0.0       0.0  -180.7      6.7         3.4    0.5    361.3   13.4  
model3  -20.6       4.9  -201.3      5.4         2.5    0.3    402.5   10.7  
model1  -22.4       5.8  -203.1      5.7         1.7    0.2    406.1   11.4  </code></pre>
</div>
</div>
<p>Speaking of the LOO, the <strong>loo</strong> package, does support other kinds of model weights. With the <code>loo_model_weights()</code> function, we can compute stacking weights, or pseudo-Bayesian model averaging (BMA) weights. The <code>loo_model_weights()</code> function takes input in the form of a list of <code>psis_loo</code> objects (i.e., <code>loo()</code> output). Here’s what that can look like for both stackind and pseudo-BMA weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stacking</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_model_weights</span>(</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="fu">extract_log_lik</span>(m6<span class="fl">.6</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">extract_log_lik</span>(m6<span class="fl">.7</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">extract_log_lik</span>(m6<span class="fl">.8</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>()),</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"stacking"</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Method: stacking
------
       weight
model1 0.000 
model2 1.000 
model3 0.000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pseudobma</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_model_weights</span>(</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="fu">extract_log_lik</span>(m6<span class="fl">.6</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">extract_log_lik</span>(m6<span class="fl">.7</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">extract_log_lik</span>(m6<span class="fl">.8</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>()),</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"pseudobma"</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Method: pseudo-BMA+ with Bayesian bootstrap
------
       weight
model1 0.000 
model2 1.000 
model3 0.000 </code></pre>
</div>
</div>
<p>For more on these types of weighting methods, see <span class="citation" data-cites="yaoUsingStackingAverage2018">Yao et al. (<a href="references.html#ref-yaoUsingStackingAverage2018" role="doc-biblioref">2018</a>)</span>.</p>
<section id="rethinking-waic-metaphors." class="level4" data-number="7.5.1.1">
<h4 data-number="7.5.1.1" class="anchored" data-anchor-id="rethinking-waic-metaphors."><span class="header-section-number">7.5.1.1</span> Rethinking: WAIC metaphors.</h4>
</section>
</section>
<section id="sec-Outliers-and-other-illusions" class="level3" data-number="7.5.2">
<h3 data-number="7.5.2" class="anchored" data-anchor-id="sec-Outliers-and-other-illusions"><span class="header-section-number">7.5.2</span> Outliers and other illusions.</h3>
<p>Time to bring back the <code>WaffleDivorce</code> data, and reconsider the models from back in <a href="05.html#sec-Spurious-associations"><span>Section&nbsp;5.1</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(WaffleDivorce, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> WaffleDivorce <span class="sc">|&gt;</span> </span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d =</span> rethinking<span class="sc">::</span><span class="fu">standardize</span>(Divorce),</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">m =</span> rethinking<span class="sc">::</span><span class="fu">standardize</span>(Marriage),</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">a =</span> rethinking<span class="sc">::</span><span class="fu">standardize</span>(MedianAgeMarriage))</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(WaffleDivorce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each of the models <code>m5.1</code> through <code>m5.3</code>, we computed the <code>log_lik</code> using the <code>generated quantities</code> block method. Here we compute and save their <code>loo()</code> output as objects named <code>l5.1</code> through <code>l5.3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>l5<span class="fl">.1</span> <span class="ot">&lt;-</span> m5<span class="fl">.1</span> <span class="sc">|&gt;</span> </span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loo</span>()</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>l5<span class="fl">.2</span> <span class="ot">&lt;-</span> m5<span class="fl">.2</span> <span class="sc">|&gt;</span> </span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loo</span>()</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>l5<span class="fl">.3</span> <span class="ot">&lt;-</span> m5<span class="fl">.3</span> <span class="sc">|&gt;</span> </span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now compare the models by the PSIS-LOO-CV.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(l5<span class="fl">.1</span>, l5<span class="fl">.2</span>, l5<span class="fl">.3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_loo se_elpd_loo p_loo se_p_loo looic se_looic
model1   0.0       0.0   -62.9      6.4         3.7   1.8    125.8  12.8   
model3  -1.0       0.3   -63.9      6.4         4.8   1.9    127.8  12.9   
model2  -6.8       4.6   -69.7      5.0         3.0   1.0    139.4  10.0   </code></pre>
</div>
</div>
<p>Like in the text, our <code>m5.1</code> has the best LOO estimate, but only by a little bit when compared to <code>m5.3</code>. Unlike McElreath reported in the text, we did not get a warning message from <code>loo_compare()</code>. Let’s investigate more carefully with the <code>loo()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(m5<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 50 log-likelihood matrix.

         Estimate   SE
elpd_loo    -63.9  6.4
p_loo         4.8  1.9
looic       127.8 12.9
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.6, 1.3]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>The critical line in that output was <code>All Pareto k estimates are good (k &lt; 0.7)</code>. The <strong>loo</strong> package bins the Pareto-<span class="math inline">\(k\)</span> values into ranges labeled <code>ok</code>, <code>good</code>, <code>bad</code>, and <code>very bad</code>, and you will get warnings if anything starts to look <code>bad</code> or worse.<br>
To dig deeper, we can use the <code>pareto_k_ids()</code> function to identify which observation[s] might have crossed out of the <code>(good)</code> range into the <code>(ok)</code> range.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(m5<span class="fl">.3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pareto_k_ids</span>(<span class="at">threshold =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13</code></pre>
</div>
</div>
<p>The number <code>13</code> refers to the corresponding row in the data used to fit the model. We can access that row directly with the <code>dplyr::slice()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">13</span>) <span class="sc">|&gt;</span> </span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Location<span class="sc">:</span>Loc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Location Loc
1    Idaho  ID</code></pre>
</div>
</div>
<p>Here we subset the 13<sup>th</sup> cell in the <code>loo::pareto_k_values()</code> output to see what that <span class="math inline">\(k\)</span> value was.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pareto_k_values</span>(l5<span class="fl">.3</span>)[<span class="dv">13</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6680358</code></pre>
</div>
</div>
<p>Alternatively, we could have extracted that value from our <code>l5.3</code> object with indexing like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>l5<span class="fl">.3</span><span class="sc">$</span>diagnostics<span class="sc">$</span>pareto_k[<span class="dv">13</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6680358</code></pre>
</div>
</div>
<p>0.67 is a little high, but not high enough to cause <code>loo()</code> to return a warning message. Once a Pareto <span class="math inline">\(k\)</span> value crosses the 0.7 threshold, though, the <strong>loo</strong> package will bark. Before we make our version of Figure 7.10, we’ll want to compute the WAIC for <code>m5.3</code>, which will give us access to the <span class="math inline">\(p_\text{WAIC}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>w5<span class="fl">.3</span> <span class="ot">&lt;-</span> m5<span class="fl">.3</span> <span class="sc">|&gt;</span> </span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">waic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’re ready to make our version of Figure 7.10.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>d_k <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pareto_k =</span> l5<span class="fl">.3</span><span class="sc">$</span>diagnostics<span class="sc">$</span>pareto_k,</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_waic   =</span> w5<span class="fl">.3</span><span class="sc">$</span>pointwise[, <span class="st">"p_waic"</span>],</span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Loc      =</span> <span class="fu">pull</span>(d, Loc)) </span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>d_k <span class="sc">|&gt;</span> </span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pareto_k, <span class="at">y =</span> p_waic, <span class="at">color =</span> Loc <span class="sc">==</span> <span class="st">"ID"</span>)) <span class="sc">+</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.7</span>), </span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> Loc <span class="sc">==</span> <span class="st">"ID"</span>)) <span class="sc">+</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> d_k <span class="sc">|&gt;</span> </span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(p_waic <span class="sc">&gt;</span> <span class="fl">0.5</span>),</span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> Loc),</span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">nudge_x =</span> <span class="sc">-</span><span class="fl">0.03</span>) <span class="sc">+</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(PSIS<span class="sc">~</span>Pareto<span class="sc">~</span><span class="fu">italic</span>(k)), <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>)) <span class="sc">+</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">19</span>)) <span class="sc">+</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(p)[WAIC]),</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Gaussian model (m5.3)"</span>) <span class="sc">+</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-115-1.png" class="img-fluid" width="312"></p>
</div>
</div>
<p>For both the Pareto <span class="math inline">\(k\)</span> and the <span class="math inline">\(p_\text{WAIC}\)</span>, our values are not as extreme as those McElreath reported in the text. I’m not sure if this is a consequence of us using HMC or due to recent algorithmic changes for the Stan/<strong>loo</strong> teams. But at least the overall pattern is the same. Idaho is the most extreme/influential case.</p>
<p>In the text (p.&nbsp;232), McElreath reported the effective number of parameters for <code>b5.3</code> was nearly 6. We can look at this with the <code>waic()</code> output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(w5<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 50 log-likelihood matrix.

          Estimate   SE
elpd_waic    -63.8  6.4
p_waic         4.7  1.9
waic         127.6 12.7

2 (4.0%) p_waic estimates greater than 0.4. We recommend trying loo instead. </code></pre>
</div>
</div>
<p>Our <span class="math inline">\(p_\text{WAIC}\)</span> was about 4.7, which is still a little high due to Idaho but not quite as high as in the text. There is some concern that Idaho is putting us at risk of overfitting due to the large influence it has on the posterior.</p>
<p>We can fit a Student-<span class="math inline">\(t\)</span> model in <code>ratan()</code> by using the <code>student_t()</code> likelihood in the <code>model</code> block, and we can then use the <code>student_t_lpdf()</code> function in the <code>generated quantities</code> to compute the <code>log_lik</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the `stan_data`</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(d, a, m) <span class="sc">|&gt;</span> </span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define `model_code_5.3t`</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>model_code_5<span class="fl">.3</span>t <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] d;</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] m;</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a;</span></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real b0;</span></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real b1;</span></span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real b2;</span></span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = b0 + b1 * m + b2 * a;</span></span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a><span class="st">  d ~ student_t(2, mu, sigma);</span></span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb176-25"><a href="#cb176-25" aria-hidden="true" tabindex="-1"></a><span class="st">  b0 ~ normal(0, 0.2);</span></span>
<span id="cb176-26"><a href="#cb176-26" aria-hidden="true" tabindex="-1"></a><span class="st">  b1 ~ normal(0, 0.5);</span></span>
<span id="cb176-27"><a href="#cb176-27" aria-hidden="true" tabindex="-1"></a><span class="st">  b2 ~ normal(0, 0.5);</span></span>
<span id="cb176-28"><a href="#cb176-28" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ exponential(1);</span></span>
<span id="cb176-29"><a href="#cb176-29" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb176-30"><a href="#cb176-30" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb176-31"><a href="#cb176-31" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb176-32"><a href="#cb176-32" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = student_t_lpdf(d[i] | 2, b0 + b1 * m[i] + b2 * a[i], sigma);</span></span>
<span id="cb176-33"><a href="#cb176-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb176-34"><a href="#cb176-34" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit the <span class="math inline">\(t\)</span> model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>m5<span class="fl">.3</span>t <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_5<span class="fl">.3</span>t,</span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m5<span class="fl">.3</span>t, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b0"</span>, <span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"sigma"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean   sd    5% 94.5% n_eff Rhat
b0     0.02       0 0.10 -0.14  0.18  3420    1
b1     0.05       0 0.21 -0.28  0.39  3460    1
b2    -0.70       0 0.15 -0.94 -0.47  3356    1
sigma  0.58       0 0.09  0.45  0.73  3681    1

Samples were drawn using NUTS(diag_e) at Fri Aug  2 11:43:54 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Here’s a coefficient plot for <span class="math inline">\(\beta_2\)</span>, by the two likelihoods.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(m5<span class="fl">.3</span>),</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(m5<span class="fl">.3</span>t)</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">likelihood =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Gaussian"</span>, <span class="st">"Student[nu==2]"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> b2, <span class="at">y =</span> likelihood)) <span class="sc">+</span></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">.width =</span> <span class="fl">0.89</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.05</span>), <span class="at">labels =</span> ggplot2<span class="sc">:::</span>parse_safe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-120-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>Compute and save the <code>loo()</code> and <code>waic()</code> output for the new <span class="math inline">\(t\)</span> model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>l5<span class="fl">.3</span>t <span class="ot">&lt;-</span> m5<span class="fl">.3</span>t <span class="sc">|&gt;</span> </span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loo</span>()</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>w5<span class="fl">.3</span>t <span class="ot">&lt;-</span> m5<span class="fl">.3</span>t <span class="sc">|&gt;</span> </span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>() <span class="sc">|&gt;</span> </span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">waic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we might remake the plot from Figure 7.10, this time based on the <span class="math inline">\(t\)</span> model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>d_k <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pareto_k =</span> l5<span class="fl">.3</span>t<span class="sc">$</span>diagnostics<span class="sc">$</span>pareto_k,</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_waic   =</span> w5<span class="fl">.3</span>t<span class="sc">$</span>pointwise[, <span class="st">"p_waic"</span>],</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Loc      =</span> <span class="fu">pull</span>(d, Loc)) </span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>d_k <span class="sc">|&gt;</span> </span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pareto_k, <span class="at">y =</span> p_waic, <span class="at">color =</span> Loc <span class="sc">==</span> <span class="st">"ID"</span>)) <span class="sc">+</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.7</span>), </span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> Loc <span class="sc">==</span> <span class="st">"ID"</span>)) <span class="sc">+</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> d_k <span class="sc">|&gt;</span> </span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(Loc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ID"</span>, <span class="st">"ME"</span>)),</span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> Loc),</span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">nudge_x =</span> <span class="sc">-</span><span class="fl">0.03</span>) <span class="sc">+</span></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(PSIS<span class="sc">~</span>Pareto<span class="sc">~</span><span class="fu">italic</span>(k)), <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>)) <span class="sc">+</span></span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">19</span>)) <span class="sc">+</span></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(p)[WAIC]),</span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Student-t model (m5.3t)"</span>) <span class="sc">+</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_files/figure-html/unnamed-chunk-122-1.png" class="img-fluid" width="312"></p>
</div>
</div>
<p>The high points in both the Pareto <span class="math inline">\(k\)</span> and <span class="math inline">\(p_\text{WAIC}\)</span> are much smaller, and both ID and ME are now closer to the center of the bivariate distribution. We can formally compare the two versions of the model by the LOO with the <code>loo_compare()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(l5<span class="fl">.3</span>, l5<span class="fl">.3</span>t) <span class="sc">|&gt;</span> <span class="fu">print</span>(<span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_loo se_elpd_loo p_loo se_p_loo looic se_looic
model1   0.0       0.0   -63.9      6.4         4.8   1.9    127.8  12.9   
model2  -2.5       3.0   -66.4      5.8         6.2   1.0    132.9  11.5   </code></pre>
</div>
</div>
<p>The standard error for the LOO difference was about the same size as the difference itself. This suggests the models were close and hard to distinguish with respect to their fit to the data. This will not always be the case.</p>
<section id="rethinking-the-curse-of-tippecanoe." class="level4" data-number="7.5.2.1">
<h4 data-number="7.5.2.1" class="anchored" data-anchor-id="rethinking-the-curse-of-tippecanoe."><span class="header-section-number">7.5.2.1</span> Rethinking: The Curse of Tippecanoe.</h4>
</section>
</section>
</section>
<section id="summary" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="summary"><span class="header-section-number">7.6</span> Summary</h2>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.0 (2024-04-24)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] loo_2.8.0          posterior_1.6.0    patchwork_1.2.0    rstan_2.32.6      
 [5] StanHeaders_2.32.7 tidybayes_3.0.6    lubridate_1.9.3    forcats_1.0.0     
 [9] stringr_1.5.1      dplyr_1.1.4        purrr_1.0.2        readr_2.1.5       
[13] tidyr_1.3.1        tibble_3.2.1       ggplot2_3.5.1      tidyverse_2.0.0   

loaded via a namespace (and not attached):
 [1] shape_1.4.6.1        gtable_0.3.5         tensorA_0.36.2.1    
 [4] xfun_0.43            QuickJSR_1.1.3       htmlwidgets_1.6.4   
 [7] processx_3.8.4       inline_0.3.19        lattice_0.22-6      
[10] tzdb_0.4.0           ps_1.7.6             vctrs_0.6.5         
[13] tools_4.4.0          generics_0.1.3       stats4_4.4.0        
[16] curl_5.2.1           parallel_4.4.0       fansi_1.0.6         
[19] cmdstanr_0.8.1       pkgconfig_2.0.3      Matrix_1.7-0        
[22] checkmate_2.3.1      RColorBrewer_1.1-3   distributional_0.4.0
[25] RcppParallel_5.1.7   lifecycle_1.0.4      farver_2.1.1        
[28] compiler_4.4.0       munsell_0.5.1        codetools_0.2-20    
[31] htmltools_0.5.8.1    yaml_2.3.8           pillar_1.9.0        
[34] MASS_7.3-60.2        arrayhelpers_1.1-0   rethinking_2.40     
[37] abind_1.4-5          tidyselect_1.2.1     digest_0.6.35       
[40] svUnit_1.0.6         mvtnorm_1.2-5        stringi_1.8.4       
[43] labeling_0.4.3       fastmap_1.1.1        grid_4.4.0          
[46] colorspace_2.1-0     cli_3.6.3            magrittr_2.0.3      
[49] pkgbuild_1.4.4       utf8_1.2.4           withr_3.0.0         
[52] scales_1.3.0         backports_1.5.0      timechange_0.3.0    
[55] rmarkdown_2.26       matrixStats_1.3.0    gridExtra_2.3       
[58] hms_1.1.3            coda_0.19-4.1        evaluate_0.23       
[61] knitr_1.46           V8_4.4.2             ggdist_3.3.2        
[64] viridisLite_0.4.2    rlang_1.1.4          Rcpp_1.0.12         
[67] glue_1.7.0           rstudioapi_0.16.0    jsonlite_1.8.8      
[70] R6_2.5.1            </code></pre>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="list" style="display: none">
<div id="ref-rstan2024RM" class="csl-entry" role="listitem">
Guo, J., Gabry, J., Goodrich, B., Johnson, A., Weber, S., &amp; Badr, H. S. (2024). <em><span><span>“rstan”</span></span> reference manual, <span>Version</span> 2.32.6</em>. <a href="https://CRAN.R-project.org/package=rstan/rstan.pdf">https://CRAN.R-project.org/package=rstan/rstan.pdf</a>
</div>
<div id="ref-wilksLargesampleDistributionLikelihood1938" class="csl-entry" role="listitem">
Wilks, S. S. (1938). The large-sample distribution of the likelihood ratio for testing composite hypotheses. <em>The Annals of Mathematical Statistics</em>, <em>9</em>(1), 60–62. <a href="https://doi.org/10.1214/aoms/1177732360">https://doi.org/10.1214/aoms/1177732360</a>
</div>
<div id="ref-yaoUsingStackingAverage2018" class="csl-entry" role="listitem">
Yao, Y., Vehtari, A., Simpson, D., &amp; Gelman, A. (2018). Using stacking to average <span>Bayesian</span> predictive distributions (with discussion). <em>Bayesian Analysis</em>, <em>13</em>(3), 917–1007. <a href="https://doi.org/10.1214/17-BA1091">https://doi.org/10.1214/17-BA1091</a>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./06.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Haunted DAG &amp; The Causal Terror</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>