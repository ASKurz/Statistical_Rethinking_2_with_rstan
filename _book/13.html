<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical rethinking 2 with rstan and the tidyverse - 13&nbsp; Models With Memory</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./12.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./13.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Statistical rethinking</em> 2 with rstan and the tidyverse</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ASKurz/Statistical_Rethinking_2_with_rstan" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title"><del>The Golem of Prague</del> <strong>rstan</strong> overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Small Worlds and Large Worlds</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Haunted DAG &amp; The Causal Terror</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses’ Compass</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conditional Manatees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Big Entropy and the Generalized Linear Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">God Spiked the Integers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#rethinking-a-model-by-any-other-name." id="toc-rethinking-a-model-by-any-other-name." class="nav-link active" data-scroll-target="#rethinking-a-model-by-any-other-name."><span class="header-section-number">13.0.0.1</span> Rethinking: A model by any other name.</a></li>
  <li><a href="#sec-Example-Multilevel-tadpoles" id="toc-sec-Example-Multilevel-tadpoles" class="nav-link" data-scroll-target="#sec-Example-Multilevel-tadpoles"><span class="header-section-number">13.1</span> Example: Multilevel tadpoles</a>
  <ul>
  <li><a href="#overthinking-quap-fails-mcmc-succeeds." id="toc-overthinking-quap-fails-mcmc-succeeds." class="nav-link" data-scroll-target="#overthinking-quap-fails-mcmc-succeeds."><span class="header-section-number">13.1.0.1</span> Overthinking: QUAP fails, MCMC succeeds.</a></li>
  <li><a href="#rethinking-varying-intercepts-as-over-dispersion." id="toc-rethinking-varying-intercepts-as-over-dispersion." class="nav-link" data-scroll-target="#rethinking-varying-intercepts-as-over-dispersion."><span class="header-section-number">13.1.0.2</span> Rethinking: Varying intercepts as over-dispersion.</a></li>
  <li><a href="#overthinking-prior-for-variance-components." id="toc-overthinking-prior-for-variance-components." class="nav-link" data-scroll-target="#overthinking-prior-for-variance-components."><span class="header-section-number">13.1.0.3</span> Overthinking: Prior for variance components.</a></li>
  </ul></li>
  <li><a href="#varying-effects-and-the-underfittingoverfitting-trade-off" id="toc-varying-effects-and-the-underfittingoverfitting-trade-off" class="nav-link" data-scroll-target="#varying-effects-and-the-underfittingoverfitting-trade-off"><span class="header-section-number">13.2</span> Varying effects and the underfitting/overfitting trade-off</a>
  <ul>
  <li><a href="#the-model." id="toc-the-model." class="nav-link" data-scroll-target="#the-model."><span class="header-section-number">13.2.1</span> The model.</a></li>
  <li><a href="#assign-values-to-the-parameters." id="toc-assign-values-to-the-parameters." class="nav-link" data-scroll-target="#assign-values-to-the-parameters."><span class="header-section-number">13.2.2</span> Assign values to the parameters.</a>
  <ul>
  <li><a href="#overthinking-data-types-and-stan-models." id="toc-overthinking-data-types-and-stan-models." class="nav-link" data-scroll-target="#overthinking-data-types-and-stan-models."><span class="header-section-number">13.2.2.1</span> Overthinking: Data types and Stan models.</a></li>
  </ul></li>
  <li><a href="#sumulate-survivors." id="toc-sumulate-survivors." class="nav-link" data-scroll-target="#sumulate-survivors."><span class="header-section-number">13.2.3</span> Sumulate survivors.</a></li>
  <li><a href="#compute-the-no-pooling-estimates." id="toc-compute-the-no-pooling-estimates." class="nav-link" data-scroll-target="#compute-the-no-pooling-estimates."><span class="header-section-number">13.2.4</span> Compute the no-pooling estimates.</a></li>
  <li><a href="#compute-the-partial-pooling-estimates." id="toc-compute-the-partial-pooling-estimates." class="nav-link" data-scroll-target="#compute-the-partial-pooling-estimates."><span class="header-section-number">13.2.5</span> Compute the partial-pooling estimates.</a>
  <ul>
  <li><a href="#overthinking-repeating-the-pond-simulation." id="toc-overthinking-repeating-the-pond-simulation." class="nav-link" data-scroll-target="#overthinking-repeating-the-pond-simulation."><span class="header-section-number">13.2.5.1</span> Overthinking: Repeating the pond simulation.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-More-than-one-type-of-cluster" id="toc-sec-More-than-one-type-of-cluster" class="nav-link" data-scroll-target="#sec-More-than-one-type-of-cluster"><span class="header-section-number">13.3</span> More than one type of cluster</a>
  <ul>
  <li><a href="#rethinking-cross-classification-and-hierarchy." id="toc-rethinking-cross-classification-and-hierarchy." class="nav-link" data-scroll-target="#rethinking-cross-classification-and-hierarchy."><span class="header-section-number">13.3.0.1</span> Rethinking: Cross-classification and hierarchy.</a></li>
  <li><a href="#multilevel-chimpanzees." id="toc-multilevel-chimpanzees." class="nav-link" data-scroll-target="#multilevel-chimpanzees."><span class="header-section-number">13.3.1</span> Multilevel chimpanzees.</a></li>
  <li><a href="#even-more-clusters." id="toc-even-more-clusters." class="nav-link" data-scroll-target="#even-more-clusters."><span class="header-section-number">13.3.2</span> Even more clusters.</a></li>
  </ul></li>
  <li><a href="#divergent-transitions-and-non-centered-priors" id="toc-divergent-transitions-and-non-centered-priors" class="nav-link" data-scroll-target="#divergent-transitions-and-non-centered-priors"><span class="header-section-number">13.4</span> Divergent transitions and non-centered priors</a>
  <ul>
  <li><a href="#rethinking-no-free-samples." id="toc-rethinking-no-free-samples." class="nav-link" data-scroll-target="#rethinking-no-free-samples."><span class="header-section-number">13.4.1</span> Rethinking: No free samples.</a></li>
  <li><a href="#the-devils-funnel." id="toc-the-devils-funnel." class="nav-link" data-scroll-target="#the-devils-funnel."><span class="header-section-number">13.4.2</span> The Devil’s Funnel.</a></li>
  <li><a href="#sec-Non-centered-chimpanzees" id="toc-sec-Non-centered-chimpanzees" class="nav-link" data-scroll-target="#sec-Non-centered-chimpanzees"><span class="header-section-number">13.4.3</span> Non-centered chimpanzees.</a></li>
  </ul></li>
  <li><a href="#multilevel-posterior-predictions" id="toc-multilevel-posterior-predictions" class="nav-link" data-scroll-target="#multilevel-posterior-predictions"><span class="header-section-number">13.5</span> Multilevel posterior predictions</a>
  <ul>
  <li><a href="#posterior-prediction-for-same-clusters." id="toc-posterior-prediction-for-same-clusters." class="nav-link" data-scroll-target="#posterior-prediction-for-same-clusters."><span class="header-section-number">13.5.1</span> Posterior prediction for same clusters.</a></li>
  <li><a href="#posterior-prediction-for-new-clusters." id="toc-posterior-prediction-for-new-clusters." class="nav-link" data-scroll-target="#posterior-prediction-for-new-clusters."><span class="header-section-number">13.5.2</span> Posterior prediction for new clusters.</a></li>
  <li><a href="#post-stratification." id="toc-post-stratification." class="nav-link" data-scroll-target="#post-stratification."><span class="header-section-number">13.5.3</span> Post-stratification.</a></li>
  </ul></li>
  <li><a href="#summary-centered-non-centered-and-the-secret-third-parameterization" id="toc-summary-centered-non-centered-and-the-secret-third-parameterization" class="nav-link" data-scroll-target="#summary-centered-non-centered-and-the-secret-third-parameterization"><span class="header-section-number">13.6</span> <del>Summary</del> Centered, non-centered, and the secret third parameterization</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/ASKurz/Statistical_Rethinking_2_with_rstan/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Models With Memory</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Load the packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loo)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop grid lines</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="rethinking-a-model-by-any-other-name." class="level4" data-number="13.0.0.1">
<h4 data-number="13.0.0.1" class="anchored" data-anchor-id="rethinking-a-model-by-any-other-name."><span class="header-section-number">13.0.0.1</span> Rethinking: A model by any other name.</h4>
</section>
<section id="sec-Example-Multilevel-tadpoles" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="sec-Example-Multilevel-tadpoles"><span class="header-section-number">13.1</span> Example: Multilevel tadpoles</h2>
<p>Let’s load the <code>reedfrogs</code> data <span class="citation" data-cites="voneshCompensatoryLarvalResponses2005">(see <a href="references.html#ref-voneshCompensatoryLarvalResponses2005" role="doc-biblioref">Vonesh &amp; Bolker, 2005</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(reedfrogs, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> reedfrogs <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a the `tank` cluster variable</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tank =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(reedfrogs)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 48
Columns: 6
$ density  &lt;int&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 1…
$ pred     &lt;fct&gt; no, no, no, no, no, no, no, no, pred, pred, pred, pred, pred,…
$ size     &lt;fct&gt; big, big, big, big, small, small, small, small, big, big, big…
$ surv     &lt;int&gt; 9, 10, 7, 10, 9, 9, 10, 9, 4, 9, 7, 6, 7, 5, 9, 9, 24, 23, 22…
$ propsurv &lt;dbl&gt; 0.90, 1.00, 0.70, 1.00, 0.90, 0.90, 1.00, 0.90, 0.40, 0.90, 0…
$ tank     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…</code></pre>
</div>
</div>
<p>Here’s the formula for the un-pooled model in which each <code>tank</code> gets its own intercept:</p>
<p><span class="math display">\[
\begin{align*}
\text{surv}_i             &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{tank}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal} (0, 1.5) &amp; \text{for } j = 1, \dots, 48,
\end{align*}
\]</span></p>
<p>where <span class="math inline">\(n_i\)</span> is indexed by the <code>density</code> column. Its values are distributed like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(density)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  density  n
1      10 16
2      25 16
3      35 16</code></pre>
</div>
</div>
<p>Now we make the <code>stan_data</code> with the <code>compose_data()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(surv, density, tank) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ surv   : int [1:48(1d)] 9 10 7 10 9 9 10 9 4 9 ...
 $ density: int [1:48(1d)] 10 10 10 10 10 10 10 10 10 10 ...
 $ tank   : int [1:48(1d)] 1 2 3 4 5 6 7 8 9 10 ...
 $ n      : int 48</code></pre>
</div>
</div>
<p>Make the <code>model_code</code> for the first simple model, which follows the basic format we learned back in <a href="11.html#sec-Aggregated-binomial-Chimpanzees-again-condensed"><span>Section&nbsp;11.1.3</span></a>. Also note how we’re getting ready for information criteria with the <code>generated quantities</code> block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int tank;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int density;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int surv;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">  surv ~ binomial(density, inv_logit(a[tank]));</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(0, 1.5);</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = binomial_lpmf(surv[i] | density[i], inv_logit(a[tank[i]]));</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now fit the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.1</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.1</span>, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a[1]"</span>, <span class="st">"a[48]"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean   sd  5.5% 94.5% n_eff Rhat
a[1]   1.70    0.01 0.74  0.59  2.95  6081    1
a[48] -0.06    0.00 0.33 -0.59  0.47  4962    1

Samples were drawn using NUTS(diag_e) at Fri Aug 23 11:44:06 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Note how I restricted the output to the first and last intercept with the <code>pars</code> argument. You can adjust that code to inspect more or fewer of the intercepts, as desired.</p>
<p>Now consider the multilevel alternative. Its formula is</p>
<p><span class="math display">\[
\begin{align*}
\text{surv}_i             &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{tank}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal}(\color{blue}{\bar \alpha}, \color{blue} \sigma) \\
\color{blue}{\bar \alpha} &amp; \sim \color{blue}{\operatorname{Normal}(0, 1.5)} \\
\color{blue} \sigma       &amp; \sim \color{blue}{\operatorname{Exponential}(1)},
\end{align*}
\]</span></p>
<p>where</p>
<blockquote class="blockquote">
<p>the prior for the tank intercepts is now a function of two parameters, <span class="math inline">\(\bar \alpha\)</span> and <span class="math inline">\(\sigma\)</span>. You can say <span class="math inline">\(\bar \alpha\)</span> like “bar alpha.” The bar means average. These two parameters inside the prior is where the “multi” in multilevel arises. The Gaussian distribution with mean <span class="math inline">\(\bar \alpha\)</span> standard deviation <span class="math inline">\(\sigma\)</span> is the prior for each tank’s intercept. But that prior itself has priors for <span class="math inline">\(\bar \alpha\)</span> and <span class="math inline">\(\sigma\)</span>. So there are two levels in the model, each resembling a simpler model. (p.&nbsp;403, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Here we make the <code>model_code_13.2</code>, and fit the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int tank;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int density;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int surv;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real abar;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="st">  surv ~ binomial(density, inv_logit(a[tank]));</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(abar, sigma);</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="st">  abar ~ normal(0, 1.5);</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ exponential(1);</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = binomial_lpmf(surv[i] | density[i], inv_logit(a[tank[i]]));</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.2</span>, </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.2</span>, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"abar"</span>, <span class="st">"sigma"</span>, <span class="st">"a[1]"</span>, <span class="st">"a[48]"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

      mean se_mean   sd  5.5% 94.5% n_eff Rhat
abar  1.36    0.00 0.26  0.95  1.78  3120    1
sigma 1.63    0.00 0.22  1.31  2.01  2306    1
a[1]  2.15    0.01 0.86  0.88  3.61  4386    1
a[48] 0.00    0.00 0.33 -0.53  0.54  4909    1

Samples were drawn using NUTS(diag_e) at Sat Aug 24 10:11:29 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Compare the two models by the WAIC with the <code>extract_log_lik()</code>, <code>waic()</code>, and <code>loo_compare()</code> functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m13<span class="fl">.1</span>) <span class="sc">|&gt;</span> <span class="fu">waic</span>(),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m13<span class="fl">.2</span>) <span class="sc">|&gt;</span> <span class="fu">waic</span>()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
model2    0.0       0.0   -99.9       3.7         20.9    0.9     199.9    7.4 
model1   -7.2       1.9  -107.1       2.4         25.4    1.3     214.3    4.7 </code></pre>
</div>
</div>
<p>Our results match up nicely with those in the text (p.&nbsp;404). Here are the stacking weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_model_weights</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="fu">extract_log_lik</span>(m13<span class="fl">.1</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">extract_log_lik</span>(m13<span class="fl">.2</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>()),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"stacking"</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Method: stacking
------
       weight
model1 0.000 
model2 1.000 </code></pre>
</div>
</div>
<p>All the weight goes to the multilevel model.</p>
<p>Here we use a little <code>bind_rows()</code> and <code>spread_draws()</code> magic to make a version of Figure 13.1 based on both models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  m13<span class="fl">.1</span> <span class="sc">|&gt;</span> <span class="fu">spread_draws</span>(a[tank]),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  m13<span class="fl">.2</span> <span class="sc">|&gt;</span> <span class="fu">spread_draws</span>(a[tank])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"conventional (m13.1)"</span>, <span class="st">"multilevel (m13.2)"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">propsurv =</span> <span class="fu">plogis</span>(a)) <span class="sc">|&gt;</span> </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tank, model) <span class="sc">|&gt;</span> </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(propsurv, <span class="at">.width =</span> <span class="fl">0.89</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d <span class="sc">|&gt;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(tank, density), </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(tank)) <span class="sc">|&gt;</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tank, <span class="at">y =</span> propsurv)) <span class="sc">+</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(d<span class="sc">$</span>propsurv), <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointinterval</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper),</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"proportion survival"</span>, <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(model <span class="sc">~</span> density, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">density =</span> label_both), <span class="at">scales =</span> <span class="st">"free_x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>Here’s a version of Figure 13.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Left</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m13<span class="fl">.2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw, abar, sigma) <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="fl">3.5</span>, <span class="at">to =</span> <span class="fl">4.5</span>, <span class="at">length.out =</span> <span class="dv">101</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dnorm</span>(<span class="at">x =</span> x, <span class="at">mean =</span> abar, <span class="at">sd =</span> sigma)) <span class="sc">|&gt;</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density, <span class="at">group =</span> .draw)) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"log-odds survive"</span>) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Right</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m13<span class="fl">.2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw, abar, sigma) <span class="sc">|&gt;</span> </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">8000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sim_tanks =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> abar, <span class="at">sd =</span> sigma)) <span class="sc">|&gt;</span> </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(sim_tanks)) <span class="sc">|&gt;</span> </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p)) <span class="sc">+</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">adjust =</span> <span class="fl">0.1</span>, <span class="at">fill =</span> <span class="st">"gray65"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"probability survive"</span>,</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">|</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<section id="overthinking-quap-fails-mcmc-succeeds." class="level4" data-number="13.1.0.1">
<h4 data-number="13.1.0.1" class="anchored" data-anchor-id="overthinking-quap-fails-mcmc-succeeds."><span class="header-section-number">13.1.0.1</span> Overthinking: QUAP fails, MCMC succeeds.</h4>
</section>
<section id="rethinking-varying-intercepts-as-over-dispersion." class="level4" data-number="13.1.0.2">
<h4 data-number="13.1.0.2" class="anchored" data-anchor-id="rethinking-varying-intercepts-as-over-dispersion."><span class="header-section-number">13.1.0.2</span> Rethinking: Varying intercepts as over-dispersion.</h4>
</section>
<section id="overthinking-prior-for-variance-components." class="level4" data-number="13.1.0.3">
<h4 data-number="13.1.0.3" class="anchored" data-anchor-id="overthinking-prior-for-variance-components."><span class="header-section-number">13.1.0.3</span> Overthinking: Prior for variance components.</h4>
<p>Here’s how we define and fit the model with the half-normal prior on <span class="math inline">\(\sigma\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.2</span>b <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int tank;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int density;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int surv;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real abar;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="st">  surv ~ binomial(density, inv_logit(a[tank]));</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(abar, sigma);</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="st">  abar ~ normal(0, 1.5);</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ normal(0, 1);</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.2</span>b <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.2</span>b, </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.2</span>b, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"abar"</span>, <span class="st">"sigma"</span>, <span class="st">"a[1]"</span>, <span class="st">"a[48]"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

      mean se_mean   sd  5.5% 94.5% n_eff Rhat
abar  1.34    0.00 0.25  0.95  1.74  3765    1
sigma 1.60    0.00 0.20  1.30  1.94  2332    1
a[1]  2.12    0.01 0.88  0.84  3.62  4016    1
a[48] 0.00    0.00 0.33 -0.52  0.55  4640    1

Samples were drawn using NUTS(diag_e) at Sat Aug 24 10:14:08 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>If you’re curious how the exponential and half-Normal priors compare to one another and to their posteriors, you might just plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For descriptive y-axis labels</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>prior_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sigma%~%exponential(1)"</span>, <span class="st">"sigma%~%'half-normal(0, 1)'"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">as_draws_df</span>(m13<span class="fl">.2</span>), <span class="fu">as_draws_df</span>(m13<span class="fl">.2</span>b)) <span class="sc">|&gt;</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior =</span> <span class="fu">rep</span>(prior_vec, <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sigma, <span class="at">y =</span> prior)) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.1</span>), </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels =</span> ggplot2<span class="sc">:::</span>parse_safe) <span class="sc">+</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(sigma[posterior]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="528"></p>
</div>
</div>
<p>In this case, the prior didn’t matter much.</p>
</section>
</section>
<section id="varying-effects-and-the-underfittingoverfitting-trade-off" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="varying-effects-and-the-underfittingoverfitting-trade-off"><span class="header-section-number">13.2</span> Varying effects and the underfitting/overfitting trade-off</h2>
<section id="the-model." class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="the-model."><span class="header-section-number">13.2.1</span> The model.</h3>
<p>The simulation formula should look familiar.</p>
<p><span class="math display">\[
\begin{align*}
\text{surv}_i &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_{\text{pond}[i]} \\
\alpha_j                  &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma) \\
\bar \alpha               &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma                    &amp; \sim \operatorname{Exponential}(1)
\end{align*}
\]</span></p>
</section>
<section id="assign-values-to-the-parameters." class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="assign-values-to-the-parameters."><span class="header-section-number">13.2.2</span> Assign values to the parameters.</h3>
<p>Here we follow along with McElreath and “assign specific values representative of the actual tadpole data” (p.&nbsp;409). Because he included a <code>set.seed()</code> line in his <strong>R</strong> code 13.8, our results should match his exactly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>a_bar   <span class="ot">&lt;-</span>  <span class="fl">1.5</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sigma   <span class="ot">&lt;-</span>  <span class="fl">1.5</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>n_ponds <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5005</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>dsim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pond   =</span> <span class="dv">1</span><span class="sc">:</span>n_ponds,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ni     =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">35</span>), <span class="at">each =</span> n_ponds <span class="sc">/</span> <span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>(),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">true_a =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_ponds, <span class="at">mean =</span> a_bar, <span class="at">sd =</span> sigma))</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dsim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 60
Columns: 3
$ pond   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ ni     &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 10, 10, 10, 10, 10…
$ true_a &lt;dbl&gt; 0.56673123, 1.99002317, -0.13775688, 1.85676651, 3.91208800, 1.…</code></pre>
</div>
</div>
<p>McElreath twice urged us to inspect the contents of this simulation. In addition to looking at the data with <code>glimpse()</code>, we might well plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dsim <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ni =</span> <span class="fu">factor</span>(ni)) <span class="sc">|&gt;</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> true_a, <span class="at">y =</span> ni)) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_dotsinterval</span>(<span class="at">size =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">slab_size =</span> <span class="dv">0</span>, <span class="at">.width =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Log-odds varying by # tadpoles per pond"</span>) <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<section id="overthinking-data-types-and-stan-models." class="level4" data-number="13.2.2.1">
<h4 data-number="13.2.2.1" class="anchored" data-anchor-id="overthinking-data-types-and-stan-models."><span class="header-section-number">13.2.2.1</span> Overthinking: Data types and Stan models.</h4>
<blockquote class="blockquote">
<p>There are two basic types of numerical data in R, in- tegers and real values. A number like “3” could be either. Inside your computer, integers and real (“numeric”) values are represented differently. For example, here is the same vector of values generated as both:</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "integer"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Usually, you don’t have to manage these types, because R manages them for you. But when you pass values to Stan, or another external program, often the internal representation does matter. In particular, Stan and <del><code>ulam</code></del> [<code>stan()</code>] sometimes require explicit integers. For example, in a binomial model, the “size” variable that specifies the number of trials must be of integer type. Stan may provide a mysterious warning message about a function not being found, when the size variable is instead of “real” type, or what R calls <code>numeric</code>. Using <code>as.integer</code> before passing the data to Stan or <del><code>ulam</code></del> [<code>stan()</code>] will resolve the issue. (p.&nbsp;410)</p>
</blockquote>
</section>
</section>
<section id="sumulate-survivors." class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="sumulate-survivors."><span class="header-section-number">13.2.3</span> Sumulate survivors.</h3>
<blockquote class="blockquote">
<p>Each pond <span class="math inline">\(i\)</span> has <span class="math inline">\(n_i\)</span> potential survivors, and nature flips each tadpole’s coin, so to speak, with probability of survival <span class="math inline">\(p_i\)</span>. This probability <span class="math inline">\(p_i\)</span> is implied by the model definition, and is equal to:</p>
<p><span class="math display">\[p_i = \frac{\exp (\alpha_i)}{1 + \exp (\alpha_i)}\]</span></p>
<p>The model uses a logit link, and so the probability is defined by the [<code>plogis()</code>] function. (p.&nbsp;411)</p>
</blockquote>
<p>Although McElreath shared his <code>set.seed()</code> number in the last section, he didn’t share it for this bit. We’ll go ahead and carry over the one from last time. However, in a moment we’ll see this clearly wasn’t the one he used here. As a consequence, our results will deviate a bit from his.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5005</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>dsim <span class="ot">&lt;-</span> dsim <span class="sc">|&gt;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">si =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">prob =</span> <span class="fu">plogis</span>(true_a), <span class="at">size =</span> ni))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dsim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 60
Columns: 4
$ pond   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ ni     &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 10, 10, 10, 10, 10…
$ true_a &lt;dbl&gt; 0.56673123, 1.99002317, -0.13775688, 1.85676651, 3.91208800, 1.…
$ si     &lt;int&gt; 4, 4, 3, 5, 5, 4, 4, 4, 3, 4, 5, 2, 5, 4, 5, 6, 3, 5, 5, 7, 4, …</code></pre>
</div>
</div>
</section>
<section id="compute-the-no-pooling-estimates." class="level3" data-number="13.2.4">
<h3 data-number="13.2.4" class="anchored" data-anchor-id="compute-the-no-pooling-estimates."><span class="header-section-number">13.2.4</span> Compute the no-pooling estimates.</h3>
<p>The no-pooling estimates (i.e., <span class="math inline">\(\alpha_{\text{tank}[i]}\)</span>) are the results of simple algebra.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dsim <span class="ot">&lt;-</span> dsim <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_nopool =</span> si <span class="sc">/</span> ni)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dsim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 60
Columns: 5
$ pond     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…
$ ni       &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 10, 10, 10, 10, …
$ true_a   &lt;dbl&gt; 0.56673123, 1.99002317, -0.13775688, 1.85676651, 3.91208800, …
$ si       &lt;int&gt; 4, 4, 3, 5, 5, 4, 4, 4, 3, 4, 5, 2, 5, 4, 5, 6, 3, 5, 5, 7, 4…
$ p_nopool &lt;dbl&gt; 0.8, 0.8, 0.6, 1.0, 1.0, 0.8, 0.8, 0.8, 0.6, 0.8, 1.0, 0.4, 1…</code></pre>
</div>
</div>
<p>“These are the same no-pooling estimates you’d get by fitting a model with a dummy variable for each pond and flat priors that induce no regularization” (p.&nbsp;411). That is, these are the same kinds of estimates we got back when we fit <code>m13.1</code>.</p>
</section>
<section id="compute-the-partial-pooling-estimates." class="level3" data-number="13.2.5">
<h3 data-number="13.2.5" class="anchored" data-anchor-id="compute-the-partial-pooling-estimates."><span class="header-section-number">13.2.5</span> Compute the partial-pooling estimates.</h3>
<p>Now we make the <code>stan_data</code> with the <code>compose_data()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> dsim <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(si, ni, pond) <span class="sc">|&gt;</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ si  : int [1:60(1d)] 4 4 3 5 5 4 4 4 3 4 ...
 $ ni  : int [1:60(1d)] 5 5 5 5 5 5 5 5 5 5 ...
 $ pond: int [1:60(1d)] 1 2 3 4 5 6 7 8 9 10 ...
 $ n   : int 60</code></pre>
</div>
</div>
<p>Here we define and fit the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int pond;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int ni;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int si;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real a_bar;</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a_pond;</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="st">  si ~ binomial(ni, inv_logit(a_pond[pond]));</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="st">  a_pond ~ normal(a_bar, sigma);</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="st">  a_bar ~ normal(0, 1.5);</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ exponential(1);</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.3</span>, </span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.3</span>, </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a_pond[1]"</span>, <span class="st">"a_pond[2]"</span>, </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">"a_pond[59]"</span>, <span class="st">"a_pond[60]"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"a_bar"</span>, <span class="st">"sigma"</span>), </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

           mean se_mean   sd 5.5% 94.5% n_eff Rhat
a_pond[1]  1.55    0.01 0.92 0.16  3.09  4452    1
a_pond[2]  1.56    0.01 0.97 0.07  3.17  5251    1
a_pond[59] 1.83    0.01 0.47 1.13  2.60  5344    1
a_pond[60] 2.70    0.01 0.63 1.76  3.79  4292    1
a_bar      1.47    0.00 0.23 1.12  1.83  3521    1
sigma      1.51    0.00 0.20 1.21  1.85  1713    1

Samples were drawn using NUTS(diag_e) at Sat Aug 24 10:07:57 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>To make Figure 13.3, we’ll first need a couple data objects. The <code>draws</code> data frame has the information for the points, and the <code>draws_means</code> data frame has the information for the horizontal lines.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> m13<span class="fl">.3</span> <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a_pond[pond]) <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_partpool =</span> <span class="fu">plogis</span>(a_pond)) <span class="sc">|&gt;</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pond) <span class="sc">|&gt;</span> </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">p_partpool =</span> <span class="fu">mean</span>(p_partpool)) <span class="sc">|&gt;</span> </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dsim <span class="sc">|&gt;</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(pond, true_a, p_nopool, ni)) <span class="sc">|&gt;</span> </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_true =</span> <span class="fu">plogis</span>(true_a)) <span class="sc">|&gt;</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nopool_error   =</span> <span class="fu">abs</span>(p_nopool   <span class="sc">-</span> p_true),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">partpool_error =</span> <span class="fu">abs</span>(p_partpool <span class="sc">-</span> p_true)) <span class="sc">|&gt;</span> </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">contains</span>(<span class="st">"error"</span>), <span class="at">values_to =</span> <span class="st">"error"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pooling =</span> <span class="fu">ifelse</span>(name <span class="sc">==</span> <span class="st">"nopool_error"</span>, <span class="st">"no"</span>, <span class="st">"partial"</span>))</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>draws_means <span class="ot">&lt;-</span> draws <span class="sc">|&gt;</span> </span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pooling, ni) <span class="sc">|&gt;</span> </span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(error))</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(draws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 120
Columns: 9
$ pond       &lt;int&gt; 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 1…
$ p_partpool &lt;dbl&gt; 0.7914621, 0.7914621, 0.7883729, 0.7883729, 0.6594354, 0.65…
$ true_a     &lt;dbl&gt; 0.5667312, 0.5667312, 1.9900232, 1.9900232, -0.1377569, -0.…
$ p_nopool   &lt;dbl&gt; 0.8, 0.8, 0.8, 0.8, 0.6, 0.6, 1.0, 1.0, 1.0, 1.0, 0.8, 0.8,…
$ ni         &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,…
$ p_true     &lt;dbl&gt; 0.6380086, 0.6380086, 0.8797456, 0.8797456, 0.4656151, 0.46…
$ name       &lt;chr&gt; "nopool_error", "partpool_error", "nopool_error", "partpool…
$ error      &lt;dbl&gt; 0.16199142, 0.15345356, 0.07974559, 0.09137274, 0.13438486,…
$ pooling    &lt;chr&gt; "no", "partial", "no", "partial", "no", "partial", "no", "p…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(draws_means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 8
Columns: 3
Groups: pooling [2]
$ pooling &lt;chr&gt; "no", "no", "no", "no", "partial", "partial", "partial", "part…
$ ni      &lt;int&gt; 5, 10, 25, 35, 5, 10, 25, 35
$ mean    &lt;dbl&gt; 0.09277077, 0.08466391, 0.03337703, 0.02542004, 0.10337870, 0.…</code></pre>
</div>
</div>
<p>Now make the figure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pond, <span class="at">y =</span> error)) <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> pooling, <span class="at">shape =</span> pooling)) <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">data =</span> draws_means,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">yintercept =</span> mean, <span class="at">color =</span> pooling, <span class="at">linetype =</span> pooling),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="st">"Pooling?"</span>, <span class="at">option =</span> <span class="st">"A"</span>, <span class="at">end =</span> <span class="fl">0.6</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Pooling?"</span>, <span class="at">values =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="st">"Pooling?"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"absolute error"</span>) <span class="sc">+</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> ni, <span class="at">labeller =</span> label_both, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="overthinking-repeating-the-pond-simulation." class="level4" data-number="13.2.5.1">
<h4 data-number="13.2.5.1" class="anchored" data-anchor-id="overthinking-repeating-the-pond-simulation."><span class="header-section-number">13.2.5.1</span> Overthinking: Repeating the pond simulation.</h4>
<p>Make the new <code>new_dsim</code> data frame, and them update the <code>stan_data</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1999</span>)  <span class="co"># For new data, set a new seed</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>new_dsim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pond   =</span> <span class="dv">1</span><span class="sc">:</span>n_ponds,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ni     =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">35</span>), <span class="at">each =</span> n_ponds <span class="sc">/</span> <span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>(),</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">true_a =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_ponds, <span class="at">mean =</span> a_bar, <span class="at">sd =</span> sigma)) <span class="sc">|&gt;</span> </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">si =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">prob =</span> <span class="fu">plogis</span>(true_a), <span class="at">size =</span> ni),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">p_nopool =</span> si <span class="sc">/</span> ni)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> new_dsim <span class="sc">|&gt;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(si, ni, pond) <span class="sc">|&gt;</span> </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now update the fit with the <code>sampling()</code> function, saving the results as <code>m13.3new</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.3</span>new <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> m13<span class="fl">.3</span><span class="sc">@</span>stanmodel,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Make the new variant of the figure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `m13.3new` in place of `m13.3`</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>draws_new <span class="ot">&lt;-</span> m13<span class="fl">.3</span>new <span class="sc">|&gt;</span> </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a_pond[pond]) <span class="sc">|&gt;</span> </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_partpool =</span> <span class="fu">plogis</span>(a_pond)) <span class="sc">|&gt;</span> </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pond) <span class="sc">|&gt;</span> </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">p_partpool =</span> <span class="fu">mean</span>(p_partpool)) <span class="sc">|&gt;</span> </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use `new_dsim` in place of `new`</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(new_dsim <span class="sc">|&gt;</span> </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(pond, true_a, p_nopool, ni)) <span class="sc">|&gt;</span> </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_true =</span> <span class="fu">plogis</span>(true_a)) <span class="sc">|&gt;</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nopool_error   =</span> <span class="fu">abs</span>(p_nopool   <span class="sc">-</span> p_true),</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">partpool_error =</span> <span class="fu">abs</span>(p_partpool <span class="sc">-</span> p_true)) <span class="sc">|&gt;</span> </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">contains</span>(<span class="st">"error"</span>), <span class="at">values_to =</span> <span class="st">"error"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pooling =</span> <span class="fu">ifelse</span>(name <span class="sc">==</span> <span class="st">"nopool_error"</span>, <span class="st">"no"</span>, <span class="st">"partial"</span>))</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>draws_means_new <span class="ot">&lt;-</span> draws_new <span class="sc">|&gt;</span> </span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pooling, ni) <span class="sc">|&gt;</span> </span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(error))</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>draws_new <span class="sc">|&gt;</span> </span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pond, <span class="at">y =</span> error)) <span class="sc">+</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> pooling, <span class="at">shape =</span> pooling)) <span class="sc">+</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">data =</span> draws_means_new,</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">yintercept =</span> mean, <span class="at">color =</span> pooling, <span class="at">linetype =</span> pooling),</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="st">"Pooling?"</span>, <span class="at">option =</span> <span class="st">"D"</span>, <span class="at">end =</span> <span class="fl">0.6</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Pooling?"</span>, <span class="at">values =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="st">"Pooling?"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"absolute error"</span>) <span class="sc">+</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> ni, <span class="at">labeller =</span> label_both, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="sec-More-than-one-type-of-cluster" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="sec-More-than-one-type-of-cluster"><span class="header-section-number">13.3</span> More than one type of cluster</h2>
<section id="rethinking-cross-classification-and-hierarchy." class="level4" data-number="13.3.0.1">
<h4 data-number="13.3.0.1" class="anchored" data-anchor-id="rethinking-cross-classification-and-hierarchy."><span class="header-section-number">13.3.0.1</span> Rethinking: Cross-classification and hierarchy.</h4>
</section>
<section id="multilevel-chimpanzees." class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="multilevel-chimpanzees."><span class="header-section-number">13.3.1</span> Multilevel chimpanzees.</h3>
<p>The initial multilevel update from model <code>m11.4</code> from <a href="11.html#sec-Logistic-regression-Prosocial-chimpanzees"><span>Section&nbsp;11.1.1</span></a> follows the statistical formula</p>
<p><span class="math display">\[
\begin{align*}
\text{pulled-left}_i         &amp; \sim \operatorname{Binomial}(n_i = 1, p_i) \\
\operatorname{logit} (p_i) &amp; = \alpha_{\text{actor}[i]} + \beta_{\text{treatment}[i]} + \color{blue}{\gamma_{\text{block}[i]}} \\
\alpha_j &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma_\alpha), \;\;\; \text{for } j = 1, \dots, 7 \\
\beta_j  &amp; \sim \operatorname{Normal}(0, 0.5), \;\;\; \text{for } j = 1, \dots, 4 \\
\color{blue}{\gamma_j} &amp; \sim \color{blue}{\operatorname{Normal}(0, \sigma_\gamma), \;\;\; \text{for } j = 1, \dots, 6} \\
\bar \alpha   &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma_\alpha &amp; \sim \operatorname{Exponential}(1) \\
\color{blue}{\sigma_\gamma} &amp; \sim \color{blue}{\operatorname{Exponential}(1)}.
\end{align*}
\]</span></p>
<p>Load the <code>chimpanzees</code> data, wrangle, and make the <code>stan_data</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(chimpanzees, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> chimpanzees <span class="sc">|&gt;</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">actor     =</span> <span class="fu">factor</span>(actor),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">block     =</span> <span class="fu">factor</span>(block),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">treatment =</span> <span class="fu">factor</span>(<span class="dv">1</span> <span class="sc">+</span> prosoc_left <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> condition))</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(chimpanzees)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pulled_left, actor, block, treatment) <span class="sc">|&gt;</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 8
 $ pulled_left: int [1:504(1d)] 0 1 0 0 1 1 0 0 0 0 ...
 $ actor      : num [1:504(1d)] 1 1 1 1 1 1 1 1 1 1 ...
 $ n_actor    : int 7
 $ block      : num [1:504(1d)] 1 1 1 1 1 1 2 2 2 2 ...
 $ n_block    : int 6
 $ treatment  : num [1:504(1d)] 1 1 2 1 2 2 2 2 1 1 ...
 $ n_treatment: int 4
 $ n          : int 504</code></pre>
</div>
</div>
<p>Define <code>model_code_13.4</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_actor;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_treatment;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_block;</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int actor;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int treatment;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int block;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; pulled_left;</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_actor] a;</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_treatment] b;</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_block] g;</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real a_bar;</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_a;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_g;</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="st">  pulled_left ~ binomial(1, inv_logit(a[actor] + b[treatment] + g[block]));</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ normal(0, 0.5);</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="st">  // adaptive priors</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(a_bar, sigma_a);</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="st">  g ~ normal(0, sigma_g);</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="st">  // hyper-priors</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="st">  a_bar ~ normal(0, 1.5);</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="st">  [sigma_a, sigma_g] ~ exponential(1);</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = binomial_lpmf(pulled_left[i] | 1, inv_logit(a[actor[i]] + b[treatment[i]] + g[block[i]]));</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit the cross-classified chimp model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.4</span>, </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Like in the text, this model returned warnings about divergent transitions, which isn’t great. As we learned back in <a href="09.html#sec-Non-identifiable-parameters"><span>Section&nbsp;9.5.4</span></a>, we can check for the divergent-transition warnings with the <code>check_divergences()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">check_divergences</span>(m13<span class="fl">.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>108 of 4000 iterations ended with a divergence (2.7%).
Try increasing 'adapt_delta' to remove the divergences.</code></pre>
</div>
</div>
<p>Here’s the parameter summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.4</span>, </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">include =</span> <span class="cn">FALSE</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"log_lik"</span>, <span class="st">"lp__"</span>),</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

         mean se_mean   sd  5.5% 94.5% n_eff Rhat
a[1]    -0.34    0.02 0.37 -0.96  0.20   298 1.02
a[2]     4.65    0.04 1.30  3.03  6.99  1198 1.01
a[3]    -0.66    0.01 0.36 -1.24 -0.11   839 1.01
a[4]    -0.64    0.03 0.39 -1.25 -0.03   166 1.03
a[5]    -0.35    0.01 0.36 -0.93  0.19   641 1.01
a[6]     0.61    0.03 0.39  0.00  1.27   128 1.03
a[7]     2.14    0.03 0.48  1.41  2.88   210 1.02
b[1]    -0.15    0.01 0.29 -0.61  0.32   549 1.01
b[2]     0.36    0.03 0.31 -0.23  0.85    97 1.04
b[3]    -0.51    0.03 0.31 -1.04 -0.01   141 1.03
b[4]     0.25    0.03 0.31 -0.34  0.73   107 1.04
g[1]    -0.16    0.01 0.21 -0.54  0.07   821 1.00
g[2]     0.05    0.01 0.20 -0.22  0.37   817 1.01
g[3]     0.06    0.01 0.20 -0.21  0.39   765 1.01
g[4]     0.02    0.01 0.19 -0.24  0.31   950 1.01
g[5]    -0.02    0.01 0.19 -0.31  0.26  1112 1.01
g[6]     0.12    0.01 0.22 -0.12  0.50   568 1.01
a_bar    0.63    0.03 0.72 -0.53  1.77   769 1.01
sigma_a  1.97    0.03 0.65  1.18  3.13   428 1.01
sigma_g  0.21    0.01 0.18  0.02  0.53   304 1.02

Samples were drawn using NUTS(diag_e) at Sun Aug 25 16:01:46 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Here’s Figure 13.4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For the y-axis ordering</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>parameter_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">str_c</span>(<span class="st">"b["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">"]"</span>), <span class="fu">str_c</span>(<span class="st">"a["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="st">"]"</span>), <span class="fu">str_c</span>(<span class="st">"g["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="st">"]"</span>), <span class="st">"a_bar"</span>, <span class="fu">str_c</span>(<span class="st">"sigma_"</span>, <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"g"</span>)))</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Left panel</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m13<span class="fl">.4</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">"log_lik"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="st">`</span><span class="at">a[1]</span><span class="st">`</span><span class="sc">:</span>sigma_g) <span class="sc">|&gt;</span> </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> parameter_vec) <span class="sc">|&gt;</span> </span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>           <span class="fu">fct_rev</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> name)) <span class="sc">+</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">.width =</span> <span class="fl">0.89</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For annotation</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>d_text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">c</span>(<span class="st">"actor"</span>, <span class="st">"block"</span>),</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="fl">0.6</span>),</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.10</span>, <span class="fl">0.75</span>))</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Right panel</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m13<span class="fl">.4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sigma_a, sigma_g) <span class="sc">|&gt;</span> </span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">ifelse</span>(name <span class="sc">==</span> <span class="st">"sigma_a"</span>, <span class="st">"actor"</span>, <span class="st">"block"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_histinterval</span>(<span class="fu">aes</span>(<span class="at">fill =</span> group, <span class="at">group =</span> group),</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>                    <span class="at">.width =</span> <span class="fl">0.89</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> d_text,</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">label =</span> group, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"C"</span>, <span class="at">begin =</span> <span class="fl">0.4</span>, <span class="at">end =</span> <span class="fl">0.7</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">"C"</span>, <span class="at">begin =</span> <span class="fl">0.4</span>, <span class="at">end =</span> <span class="fl">0.7</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"standard deviation"</span>) <span class="sc">+</span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>))</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the `layout` for the panels</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="at">t =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="dv">4</span>, <span class="at">l =</span> <span class="dv">1</span>, <span class="at">r =</span> <span class="dv">1</span>),</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="at">t =</span> <span class="dv">2</span>, <span class="at">b =</span> <span class="dv">4</span>, <span class="at">l =</span> <span class="dv">2</span>, <span class="at">r =</span> <span class="dv">2</span>))</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine and display</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> </span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">design =</span> layout)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now define and fit the simpler version of the model that omits the <span class="math inline">\(\gamma\)</span>-related parameters, <code>m13.5</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_actor;</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_treatment;</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int actor;</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int treatment;</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; pulled_left;</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_actor] a;</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_treatment] b;</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="st">  real a_bar;</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_a;</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="st">  pulled_left ~ binomial(1, inv_logit(a[actor] + b[treatment]));</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ normal(0, 0.5);</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="st">  // adaptive prior</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(a_bar, sigma_a);</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="st">  // hyper-priors</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="st">  a_bar ~ normal(0, 1.5);</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_a ~ exponential(1);</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = binomial_lpmf(pulled_left[i] | 1, inv_logit(a[actor[i]] + b[treatment[i]]));</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.5</span>, </span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compare the two models by the WAIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m13<span class="fl">.4</span>) <span class="sc">|&gt;</span> <span class="fu">waic</span>(),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m13<span class="fl">.5</span>) <span class="sc">|&gt;</span> <span class="fu">waic</span>()</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
model2    0.0       0.0  -265.6       9.6          8.5    0.4     531.2   19.2 
model1   -0.6       0.8  -266.2       9.7         10.7    0.5     532.5   19.4 </code></pre>
</div>
</div>
<p>Here are the stacking weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_model_weights</span>(</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="fu">extract_log_lik</span>(m13<span class="fl">.4</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">extract_log_lik</span>(m13<span class="fl">.5</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>()),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"stacking"</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Method: stacking
------
       weight
model1 0.000 
model2 1.000 </code></pre>
</div>
</div>
<p>The stacking weights more heavily favor the simpler model <code>m13.5</code>, than the WAIC weights McElreath reported in the book (p.&nbsp;418).</p>
<blockquote class="blockquote">
<p>There is nothing to gain here by selecting either model. The comparison of the two models tells a richer story… Since this is an experiment, there is nothing to really select. The experimental design tells us the relevant causal model to inspect. (pp.&nbsp;418–419)</p>
</blockquote>
</section>
<section id="even-more-clusters." class="level3" data-number="13.3.2">
<h3 data-number="13.3.2" class="anchored" data-anchor-id="even-more-clusters."><span class="header-section-number">13.3.2</span> Even more clusters.</h3>
<p>The next model <code>m13.6</code> is a minor generalization of <code>m13.4</code>, where the <span class="math inline">\(\beta\)</span> parameters are also partially pooled.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_actor;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_treatment;</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_block;</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int actor;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int treatment;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int block;</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; pulled_left;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_actor] a;</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_treatment] b;</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_block] g;</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real a_bar;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_a;</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_b;</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_g;</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="st">  pulled_left ~ binomial(1, inv_logit(a[actor] + b[treatment] + g[block]));</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="st">  // adaptive priors</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(a_bar, sigma_a);</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ normal(0, sigma_b);</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="st">  g ~ normal(0, sigma_g);</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="st">  // hyper-priors</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="st">  a_bar ~ normal(0, 1.5);</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="st">  [sigma_a, sigma_b, sigma_g] ~ exponential(1);</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = binomial_lpmf(pulled_left[i] | 1, inv_logit(a[actor[i]] + b[treatment[i]] + g[block[i]]));</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.6</span>, </span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In place of McElreath’s <code>coeftab()</code> approach, let’s just make a coefficient plot for the <span class="math inline">\(\beta\)</span> parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(<span class="fu">spread_draws</span>(m13<span class="fl">.4</span>, b[j]), </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>          <span class="fu">spread_draws</span>(m13<span class="fl">.6</span>, b[j])) <span class="sc">|&gt;</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"m13.4"</span>, <span class="st">"m13.6"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">parameter =</span> <span class="fu">str_c</span>(<span class="st">"beta["</span>, j, <span class="st">"]"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> b, <span class="at">y =</span> parameter, <span class="at">color =</span> model)) <span class="sc">+</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.89</span>, </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">1</span>,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="sc">-</span><span class="fl">0.4</span>)) <span class="sc">+</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">labels =</span> ggplot2<span class="sc">:::</span>parse_safe) <span class="sc">+</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="cn">NULL</span>, <span class="at">option =</span> <span class="st">"D"</span>, <span class="at">end =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"posterior"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As McElreath wrote:</p>
<blockquote class="blockquote">
<p>These are not identical, but they are very close. If you look at <code>sigma_b</code>, you’ll see that it is small. (p.&nbsp;420)</p>
</blockquote>
<p>Here’s <code>sigma_b</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m13<span class="fl">.6</span>) <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sigma_b)) <span class="sc">+</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">.width =</span> <span class="fl">0.89</span>, <span class="at">adjust =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(sigma[beta]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="432"></p>
</div>
</div>
<p>That’s an impressively jagged posterior.</p>
<p>Compare the two models <code>m13.4</code> and <code>m13.6</code> by the LOO and you’ll see they’re almost the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m13<span class="fl">.4</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>(),</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_log_lik</span>(m13<span class="fl">.6</span>) <span class="sc">|&gt;</span> <span class="fu">loo</span>()</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
model1    0.0       0.0  -266.3      9.7        10.7    0.5    532.5   19.4  
model2    0.0       0.2  -266.3      9.6        10.6    0.5    532.6   19.3  </code></pre>
</div>
</div>
<p>If you check the <code>check_divergences()</code> output, you’ll see we still have several divergent transitions with <code>m13.6</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">check_divergences</span>(m13<span class="fl">.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>58 of 4000 iterations ended with a divergence (1.45%).
Try increasing 'adapt_delta' to remove the divergences.</code></pre>
</div>
</div>
</section>
</section>
<section id="divergent-transitions-and-non-centered-priors" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="divergent-transitions-and-non-centered-priors"><span class="header-section-number">13.4</span> Divergent transitions and non-centered priors</h2>
<section id="rethinking-no-free-samples." class="level3" data-number="13.4.1">
<h3 data-number="13.4.1" class="anchored" data-anchor-id="rethinking-no-free-samples."><span class="header-section-number">13.4.1</span> Rethinking: No free samples.</h3>
</section>
<section id="the-devils-funnel." class="level3" data-number="13.4.2">
<h3 data-number="13.4.2" class="anchored" data-anchor-id="the-devils-funnel."><span class="header-section-number">13.4.2</span> The Devil’s Funnel.</h3>
<p>McElreath posed a joint distribution</p>
<p><span class="math display">\[
\begin{align*}
v &amp; \sim \operatorname{Normal}(0, 3) \\
x &amp; \sim \operatorname{Normal}(0, \exp(v)),
\end{align*}
\]</span></p>
<p>where the scale of <span class="math inline">\(x\)</span> depends on another variable, <span class="math inline">\(v\)</span>. Here’s how we might sample from those priors with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="st">  real v;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="st">  real x;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="st">  v ~ normal(0, 3);</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="st">  x ~ normal(0, exp(v));</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.7</span>, </span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Behold the <code>print()</code> summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.7</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

        mean se_mean     sd   5.5% 94.5% n_eff Rhat
v       1.71    0.34   2.06  -0.66  5.35    37 1.11
x    -114.05  116.05 810.96 -79.41 25.65    49 1.09
lp__   -2.55    0.46   2.85  -7.41  0.49    39 1.10

Samples were drawn using NUTS(diag_e) at Tue Sep 10 21:18:44 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>We have lots of divergent transitions, and other scary warning messages, too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">check_hmc_diagnostics</span>(m13<span class="fl">.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Divergences:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>383 of 4000 iterations ended with a divergence (9.575%).
Try increasing 'adapt_delta' to remove the divergences.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Tree depth:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>23 of 4000 iterations saturated the maximum tree depth of 10 (0.575%).
Try increasing 'max_treedepth' to avoid saturation.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Energy:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>E-BFMI indicated possible pathological behavior:
  Chain 1: E-BFMI = 0.131
E-BFMI below 0.2 indicates you may need to reparameterize your model.</code></pre>
</div>
</div>
<p>Here’s a scatter plot of the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m13<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> v)) <span class="sc">+</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(x)),</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(v)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>This is something of a sample version of McElreath’s Figure 13.5a.</p>
<p>Here are the trace plots via <code>mcmc_trace()</code>. They’re a mess.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(m13<span class="fl">.7</span>, </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">pars =</span> <span class="fu">vars</span>(v<span class="sc">:</span>x),</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">facet_args =</span> <span class="fu">list</span>(<span class="at">ncol =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>To avoid the divergent transitions than can arise models using the centered parameterization, we can switch from our original formula to a non-centered parameterization, such as:</p>
<p><span class="math display">\[
\begin{align*}
v &amp; \sim \operatorname{Normal}(0, 3) \\
z &amp; \sim \operatorname{Normal}(0, 1) \\
x &amp; = z \exp(v),
\end{align*}
\]</span></p>
<p>where <span class="math inline">\(x\)</span> is now a deterministic function of two independent distributions, <span class="math inline">\(v\)</span> and <span class="math inline">\(z\)</span>. For our <code>stan()</code>-based workflow, this means defining <code>v</code> and <code>z</code> in the <code>parameters</code> block, and then defining <code>x</code> as a function of the two in the <code>generated quantities</code>. But because <code>x</code> is a deterministic function of <code>v</code> and <code>z</code>, only <code>v</code> and <code>z</code> get assigned priors in the <code>model</code> block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.7</span>nc <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="st">  real v;</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="st">  real z;</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="st">  v ~ normal(0, 3);</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="st">  z ~ normal(0, 1);</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real x = z * exp(v);</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.7</span>nc <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.7</span>nc, </span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Behold the <code>print()</code> summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.7</span>nc, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean     sd   5.5% 94.5% n_eff Rhat
v      0.06    0.05   2.96  -4.67  4.76  3692    1
z     -0.02    0.02   1.00  -1.60  1.59  3965    1
x    -27.94   14.31 957.89 -27.78 22.63  4480    1
lp__  -0.99    0.02   1.01  -2.93 -0.05  1908    1

Samples were drawn using NUTS(diag_e) at Tue Sep 10 21:24:53 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>The values in the <code>n_eff</code> and <code>Rhat</code> columns are much better.</p>
<p>Here’s a scatter plot of the new results, which is something of a version of Figure 13.5b.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m13<span class="fl">.7</span>nc) <span class="sc">|&gt;</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> z, <span class="at">y =</span> v)) <span class="sc">+</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(z)),</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(v)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>The trace plots for <span class="math inline">\(v\)</span> and <span class="math inline">\(z\)</span> look pretty great, too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(m13<span class="fl">.7</span>nc, </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">pars =</span> <span class="fu">vars</span>(v, z, x),</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">facet_args =</span> <span class="fu">list</span>(<span class="at">ncol =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>The trace plot for <span class="math inline">\(x\)</span>, however, is a mess. This isn’t necessarily a problem, because we’re only really interested in <span class="math inline">\(v\)</span> and <span class="math inline">\(z\)</span>. <span class="math inline">\(x\)</span> is a means to an end.</p>
</section>
<section id="sec-Non-centered-chimpanzees" class="level3" data-number="13.4.3">
<h3 data-number="13.4.3" class="anchored" data-anchor-id="sec-Non-centered-chimpanzees"><span class="header-section-number">13.4.3</span> Non-centered chimpanzees.</h3>
<p>At the top of the section, McElreath reported the <code>rethinking::ulam()</code> default is to set <code>adapt_delta = 0.95</code>. Readers should be aware that the <code>rstan::stan()</code> default is <code>adapt_delta = 0.80</code>. See the <code>stan</code> section of the <em>rstan reference manual</em> (link <a href="https://CRAN.R-project.org/package=rstan/rstan.pdf">here</a>). A consequence of this difference is <code>rethinking::ulam()</code> will tend to take smaller step sizes than <code>rstan::stan()</code>, at the cost of slower exploration of the posterior. I don’t know that one is inherently better than the other. They’re just defaults.</p>
<p>We can just use the <code>sampling()</code> function to revisit <code>m13.4</code>. This time, we increase the <code>adapt_delta</code> parameter in a list fed to the <code>control</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.4</span>b <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> m13<span class="fl">.4</span><span class="sc">@</span>stanmodel,</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.99</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve been using the <code>check_divergences()</code> function to check for divergent-transitions. In addition to the number of divergent transitions, that function also returns recommendations for next steps, such as increasing the <code>adapt_delta</code> parameter. If all you want is a more focused output with just the number of divergent transitions, you might use the <code>get_num_divergent()</code> function instead. Here we compare the <code>get_num_divergent()</code> output from both <code>m13.4</code> and <code>m13.4b</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_num_divergent</span>(m13<span class="fl">.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 108</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_num_divergent</span>(m13<span class="fl">.4</span>b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>We dropped from 108 to 4, which isn’t nothing.</p>
<p>Here’s the <code>print()</code> summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.4</span>b, </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">include =</span> <span class="cn">FALSE</span>,</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"log_lik"</span>, <span class="st">"lp__"</span>),</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

         mean se_mean   sd  5.5% 94.5% n_eff Rhat
a[1]    -0.37    0.01 0.37 -0.96  0.21   765 1.00
a[2]     4.70    0.04 1.40  3.01  7.06  1035 1.00
a[3]    -0.66    0.01 0.38 -1.28 -0.05   823 1.00
a[4]    -0.67    0.01 0.38 -1.26 -0.09   771 1.00
a[5]    -0.37    0.01 0.37 -0.95  0.21   714 1.00
a[6]     0.58    0.01 0.38 -0.05  1.18   739 1.00
a[7]     2.10    0.01 0.46  1.39  2.83  1035 1.00
b[1]    -0.13    0.01 0.30 -0.61  0.35   700 1.00
b[2]     0.40    0.01 0.31 -0.08  0.90   640 1.00
b[3]    -0.47    0.01 0.31 -0.97  0.02   678 1.00
b[4]     0.28    0.01 0.31 -0.19  0.78   700 1.00
g[1]    -0.16    0.01 0.21 -0.55  0.08   937 1.00
g[2]     0.04    0.01 0.18 -0.21  0.34  1262 1.00
g[3]     0.05    0.00 0.18 -0.20  0.35  1578 1.00
g[4]     0.01    0.00 0.17 -0.24  0.29  2050 1.00
g[5]    -0.03    0.00 0.18 -0.31  0.24  1600 1.00
g[6]     0.11    0.01 0.19 -0.12  0.45  1032 1.00
a_bar    0.58    0.02 0.74 -0.60  1.70  1699 1.00
sigma_a  2.01    0.02 0.66  1.19  3.22  1699 1.00
sigma_g  0.21    0.01 0.17  0.03  0.52   483 1.01

Samples were drawn using NUTS(diag_e) at Thu Sep 12 15:20:59 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>For <code>m13.4nc</code>, we first update the statistical model to</p>
<p><span class="math display">\[
\begin{align*}
\text{pulled-left}_i &amp; \sim \operatorname{Binomial}(n_i = 1, p_i) \\
\operatorname{logit} (p_i) &amp; = \color{blue}{\underbrace{\bar \alpha + z_{\text{actor}[i]} \sigma_\alpha}_{\alpha_{\text{actor}[i]}}} + \beta_{\text{treatment}[i]} \color{blue} + \color{blue}{\underbrace{x_{\text{block}[i]} \sigma_\gamma}_{\gamma_{\text{block}[i]}}} \\
\beta_j  &amp; \sim \operatorname{Normal}(0, 0.5), \;\;\; \text{for } j = 1, \dots, 4 \\
\color{blue}{x_j} &amp; \sim \color{blue}{\operatorname{Normal}(0, 1)} \\
\color{blue}{z_j} &amp; \sim \color{blue}{\operatorname{Normal}(0, 1)} \\
\bar \alpha   &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma_\alpha, \sigma_\gamma &amp; \sim \operatorname{Exponential}(1),
\end{align*}
\]</span></p>
<p>where each actor intercept <span class="math inline">\(\alpha_j\)</span> is defined by <span class="math inline">\(\alpha + z_j \sigma_\alpha\)</span>, and each block intercept <span class="math inline">\(\gamma_j\)</span> is defined by <span class="math inline">\(x_j \sigma_\gamma\)</span>.</p>
<p>Here’s how we might define <code>model_code_13.4nc</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.4</span>nc <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_actor;</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_treatment;</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n_block;</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int actor;</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int treatment;</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int block;</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; pulled_left;</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_actor] z;</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_block] x;</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_treatment] b;</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real a_bar;</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_a;</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_g;</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] eta;  // To simplify the likelihood line</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a><span class="st">  eta = a_bar + z[actor] * sigma_a + x[block] * sigma_g + b[treatment];</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="st">  pulled_left ~ binomial(1, inv_logit(eta));</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="st">  a_bar ~ normal(0, 1.5);</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a><span class="st">  z ~ normal(0, 1);</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a><span class="st">  x ~ normal(0, 1);</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a><span class="st">  [sigma_a, sigma_g] ~ exponential(1);</span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ normal(0, 0.5);</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_actor] a = a_bar + z * sigma_a;</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n_block] g = x * sigma_g;</span></span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now fit the non-centered version of the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.4</span>nc <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.4</span>nc, </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>print()</code> summary for this version of the model is the best one yet.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.4</span>nc, </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">include =</span> <span class="cn">FALSE</span>,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"log_lik"</span>, <span class="st">"lp__"</span>),</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

         mean se_mean   sd  5.5% 94.5% n_eff Rhat
z[1]    -0.52    0.01 0.41 -1.19  0.09   957    1
z[2]     2.14    0.02 0.66  1.11  3.21  1703    1
z[3]    -0.69    0.01 0.43 -1.41 -0.04   939    1
z[4]    -0.69    0.01 0.43 -1.40 -0.04   961    1
z[5]    -0.52    0.01 0.41 -1.21  0.10   948    1
z[6]     0.00    0.01 0.38 -0.62  0.58   966    1
z[7]     0.83    0.01 0.47  0.11  1.61  1218    1
x[1]    -0.67    0.01 0.88 -2.03  0.77  3971    1
x[2]     0.16    0.01 0.86 -1.22  1.53  4004    1
x[3]     0.19    0.01 0.86 -1.22  1.54  4802    1
x[4]     0.05    0.01 0.86 -1.30  1.41  3902    1
x[5]    -0.13    0.01 0.83 -1.44  1.23  4195    1
x[6]     0.43    0.01 0.87 -0.97  1.82  3929    1
b[1]    -0.12    0.01 0.31 -0.61  0.37  2392    1
b[2]     0.40    0.01 0.30 -0.08  0.90  2422    1
b[3]    -0.47    0.01 0.31 -0.95  0.02  2344    1
b[4]     0.29    0.01 0.31 -0.19  0.78  2443    1
a_bar    0.59    0.02 0.74 -0.54  1.78   950    1
sigma_a  2.00    0.02 0.69  1.16  3.21  1311    1
sigma_g  0.20    0.00 0.17  0.02  0.51  1886    1
a[1]    -0.36    0.01 0.37 -0.95  0.21  2147    1
a[2]     4.67    0.02 1.34  2.98  6.94  3189    1
a[3]    -0.67    0.01 0.37 -1.27 -0.07  2601    1
a[4]    -0.68    0.01 0.38 -1.28 -0.10  2630    1
a[5]    -0.36    0.01 0.37 -0.96  0.21  2498    1
a[6]     0.58    0.01 0.37 -0.02  1.17  2408    1
a[7]     2.10    0.01 0.46  1.38  2.84  3082    1
g[1]    -0.15    0.00 0.21 -0.55  0.08  3125    1
g[2]     0.04    0.00 0.17 -0.20  0.34  4699    1
g[3]     0.05    0.00 0.18 -0.19  0.35  3662    1
g[4]     0.01    0.00 0.17 -0.25  0.30  3845    1
g[5]    -0.03    0.00 0.17 -0.31  0.22  4370    1
g[6]     0.11    0.00 0.19 -0.11  0.45  3200    1

Samples were drawn using NUTS(diag_e) at Tue Sep 10 21:35:03 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>We use the <code>summarise_draws()</code> function and the <code>parameter_vec</code> from a while back to make a version of McElreath’s Figure 13.6. Here we replace the old-fashioned <code>n_eff</code> values with the newer <code>ess_bulk</code> and <code>ess_tail</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(m13<span class="fl">.4</span>, ess_bulk, ess_tail),</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(m13<span class="fl">.4</span>nc, ess_bulk, ess_tail)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> parameter_vec) <span class="sc">|&gt;</span> </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fit =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"m13.4"</span>, <span class="st">"m13.4nc"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"ess_"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> fit, <span class="at">values_from =</span> value) <span class="sc">|&gt;</span> </span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> m13<span class="fl">.4</span>, <span class="at">y =</span> m13<span class="fl">.4</span>nc)) <span class="sc">+</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5000</span>),</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5000</span>)) <span class="sc">+</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"m13.4 (centered)"</span>,</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"m13.4nc (non-centered)"</span>) <span class="sc">+</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Big difference.</p>
</section>
</section>
<section id="multilevel-posterior-predictions" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="multilevel-posterior-predictions"><span class="header-section-number">13.5</span> Multilevel posterior predictions</h2>
<section id="posterior-prediction-for-same-clusters." class="level3" data-number="13.5.1">
<h3 data-number="13.5.1" class="anchored" data-anchor-id="posterior-prediction-for-same-clusters."><span class="header-section-number">13.5.1</span> Posterior prediction for same clusters.</h3>
<p>If you are using a by-hand approach for computing model-based expectations for a multilevel model of this kind, <code>spread_draws()</code> seems like a good solution for a tidy workflow. Here’s what that can look like for <code>actor == 2</code>, in <code>block == 1</code>. We just display the results in a plot resembling Figure 13.7a.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>chimp <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>d_pred <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">actor =</span> chimp,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">block =</span> <span class="dv">1</span>,</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co"># For the x-axis</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>treatment_labels_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"R/N"</span>, <span class="st">"L/N"</span>, <span class="st">"R/P"</span>, <span class="st">"L/P"</span>)</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.4</span> <span class="sc">|&gt;</span> </span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a[actor], b[treatment], g[block]) <span class="sc">|&gt;</span> </span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(d_pred, <span class="at">by =</span> <span class="fu">join_by</span>(actor, block, treatment)) <span class="sc">|&gt;</span> </span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(a <span class="sc">+</span> b <span class="sc">+</span> g)) <span class="sc">|&gt;</span> </span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> p)) <span class="sc">+</span></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.80</span>, </span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="st">"gray67"</span>) <span class="sc">+</span></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> treatment_labels_vec) <span class="sc">+</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"proportion pulled left"</span>,</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"actor 2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid" width="192"></p>
</div>
</div>
<p>Note the severely-restricted range on the y axis.</p>
<p>Part of the key to the <code>spread_draws()</code> approach is we named the indices for the <code>a</code>, <code>b</code>, and <code>g</code> vectors after the corresponding variables in the <code>d_pred</code> predictor data, and then used <code>right_join()</code> to connect the two.</p>
<p>Here’s what this looks like for <code>actor == 5</code>, as in Figure 13.7.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This has been updated</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>chimp <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>d_pred <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">actor =</span> chimp,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">block =</span> <span class="dv">1</span>,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.4</span> <span class="sc">|&gt;</span> </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a[actor], b[treatment], g[block]) <span class="sc">|&gt;</span> </span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(d_pred, <span class="at">by =</span> <span class="fu">join_by</span>(actor, block, treatment)) <span class="sc">|&gt;</span> </span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(a <span class="sc">+</span> b <span class="sc">+</span> g)) <span class="sc">|&gt;</span> </span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> p)) <span class="sc">+</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.80</span>, </span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="st">"gray67"</span>) <span class="sc">+</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> treatment_labels_vec) <span class="sc">+</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"proportion pulled left"</span>, <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"actor 5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid" width="192"></p>
</div>
</div>
<p>We could, of course, just make a faceted plot of all actors, in all blocks, and all treatments. For such a plot, we don’t even need the <code>d_pred</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.4</span> <span class="sc">|&gt;</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a[actor], b[treatment], g[block]) <span class="sc">|&gt;</span> </span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(a <span class="sc">+</span> b <span class="sc">+</span> g),</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">block =</span> <span class="fu">factor</span>(block)) <span class="sc">|&gt;</span> </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> p,</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> block, <span class="at">fill =</span> block, <span class="at">group =</span> block)) <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.80</span>, </span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> treatment_labels_vec, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"proportion pulled left"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>, <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> actor, <span class="at">labeller =</span> label_both, <span class="at">nrow =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>This is yet another reminder there was very little variation across blocks.</p>
</section>
<section id="posterior-prediction-for-new-clusters." class="level3" data-number="13.5.2">
<h3 data-number="13.5.2" class="anchored" data-anchor-id="posterior-prediction-for-new-clusters."><span class="header-section-number">13.5.2</span> Posterior prediction for new clusters.</h3>
<p>Here’s how we might make Figure 13.7, left. Note how we’ve dropped the <code>a[actor]</code> and <code>g[block]</code> terms from <code>spread_draws()</code>, and added in <code>a_bar</code>. For this plot, we didn’t need <code>d_pred</code> either.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> m13<span class="fl">.4</span> <span class="sc">|&gt;</span> </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a_bar, b[treatment]) <span class="sc">|&gt;</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(a_bar <span class="sc">+</span> b)) <span class="sc">|&gt;</span> </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> p)) <span class="sc">+</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.80</span>, </span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="st">"gray67"</span>) <span class="sc">+</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">labels =</span> treatment_labels_vec) <span class="sc">+</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"proportion pulled left"</span>, <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"average actor"</span>)</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid" width="192"></p>
</div>
</div>
<p>If we want to depict the variability across the chimps, we need to bring <code>sigma_a</code> into the calculations. In the block of code, below, we simulate a bundle of new intercepts defined by</p>
<p><span class="math display">\[\text{simulated chimpanzees} \sim \operatorname{Normal}(\bar \alpha, \sigma_\alpha).\]</span></p>
<p>If we are going to continue using a <code>spread_draws()</code>-based approach, to my mind it makes sense to first convert the data to a wider format with respect to <code>treamtment</code>. Then we sample from <code>rnorm()</code>, and then we can convert the data back to the long format with respect to <code>treatment</code>. Otherwise you’d have different draws for different levels of <code>.draw</code>, which I believe would bungle the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> m13<span class="fl">.4</span> <span class="sc">|&gt;</span> </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a_bar, sigma_a, b[treatment]) <span class="sc">|&gt;</span> </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> treatment, <span class="at">values_from =</span> b) <span class="sc">|&gt;</span> </span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_sim =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> a_bar, <span class="at">sd =</span> sigma_a)) <span class="sc">|&gt;</span> </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="st">`</span><span class="at">1</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">4</span><span class="st">`</span>, <span class="at">values_to =</span> <span class="st">"b"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">as.integer</span>(name)) <span class="sc">|&gt;</span> </span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(a_sim <span class="sc">+</span> b)) <span class="sc">|&gt;</span> </span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> p)) <span class="sc">+</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">point_interval =</span> mean_qi, <span class="at">.width =</span> <span class="fl">0.80</span>, </span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="st">"gray67"</span>) <span class="sc">+</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> treatment_labels_vec) <span class="sc">+</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"marginal of actor"</span>)</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid" width="192"></p>
</div>
</div>
<p>To simulate actors for the left panel of Figure 13.7, our basic data-wrangling workflow will be similar to what we just did. This time we’ll use the <code>ndraws</code> argument within <code>spread_draws()</code> to randomly sample a subset of the 4,000 post-warmup posterior draws in the posterior, rather than use them all. When we plot, instead of summarizing the results with <code>stat_lineribbon()</code>, we just plot individual lines with <code>geom_line()</code>, and we use the <code>.draw</code> index as a stand-in for simulated actors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> m13<span class="fl">.4</span> <span class="sc">|&gt;</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(a_bar, sigma_a, b[treatment], <span class="at">ndraws =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> treatment, <span class="at">values_from =</span> b) <span class="sc">|&gt;</span> </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_sim =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> a_bar, <span class="at">sd =</span> sigma_a)) <span class="sc">|&gt;</span> </span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="st">`</span><span class="at">1</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">4</span><span class="st">`</span>, <span class="at">values_to =</span> <span class="st">"b"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">as.integer</span>(name)) <span class="sc">|&gt;</span> </span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">plogis</span>(a_sim <span class="sc">+</span> b))  <span class="sc">|&gt;</span> </span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> treatment, <span class="at">y =</span> p, <span class="at">group =</span> .draw)) <span class="sc">+</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">labels =</span> treatment_labels_vec) <span class="sc">+</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"100 simulated actors"</span>)</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid" width="192"></p>
</div>
</div>
<p>Here’s the complete version of Figure 13.7.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid" width="576"></p>
</div>
</div>
</section>
<section id="post-stratification." class="level3" data-number="13.5.3">
<h3 data-number="13.5.3" class="anchored" data-anchor-id="post-stratification."><span class="header-section-number">13.5.3</span> Post-stratification.</h3>
</section>
</section>
<section id="summary-centered-non-centered-and-the-secret-third-parameterization" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="summary-centered-non-centered-and-the-secret-third-parameterization"><span class="header-section-number">13.6</span> <del>Summary</del> Centered, non-centered, and the secret third parameterization</h2>
<p>I’d like to spend some more time talking about how we parameterize multilevel models. To that end, let’s load the <code>reedfrogs</code> data once more.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(reedfrogs, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> reedfrogs <span class="sc">|&gt;</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a the `tank` cluster variable</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tank =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(reedfrogs)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 48
Columns: 6
$ density  &lt;int&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 1…
$ pred     &lt;fct&gt; no, no, no, no, no, no, no, no, pred, pred, pred, pred, pred,…
$ size     &lt;fct&gt; big, big, big, big, small, small, small, small, big, big, big…
$ surv     &lt;int&gt; 9, 10, 7, 10, 9, 9, 10, 9, 4, 9, 7, 6, 7, 5, 9, 9, 24, 23, 22…
$ propsurv &lt;dbl&gt; 0.90, 1.00, 0.70, 1.00, 0.90, 0.90, 1.00, 0.90, 0.40, 0.90, 0…
$ tank     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…</code></pre>
</div>
</div>
<p>Again we make the <code>stan_data</code> version of the data for <strong>rstan</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(surv, density, tank) <span class="sc">|&gt;</span> </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ surv   : int [1:48(1d)] 9 10 7 10 9 9 10 9 4 9 ...
 $ density: int [1:48(1d)] 10 10 10 10 10 10 10 10 10 10 ...
 $ tank   : int [1:48(1d)] 1 2 3 4 5 6 7 8 9 10 ...
 $ n      : int 48</code></pre>
</div>
</div>
<p>In <a href="#sec-Example-Multilevel-tadpoles"><span>Section&nbsp;13.1</span></a> when we fit the multilevel reedfrogs model, we used the centered parameterization. The equation for that model was</p>
<p><span class="math display">\[
\begin{align*}
\text{surv}_i &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_i \\
\alpha_i    &amp; \sim \operatorname{Normal}(\bar \alpha, \sigma) \\
\bar \alpha &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma      &amp; \sim \operatorname{Exponential}(1),
\end{align*}
\]</span></p>
<p>where this time for simplicity sake I’m just calling what McElreath denoted <span class="math inline">\(\alpha_{\text{tank}[i]}\)</span> as <span class="math inline">\(\alpha_i\)</span>, and I’m also replacing McElreath’s somewhat unnecessarily confusing prior notation <span class="math inline">\(\alpha_j\)</span> with <span class="math inline">\(\alpha_i\)</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> We didn’t fit a non-centered version of this model, but if we had, I believe we could have described it in statistical notation as</p>
<p><span class="math display">\[
\begin{align*}
\text{surv}_i &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_i \\
\alpha_i &amp; = \color{blue}{\bar \alpha + z_i \sigma} \\
\bar \alpha       &amp; \sim \operatorname{Normal}(0, 1.5) \\
\color{blue}{z_i} &amp; \sim \color{blue}{\operatorname{Normal}(0, 1)} \\
\sigma            &amp; \sim \operatorname{Exponential}(1),
\end{align*}
\]</span></p>
<p>for which we have taken cues from the statistical notation McElreath used for <code>m13.4nc</code> on page 424 in the text, and I then repeated in <a href="#sec-Non-centered-chimpanzees"><span>Section&nbsp;13.4.3</span></a>, above. We’ll fit this version of the model with <strong>rstan</strong> in a bit.</p>
<p>There are other ways to parameterize the model, though. For a nice exposition, Gelman and Hill discussed at least five in Section 12.5 their <span class="citation" data-cites="gelmanDataAnalysisUsing2006">(<a href="references.html#ref-gelmanDataAnalysisUsing2006" role="doc-biblioref">2006</a>)</span> text. The one I’d like to introduce comes most directly from the notation used throughout <span class="citation" data-cites="singerAppliedLongitudinalData2003">Singer &amp; Willett (<a href="references.html#ref-singerAppliedLongitudinalData2003" role="doc-biblioref">2003</a>)</span>, which is the text from which I first learned about multilevel models.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> I don’t know what to call this parameterization, but to stick with the language McElreath has used in this chapter, we’ll tentatively dub it the <em>semi-centered</em> parameterization,<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> which is</p>
<p><span class="math display">\[
\begin{align*}
\text{surv}_i &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_i \\
\alpha_i &amp; = \bar \alpha + \color{blue}{u_i} \\
\color{blue}{u_i} &amp; \sim \color{blue}{\operatorname{Normal}(0, \sigma)} \\
\bar \alpha       &amp; \sim \operatorname{Normal}(0, 1.5) \\
\sigma            &amp; \sim \operatorname{Exponential}(1),
\end{align*}
\]</span></p>
<p>where the new <span class="math inline">\(\color{blue}{u_i}\)</span> terms are deviations around the grand mean <span class="math inline">\(\bar \alpha\)</span>, but unlike the <span class="math inline">\(z_i\)</span> deviation terms in the previous model, the <span class="math inline">\(\color{blue}{u_i}\)</span> terms are not given a unit-normal prior. Rather, they are distributed as Gaussian with a fixed mean at zero, but a standard deviation <span class="math inline">\(\color{blue} \sigma\)</span>, which is itself estimated from the data. In the language of Singer and Willett, you might think of the first two lines of the equation at the level-1 likelihood, and the third and fourth lines as the level-2 likelihood. The rest are priors.</p>
<p>Since we’re going to be comparing these three parameterizations, I’m going to first sample more draws from the original centered <code>m13.2</code> to help reduce the effect of MCMC sampling variation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">sampling</span>(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> m13<span class="fl">.2</span><span class="sc">@</span>stanmodel,</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">8500</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we make the <code>model_code_13.2nc</code> and <code>model_code_13.2sc</code> strings for the non-centered and semi-centered version of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.2</span>nc <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int tank;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int density;</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int surv;</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real abar;</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] z;</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="st">  surv ~ binomial(density, inv_logit(abar + z[tank] * sigma));</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="st">  abar ~ normal(0, 1.5);</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a><span class="st">  z ~ normal(0, 1);</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ exponential(1);</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = binomial_lpmf(surv[i] | density[i], inv_logit(abar + z[tank[i]] * sigma));</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a;</span></span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a><span class="st">  a = abar + z * sigma;</span></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>model_code_13<span class="fl">.2</span>sc <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;                       </span></span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int tank;</span></span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int density;</span></span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int surv;</span></span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a><span class="st">  real abar;</span></span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] u;</span></span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a = abar + u;</span></span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a><span class="st">  surv ~ binomial(density, inv_logit(a));  // Level-1 likelihood</span></span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a><span class="st">  u ~ normal(0, sigma);                    // Level-2 likelihood</span></span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a><span class="st">  abar ~ normal(0, 1.5);</span></span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ exponential(1);</span></span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] a;</span></span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a><span class="st">  a = abar + u;</span></span>
<span id="cb111-52"><a href="#cb111-52" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-53"><a href="#cb111-53" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb111-54"><a href="#cb111-54" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:n) log_lik[i] = binomial_lpmf(surv[i] | density[i], inv_logit(a[i]));</span></span>
<span id="cb111-55"><a href="#cb111-55" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-56"><a href="#cb111-56" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now sample from the non-centered and semi-centered posteriors with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.2</span>nc <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.2</span>nc, </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">8500</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>m13<span class="fl">.2</span>sc <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code_13<span class="fl">.2</span>sc, </span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">8500</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the sake of space, I’m not going to show the <code>print()</code> output for these. But if you’re following along on your computer, it’s work giving a look.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.2</span>, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"abar"</span>, <span class="st">"sigma"</span>, <span class="st">"a[1]"</span>, <span class="st">"a[48]"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.2</span>nc, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"abar"</span>, <span class="st">"sigma"</span>, <span class="st">"a[1]"</span>, <span class="st">"a[48]"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m13<span class="fl">.2</span>sc, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"abar"</span>, <span class="st">"sigma"</span>, <span class="st">"a[1]"</span>, <span class="st">"a[48]"</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here instead we’ll compare the three parameterizations by the major model parameters, <span class="math inline">\(\bar a\)</span>, <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(a_i\)</span>, with a coefficient plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>par_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"abar"</span>, <span class="st">"sigma"</span>, <span class="fu">str_c</span>(<span class="st">"a["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="st">"]"</span>), <span class="fu">str_c</span>(<span class="st">"a["</span>, <span class="dv">10</span><span class="sc">:</span><span class="dv">48</span>, <span class="st">"]"</span>))</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(m13<span class="fl">.2</span>),</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(m13<span class="fl">.2</span>nc),</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(m13<span class="fl">.2</span>sc)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(par_vec) <span class="sc">|&gt;</span> </span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">parameterization =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"centered"</span>, <span class="st">"non-centered"</span>, <span class="st">"semi-centered"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">3</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>parameterization, <span class="at">names_to =</span> <span class="st">"par"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">par =</span> <span class="fu">factor</span>(par, <span class="at">levels =</span> par_vec)) <span class="sc">|&gt;</span> </span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> par, <span class="at">color =</span> parameterization)) <span class="sc">+</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">.width =</span> <span class="fl">0.89</span>, </span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">point_size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="sc">-</span><span class="fl">0.7</span>)) <span class="sc">+</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"C"</span>, <span class="at">end =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"posterior"</span>,</span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>They’re all the same with MCMC simulation error.</p>
<p>Here we compare the three versions of the model by their HMC convergence statistics in a faceted dot plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(m13<span class="fl">.2</span>, <span class="fu">default_convergence_measures</span>()),</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(m13<span class="fl">.2</span>nc, <span class="fu">default_convergence_measures</span>()),</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(m13<span class="fl">.2</span>sc, <span class="fu">default_convergence_measures</span>())</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> par_vec) <span class="sc">|&gt;</span> </span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">parameterization =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"centered"</span>, <span class="st">"non-centered"</span>, <span class="st">"semi-centered"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">3</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(rhat<span class="sc">:</span>ess_tail, <span class="at">names_to =</span> <span class="st">"stat"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> <span class="fu">fct_rev</span>(parameterization), </span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> parameterization, <span class="at">fill =</span> parameterization)) <span class="sc">+</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_dots</span>() <span class="sc">+</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"C"</span>, <span class="at">end =</span> <span class="fl">0.7</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">"C"</span>, <span class="at">end =</span> <span class="fl">0.7</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> stat, <span class="at">scales =</span> <span class="st">"free_x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="13_files/figure-html/unnamed-chunk-87-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>I’m not interested in making claims about one being better than the others, but it’s good to have options, and I’m glad to add one more to the mix. I’ve been low-key chewing on this for like five years, and it feels good to finally clarify my thoughts in words and code.</p>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.0 (2024-04-24)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] posterior_1.6.0    bayesplot_1.11.1   patchwork_1.2.0    loo_2.8.0         
 [5] rstan_2.32.6       StanHeaders_2.32.7 tidybayes_3.0.6    lubridate_1.9.3   
 [9] forcats_1.0.0      stringr_1.5.1      dplyr_1.1.4        purrr_1.0.2       
[13] readr_2.1.5        tidyr_1.3.1        tibble_3.2.1       ggplot2_3.5.1     
[17] tidyverse_2.0.0   

loaded via a namespace (and not attached):
 [1] gtable_0.3.5         tensorA_0.36.2.1     xfun_0.43           
 [4] QuickJSR_1.1.3       htmlwidgets_1.6.4    inline_0.3.19       
 [7] lattice_0.22-6       tzdb_0.4.0           quadprog_1.5-8      
[10] vctrs_0.6.5          tools_4.4.0          generics_0.1.3      
[13] stats4_4.4.0         curl_5.2.1           parallel_4.4.0      
[16] fansi_1.0.6          pkgconfig_2.0.3      checkmate_2.3.1     
[19] distributional_0.4.0 RcppParallel_5.1.7   lifecycle_1.0.4     
[22] farver_2.1.1         compiler_4.4.0       munsell_0.5.1       
[25] codetools_0.2-20     htmltools_0.5.8.1    yaml_2.3.8          
[28] pillar_1.9.0         arrayhelpers_1.1-0   abind_1.4-5         
[31] tidyselect_1.2.1     digest_0.6.35        svUnit_1.0.6        
[34] stringi_1.8.4        reshape2_1.4.4       labeling_0.4.3      
[37] fastmap_1.1.1        grid_4.4.0           colorspace_2.1-0    
[40] cli_3.6.3            magrittr_2.0.3       pkgbuild_1.4.4      
[43] utf8_1.2.4           withr_3.0.0          scales_1.3.0        
[46] backports_1.5.0      timechange_0.3.0     rmarkdown_2.26      
[49] matrixStats_1.3.0    gridExtra_2.3        hms_1.1.3           
[52] coda_0.19-4.1        evaluate_0.23        knitr_1.46          
[55] V8_4.4.2             ggdist_3.3.2         viridisLite_0.4.2   
[58] rlang_1.1.4          Rcpp_1.0.12          glue_1.7.0          
[61] rstudioapi_0.16.0    jsonlite_1.8.8       plyr_1.8.9          
[64] R6_2.5.1            </code></pre>
</div>
</div>
</section>
<section id="comments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="comments">Comments</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="list" style="display: none">
<div id="ref-gelmanDataAnalysisUsing2006" class="csl-entry" role="listitem">
Gelman, A., &amp; Hill, J. (2006). <em>Data analysis using regression and multilevel/hierarchical models</em>. Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511790942">https://doi.org/10.1017/CBO9780511790942</a>
</div>
<div id="ref-singerAppliedLongitudinalData2003" class="csl-entry" role="listitem">
Singer, J. D., &amp; Willett, J. B. (2003). <em>Applied longitudinal data analysis: <span>Modeling</span> change and event occurrence</em>. Oxford University Press, USA. <a href="https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968">https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968</a>
</div>
<div id="ref-voneshCompensatoryLarvalResponses2005" class="csl-entry" role="listitem">
Vonesh, J. R., &amp; Bolker, B. M. (2005). Compensatory larval responses shift trade-offs associated with predator-induced hatching plasticity. <em>Ecology</em>, <em>86</em>(6), 1580–1591. <a href="https://doi.org/10.1890/04-0535">https://doi.org/10.1890/04-0535</a>
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>I should acknowledge there are many other cases where McElreath’s more elaborate notation would be necessary. But in this special case, it’s not and I’m concerned it would get in the way of the basic points I’m trying to make in this section.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>You can also find this notation in Equation 12.6 in <span class="citation" data-cites="gelmanDataAnalysisUsing2006">Gelman &amp; Hill (<a href="references.html#ref-gelmanDataAnalysisUsing2006" role="doc-biblioref">2006</a>)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Go <a href="https://x.com/SolomonKurz/status/1833922891588796644">here</a> for a nice Twitter discussion on this parameterization. Doctoral candidate <a href="https://franfrutos.github.io/">Francisco Garre-Frutos</a> was the first person to suggest the term. We even got the official Stan account to weigh in on the topic (e.g., <a href="https://x.com/mcmc_stan/status/1833941708112789872">here</a>).<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="ASKurz/Statistical_Rethinking_2_with_rstan" data-repo-id="R_kgDOMeljUg" data-category="General" data-category-id="DIC_kwDOMeljUs4ChZXD" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./12.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>