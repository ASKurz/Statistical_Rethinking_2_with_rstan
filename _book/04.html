<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical rethinking 2 with rstan and the tidyverse - 4&nbsp; Geocentric Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05.html" rel="next">
<link href="./03.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Statistical rethinking</em> 2 with rstan and the tidyverse</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ASKurz/Statistical_Rethinking_2_with_rstan" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Golem of Prague</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Small Worlds and Large Worlds</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Haunted DAG &amp; The Causal Terror</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ulysses’ Compass</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conditional Manatees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Big Entropy and the Generalized Linear Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">God Spiked the Integers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Monsters and Mixtures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#why-normal-distributions-are-normal" id="toc-why-normal-distributions-are-normal" class="nav-link active" data-scroll-target="#why-normal-distributions-are-normal"><span class="header-section-number">4.1</span> Why normal distributions are normal</a>
  <ul>
  <li><a href="#normal-by-addition." id="toc-normal-by-addition." class="nav-link" data-scroll-target="#normal-by-addition."><span class="header-section-number">4.1.1</span> Normal by addition.</a></li>
  <li><a href="#normal-by-multiplication." id="toc-normal-by-multiplication." class="nav-link" data-scroll-target="#normal-by-multiplication."><span class="header-section-number">4.1.2</span> Normal by multiplication.</a></li>
  <li><a href="#normal-by-log-multiplication." id="toc-normal-by-log-multiplication." class="nav-link" data-scroll-target="#normal-by-log-multiplication."><span class="header-section-number">4.1.3</span> Normal by log-multiplication.</a></li>
  <li><a href="#using-gaussian-distributions." id="toc-using-gaussian-distributions." class="nav-link" data-scroll-target="#using-gaussian-distributions."><span class="header-section-number">4.1.4</span> Using Gaussian distributions.</a>
  <ul>
  <li><a href="#rethinking-heavy-tails." id="toc-rethinking-heavy-tails." class="nav-link" data-scroll-target="#rethinking-heavy-tails."><span class="header-section-number">4.1.4.1</span> Rethinking: Heavy tails.</a></li>
  <li><a href="#overthinking-gaussian-distribution." id="toc-overthinking-gaussian-distribution." class="nav-link" data-scroll-target="#overthinking-gaussian-distribution."><span class="header-section-number">4.1.4.2</span> Overthinking: Gaussian distribution.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#a-language-for-describing-models" id="toc-a-language-for-describing-models" class="nav-link" data-scroll-target="#a-language-for-describing-models"><span class="header-section-number">4.2</span> A language for describing models</a>
  <ul>
  <li><a href="#re-describing-the-globe-tossing-model." id="toc-re-describing-the-globe-tossing-model." class="nav-link" data-scroll-target="#re-describing-the-globe-tossing-model."><span class="header-section-number">4.2.1</span> Re-describing the globe tossing model.</a>
  <ul>
  <li><a href="#overthinking-from-model-definition-to-bayes-theorem." id="toc-overthinking-from-model-definition-to-bayes-theorem." class="nav-link" data-scroll-target="#overthinking-from-model-definition-to-bayes-theorem."><span class="header-section-number">4.2.1.1</span> Overthinking: From model definition to Bayes’ theorem.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#a-gaussian-model-of-height" id="toc-a-gaussian-model-of-height" class="nav-link" data-scroll-target="#a-gaussian-model-of-height"><span class="header-section-number">4.3</span> A Gaussian model of height</a>
  <ul>
  <li><a href="#the-data." id="toc-the-data." class="nav-link" data-scroll-target="#the-data."><span class="header-section-number">4.3.1</span> The data.</a>
  <ul>
  <li><a href="#overthinking-data-frames-and-indexes." id="toc-overthinking-data-frames-and-indexes." class="nav-link" data-scroll-target="#overthinking-data-frames-and-indexes."><span class="header-section-number">4.3.1.1</span> Overthinking: Data frames and indexes.</a></li>
  </ul></li>
  <li><a href="#the-model." id="toc-the-model." class="nav-link" data-scroll-target="#the-model."><span class="header-section-number">4.3.2</span> The model.</a>
  <ul>
  <li><a href="#rethinking-a-farewell-to-epsilon." id="toc-rethinking-a-farewell-to-epsilon." class="nav-link" data-scroll-target="#rethinking-a-farewell-to-epsilon."><span class="header-section-number">4.3.2.1</span> Rethinking: A farewell to epsilon.</a></li>
  <li><a href="#overthinking-model-definition-to-bayes-theorem-again." id="toc-overthinking-model-definition-to-bayes-theorem-again." class="nav-link" data-scroll-target="#overthinking-model-definition-to-bayes-theorem-again."><span class="header-section-number">4.3.2.2</span> Overthinking: Model definition to Bayes’ theorem again.</a></li>
  </ul></li>
  <li><a href="#grid-approximation-of-the-posterior-distribution." id="toc-grid-approximation-of-the-posterior-distribution." class="nav-link" data-scroll-target="#grid-approximation-of-the-posterior-distribution."><span class="header-section-number">4.3.3</span> Grid approximation of the posterior distribution.</a></li>
  <li><a href="#sampling-from-the-posterior." id="toc-sampling-from-the-posterior." class="nav-link" data-scroll-target="#sampling-from-the-posterior."><span class="header-section-number">4.3.4</span> Sampling from the posterior.</a>
  <ul>
  <li><a href="#overthinking-sample-size-and-the-normality-of-sigmas-posterior." id="toc-overthinking-sample-size-and-the-normality-of-sigmas-posterior." class="nav-link" data-scroll-target="#overthinking-sample-size-and-the-normality-of-sigmas-posterior."><span class="header-section-number">4.3.4.1</span> Overthinking: Sample size and the normality of <span class="math inline">\(\sigma\)</span>’s posterior.</a></li>
  </ul></li>
  <li><a href="#finding-the-posterior-distribution-with-quap-stan." id="toc-finding-the-posterior-distribution-with-quap-stan." class="nav-link" data-scroll-target="#finding-the-posterior-distribution-with-quap-stan."><span class="header-section-number">4.3.5</span> Finding the posterior distribution with <del><code>quap()</code></del> <code>stan()</code>.</a>
  <ul>
  <li><a href="#overthinking-start-values-for-quap-rstan." id="toc-overthinking-start-values-for-quap-rstan." class="nav-link" data-scroll-target="#overthinking-start-values-for-quap-rstan."><span class="header-section-number">4.3.5.1</span> Overthinking: Start values for <del>quap</del> <code>rstan()</code>.</a></li>
  </ul></li>
  <li><a href="#sampling-from-a-quap-stan." id="toc-sampling-from-a-quap-stan." class="nav-link" data-scroll-target="#sampling-from-a-quap-stan."><span class="header-section-number">4.3.6</span> Sampling from a <del><code>quap()</code></del> <code>stan()</code>.</a>
  <ul>
  <li><a href="#overthinking-under-the-hood-with-multivariate-sampling." id="toc-overthinking-under-the-hood-with-multivariate-sampling." class="nav-link" data-scroll-target="#overthinking-under-the-hood-with-multivariate-sampling."><span class="header-section-number">4.3.6.1</span> Overthinking: Under the hood with multivariate sampling.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#linear-prediction" id="toc-linear-prediction" class="nav-link" data-scroll-target="#linear-prediction"><span class="header-section-number">4.4</span> Linear prediction</a>
  <ul>
  <li><a href="#rethinking-what-is-regression" id="toc-rethinking-what-is-regression" class="nav-link" data-scroll-target="#rethinking-what-is-regression"><span class="header-section-number">4.4.0.1</span> Rethinking: What is “regression”?</a></li>
  <li><a href="#the-linear-model-strategy." id="toc-the-linear-model-strategy." class="nav-link" data-scroll-target="#the-linear-model-strategy."><span class="header-section-number">4.4.1</span> The linear model strategy.</a>
  <ul>
  <li><a href="#probability-of-the-data." id="toc-probability-of-the-data." class="nav-link" data-scroll-target="#probability-of-the-data."><span class="header-section-number">4.4.1.1</span> Probability of the data.</a></li>
  <li><a href="#linear-model." id="toc-linear-model." class="nav-link" data-scroll-target="#linear-model."><span class="header-section-number">4.4.1.2</span> Linear model.</a>
  <ul class="collapse">
  <li><a href="#rethinking-nothing-special-or-natural-about-linear-models." id="toc-rethinking-nothing-special-or-natural-about-linear-models." class="nav-link" data-scroll-target="#rethinking-nothing-special-or-natural-about-linear-models."><span class="header-section-number">4.4.1.2.1</span> Rethinking: Nothing special or natural about linear models.</a></li>
  <li><a href="#overthinking-units-and-regression-models." id="toc-overthinking-units-and-regression-models." class="nav-link" data-scroll-target="#overthinking-units-and-regression-models."><span class="header-section-number">4.4.1.2.2</span> Overthinking: Units and regression models.</a></li>
  </ul></li>
  <li><a href="#priors." id="toc-priors." class="nav-link" data-scroll-target="#priors."><span class="header-section-number">4.4.1.3</span> Priors.</a>
  <ul class="collapse">
  <li><a href="#rethinking-whats-the-correct-prior" id="toc-rethinking-whats-the-correct-prior" class="nav-link" data-scroll-target="#rethinking-whats-the-correct-prior"><span class="header-section-number">4.4.1.3.1</span> Rethinking: What’s the correct prior?</a></li>
  <li><a href="#rethinking-prior-predictive-simulation-and-p-hacking." id="toc-rethinking-prior-predictive-simulation-and-p-hacking." class="nav-link" data-scroll-target="#rethinking-prior-predictive-simulation-and-p-hacking."><span class="header-section-number">4.4.1.3.2</span> Rethinking: Prior predictive simulation and <span class="math inline">\(p\)</span>-hacking.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#finding-the-posterior-distribution." id="toc-finding-the-posterior-distribution." class="nav-link" data-scroll-target="#finding-the-posterior-distribution."><span class="header-section-number">4.4.2</span> Finding the posterior distribution.</a>
  <ul>
  <li><a href="#rethinking-everything-that-depends-upon-parameters-has-a-posterior-distribution." id="toc-rethinking-everything-that-depends-upon-parameters-has-a-posterior-distribution." class="nav-link" data-scroll-target="#rethinking-everything-that-depends-upon-parameters-has-a-posterior-distribution."><span class="header-section-number">4.4.2.1</span> Rethinking: Everything that depends upon parameters has a posterior distribution.</a></li>
  <li><a href="#overthinking-logs-and-exps-oh-my." id="toc-overthinking-logs-and-exps-oh-my." class="nav-link" data-scroll-target="#overthinking-logs-and-exps-oh-my."><span class="header-section-number">4.4.2.2</span> Overthinking: Logs and exps, oh my.</a></li>
  </ul></li>
  <li><a href="#interpreting-the-posterior-distribution." id="toc-interpreting-the-posterior-distribution." class="nav-link" data-scroll-target="#interpreting-the-posterior-distribution."><span class="header-section-number">4.4.3</span> Interpreting the posterior distribution.</a>
  <ul>
  <li><a href="#rethinking-what-do-parameters-mean" id="toc-rethinking-what-do-parameters-mean" class="nav-link" data-scroll-target="#rethinking-what-do-parameters-mean"><span class="header-section-number">4.4.3.0.1</span> Rethinking: What do parameters mean?</a></li>
  <li><a href="#tables-of-marginal-distributions." id="toc-tables-of-marginal-distributions." class="nav-link" data-scroll-target="#tables-of-marginal-distributions."><span class="header-section-number">4.4.3.1</span> Tables of marginal distributions.</a></li>
  <li><a href="#plotting-posterior-inference-against-the-data." id="toc-plotting-posterior-inference-against-the-data." class="nav-link" data-scroll-target="#plotting-posterior-inference-against-the-data."><span class="header-section-number">4.4.3.2</span> Plotting posterior inference against the data.</a></li>
  <li><a href="#adding-uncertainty-around-the-mean." id="toc-adding-uncertainty-around-the-mean." class="nav-link" data-scroll-target="#adding-uncertainty-around-the-mean."><span class="header-section-number">4.4.3.3</span> Adding uncertainty around the mean.</a></li>
  <li><a href="#plotting-regression-intervals-and-contours." id="toc-plotting-regression-intervals-and-contours." class="nav-link" data-scroll-target="#plotting-regression-intervals-and-contours."><span class="header-section-number">4.4.3.4</span> Plotting regression intervals and contours.</a>
  <ul class="collapse">
  <li><a href="#rethinking-overconfident-intervals." id="toc-rethinking-overconfident-intervals." class="nav-link" data-scroll-target="#rethinking-overconfident-intervals."><span class="header-section-number">4.4.3.4.1</span> Rethinking: Overconfident intervals.</a></li>
  <li><a href="#overthinking-how-link-works." id="toc-overthinking-how-link-works." class="nav-link" data-scroll-target="#overthinking-how-link-works."><span class="header-section-number">4.4.3.4.2</span> Overthinking: How <code>link</code> works.</a></li>
  </ul></li>
  <li><a href="#prediction-intervals." id="toc-prediction-intervals." class="nav-link" data-scroll-target="#prediction-intervals."><span class="header-section-number">4.4.3.5</span> Prediction intervals.</a>
  <ul class="collapse">
  <li><a href="#rethinking-two-kinds-of-uncertainty." id="toc-rethinking-two-kinds-of-uncertainty." class="nav-link" data-scroll-target="#rethinking-two-kinds-of-uncertainty."><span class="header-section-number">4.4.3.5.1</span> Rethinking: Two kinds of uncertainty.</a></li>
  <li><a href="#overthinking-rolling-your-own-sim." id="toc-overthinking-rolling-your-own-sim." class="nav-link" data-scroll-target="#overthinking-rolling-your-own-sim."><span class="header-section-number">4.4.3.5.2</span> Overthinking: Rolling your own <code>sim</code>.</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#curves-from-lines" id="toc-curves-from-lines" class="nav-link" data-scroll-target="#curves-from-lines"><span class="header-section-number">4.5</span> Curves from lines</a>
  <ul>
  <li><a href="#polynomial-regression." id="toc-polynomial-regression." class="nav-link" data-scroll-target="#polynomial-regression."><span class="header-section-number">4.5.1</span> Polynomial regression.</a>
  <ul>
  <li><a href="#rethinking-linear-additive-funky." id="toc-rethinking-linear-additive-funky." class="nav-link" data-scroll-target="#rethinking-linear-additive-funky."><span class="header-section-number">4.5.1.0.1</span> Rethinking: Linear, additive, funky.</a></li>
  <li><a href="#overthinking-converting-back-to-natural-scale." id="toc-overthinking-converting-back-to-natural-scale." class="nav-link" data-scroll-target="#overthinking-converting-back-to-natural-scale."><span class="header-section-number">4.5.1.0.2</span> Overthinking: Converting back to natural scale.</a></li>
  </ul></li>
  <li><a href="#splines." id="toc-splines." class="nav-link" data-scroll-target="#splines."><span class="header-section-number">4.5.2</span> Splines.</a></li>
  <li><a href="#smooth-functions-for-a-rough-world." id="toc-smooth-functions-for-a-rough-world." class="nav-link" data-scroll-target="#smooth-functions-for-a-rough-world."><span class="header-section-number">4.5.3</span> Smooth functions for a rough world.</a></li>
  </ul></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/ASKurz/Statistical_Rethinking_2_with_rstan/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-Geocentric-Models" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geocentric Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Load the packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop grid lines</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="why-normal-distributions-are-normal" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="why-normal-distributions-are-normal"><span class="header-section-number">4.1</span> Why normal distributions are normal</h2>
<section id="normal-by-addition." class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="normal-by-addition."><span class="header-section-number">4.1.1</span> Normal by addition.</h3>
</section>
<section id="normal-by-multiplication." class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="normal-by-multiplication."><span class="header-section-number">4.1.2</span> Normal by multiplication.</h3>
</section>
<section id="normal-by-log-multiplication." class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="normal-by-log-multiplication."><span class="header-section-number">4.1.3</span> Normal by log-multiplication.</h3>
</section>
<section id="using-gaussian-distributions." class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="using-gaussian-distributions."><span class="header-section-number">4.1.4</span> Using Gaussian distributions.</h3>
<section id="rethinking-heavy-tails." class="level4" data-number="4.1.4.1">
<h4 data-number="4.1.4.1" class="anchored" data-anchor-id="rethinking-heavy-tails."><span class="header-section-number">4.1.4.1</span> Rethinking: Heavy tails.</h4>
</section>
<section id="overthinking-gaussian-distribution." class="level4" data-number="4.1.4.2">
<h4 data-number="4.1.4.2" class="anchored" data-anchor-id="overthinking-gaussian-distribution."><span class="header-section-number">4.1.4.2</span> Overthinking: Gaussian distribution.</h4>
</section>
</section>
</section>
<section id="a-language-for-describing-models" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="a-language-for-describing-models"><span class="header-section-number">4.2</span> A language for describing models</h2>
<section id="re-describing-the-globe-tossing-model." class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="re-describing-the-globe-tossing-model."><span class="header-section-number">4.2.1</span> Re-describing the globe tossing model.</h3>
<section id="overthinking-from-model-definition-to-bayes-theorem." class="level4" data-number="4.2.1.1">
<h4 data-number="4.2.1.1" class="anchored" data-anchor-id="overthinking-from-model-definition-to-bayes-theorem."><span class="header-section-number">4.2.1.1</span> Overthinking: From model definition to Bayes’ theorem.</h4>
<p>We can use grid approximation to work through our globe-tossing model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many `p_grid` points would you like?</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n_points <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_grid =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">length.out =</span> n_points),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">w =</span> <span class="dv">6</span>, </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior =</span> <span class="fu">dunif</span>(<span class="at">x =</span> p_grid, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">likelihood =</span> <span class="fu">dbinom</span>(<span class="at">x =</span> w, <span class="at">size =</span> n, <span class="at">prob =</span> p_grid)) <span class="sc">|&gt;</span> </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">posterior =</span> likelihood <span class="sc">*</span> prior <span class="sc">/</span> <span class="fu">sum</span>(likelihood <span class="sc">*</span> prior))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  p_grid     w     n prior likelihood posterior
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
1 0          6     9     1   0         0       
2 0.0101     6     9     1   8.65e-11  8.74e-12
3 0.0202     6     9     1   5.37e- 9  5.43e-10
4 0.0303     6     9     1   5.93e- 8  5.99e- 9
5 0.0404     6     9     1   3.23e- 7  3.26e- 8
6 0.0505     6     9     1   1.19e- 6  1.21e- 7</code></pre>
</div>
</div>
<p>In case you were curious, here’s what they look like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(prior<span class="sc">:</span>posterior) <span class="sc">|&gt;</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"likelihood"</span>, <span class="st">"posterior"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p_grid, <span class="at">y =</span> value, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"purple"</span>), <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"probability grid"</span>) <span class="sc">+</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
</section>
</section>
<section id="a-gaussian-model-of-height" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="a-gaussian-model-of-height"><span class="header-section-number">4.3</span> A Gaussian model of height</h2>
<section id="the-data." class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="the-data."><span class="header-section-number">4.3.1</span> The data.</h3>
<p>Load the <code>Howell1</code> data <span class="citation" data-cites="howell2001demography howell2010life">(<a href="references.html#ref-howell2001demography" role="doc-biblioref">Howell, 2001</a>, <a href="references.html#ref-howell2010life" role="doc-biblioref">2010</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Howell1, <span class="at">package =</span> <span class="st">"rethinking"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> Howell1</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(Howell1)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   544 obs. of  4 variables:
 $ height: num  152 140 137 157 145 ...
 $ weight: num  47.8 36.5 31.9 53 41.3 ...
 $ age   : num  63 63 65 41 51 35 32 27 19 54 ...
 $ male  : int  1 0 0 1 0 1 0 1 0 1 ...</code></pre>
</div>
</div>
<p>I’m not aware of a <code>precis()</code> function for numeric and graphical summaries of variables outside of McElreath’s <strong>rethinking</strong> package. We can, at least, get some of that information with <code>summary()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     height           weight            age             male       
 Min.   : 53.98   Min.   : 4.252   Min.   : 0.00   Min.   :0.0000  
 1st Qu.:125.09   1st Qu.:22.008   1st Qu.:12.00   1st Qu.:0.0000  
 Median :148.59   Median :40.058   Median :27.00   Median :0.0000  
 Mean   :138.26   Mean   :35.611   Mean   :29.34   Mean   :0.4724  
 3rd Qu.:157.48   3rd Qu.:47.209   3rd Qu.:43.00   3rd Qu.:1.0000  
 Max.   :179.07   Max.   :62.993   Max.   :88.00   Max.   :1.0000  </code></pre>
</div>
</div>
<p>We might make the histograms like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"height"</span>, <span class="st">"weight"</span>, <span class="st">"age"</span>, <span class="st">"male"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="336"></p>
</div>
</div>
<p>If you’re curious, McElreath made those tiny histograms with help from Wickham’s <a href="https://github.com/hadley/precis/blob/master/R/histospark.R"><code>histospark()</code> function</a>. Here’s the code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sparks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"\u2581"</span>, <span class="st">"\u2582"</span>, <span class="st">"\u2583"</span>, <span class="st">"\u2585"</span>, <span class="st">"\u2587"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>histospark <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">width =</span> <span class="dv">10</span>) {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> graphics<span class="sc">::</span><span class="fu">hist</span>(x, <span class="at">breaks =</span> width, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  factor <span class="ot">&lt;-</span> <span class="fu">cut</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    bins<span class="sc">$</span>counts <span class="sc">/</span> <span class="fu">max</span>(bins<span class="sc">$</span>counts),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="fu">length</span>(sparks) <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> sparks,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">include.lowest =</span> <span class="cn">TRUE</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(factor, <span class="at">collapse =</span> <span class="st">""</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s how it works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">histospark</span>(d<span class="sc">$</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "▁▂▃▂▂▂▂▅▇▇▃▂▁"</code></pre>
</div>
</div>
<p>We can use the <code>dplyr::filter()</code> function to make an adults-only data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our reduced <code>d2</code> does indeed have <span class="math inline">\(n = 352\)</span> cases.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span>  </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    n
1 352</code></pre>
</div>
</div>
<section id="overthinking-data-frames-and-indexes." class="level4" data-number="4.3.1.1">
<h4 data-number="4.3.1.1" class="anchored" data-anchor-id="overthinking-data-frames-and-indexes."><span class="header-section-number">4.3.1.1</span> Overthinking: Data frames and indexes.</h4>
</section>
</section>
<section id="the-model." class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="the-model."><span class="header-section-number">4.3.2</span> The model.</h3>
<p>The likelihood for our model is</p>
<p><span class="math display">\[\text{heights}_i \sim \operatorname{Normal}(\mu, \sigma),\]</span></p>
<p>where the <span class="math inline">\(i\)</span> subscript indexes the individual cases in the data. Our two parameters are <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, which we will estimate using Bayes’ formula. Our prior for <span class="math inline">\(\mu\)</span> will be</p>
<p><span class="math display">\[\mu \sim \operatorname{Normal}(178, 20),\]</span></p>
<p>and our prior for <span class="math inline">\(\sigma\)</span> will be</p>
<p><span class="math display">\[\sigma \sim \operatorname{Uniform}(0, 50).\]</span></p>
<p>Here’s the shape of the prior for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\mathcal N(178, 20)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">100</span>, <span class="at">to =</span> <span class="dv">250</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dnorm</span>(<span class="at">x =</span> x, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">100</span>, <span class="at">to =</span> <span class="dv">250</span>, <span class="at">by =</span> <span class="dv">75</span>)) <span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"mu ~ dnorm(178, 20)"</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>And here’s the <strong>ggplot2</strong> code for <span class="math inline">\(p(\sigma)\)</span>, a uniform distribution with a minimum value of 0 and a maximum value of 50. We don’t really need the <span class="math inline">\(y\)</span>-axis when looking at the shapes of a density, so we’ll just remove it with <code>scale_y_continuous()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">to =</span> <span class="dv">60</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dunif</span>(<span class="at">x =</span> x, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"sigma ~ dunif(0, 50)"</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>We can simulate from both priors at once to get a prior probability distribution of <code>heights</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e4</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">sample_mu    =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd  =</span> <span class="dv">20</span>),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">sample_sigma =</span> <span class="fu">runif</span>(<span class="at">n =</span> n, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n, <span class="at">mean =</span> sample_mu, <span class="at">sd =</span> sample_sigma))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> sim<span class="sc">|&gt;</span> </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> height)) <span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey33"</span>) <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">73</span>, <span class="dv">178</span>, <span class="dv">283</span>)) <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"height ~ dnorm(mu, sigma)"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>If you look at the <span class="math inline">\(x\)</span>-axis breaks on the plot in McElreath’s lower left panel in Figure 4.3, you’ll notice they’re intentional. To compute the mean and 3 standard deviations above and below, you might do this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sim <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower =</span> <span class="fu">mean</span>(height) <span class="sc">-</span> <span class="fu">sd</span>(height) <span class="sc">*</span> <span class="dv">3</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean  =</span> <span class="fu">mean</span>(height),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper =</span> <span class="fu">mean</span>(height) <span class="sc">+</span> <span class="fu">sd</span>(height) <span class="sc">*</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(round, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  lower  mean upper
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  73.9  177.  281.</code></pre>
</div>
</div>
<p>Our values are very close to his, but are off by just a bit due to simulation variation.</p>
<p>Here’s the work to make the lower right panel of Figure 4.3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">sample_mu    =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">100</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">sample_sigma =</span> <span class="fu">runif</span>(<span class="at">n =</span> n, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n, <span class="at">mean =</span> sample_mu, <span class="at">sd =</span> sample_sigma))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the values we'll use to break on our x axis</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(sim<span class="sc">$</span>height) <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">*</span> <span class="fu">sd</span>(sim<span class="sc">$</span>height), <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">0</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This is just for aesthetics</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">272</span> <span class="sc">-</span> <span class="dv">25</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">y      =</span> <span class="fl">0.0013</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">label  =</span> <span class="st">"tallest man"</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle  =</span> <span class="dv">90</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> sim <span class="sc">|&gt;</span> </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> height)) <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">272</span>, <span class="at">color =</span> <span class="st">"grey92"</span>, <span class="at">linetype =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">label =</span> label, <span class="at">angle =</span> angle),</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> breaks) <span class="sc">+</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"height ~ dnorm(mu, sigma)</span><span class="sc">\n</span><span class="st">mu ~ dnorm(178, 100)"</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>p4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>You may have noticed how we were saving each of the four last plots as <code>p1</code> through <code>p4</code>. Let’s combine the four to make our version of McElreath’s Figure 4.3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"mu"</span>) <span class="sc">|</span> p2 <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"sigma"</span>)) <span class="sc">/</span> (p3 <span class="sc">|</span> p4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>On page 84, McElreath said his prior simulation indicated 4% of the heights would be below zero. Here’s how we might determine that percentage for our simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sim <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(height <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> <span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  `height &lt; 0`     n percent
  &lt;lgl&gt;        &lt;int&gt;   &lt;dbl&gt;
1 FALSE         9571   95.7 
2 TRUE           429    4.29</code></pre>
</div>
</div>
<p>Here’s the break down compared to the tallest man on record, <a href="https://en.wikipedia.org/wiki/Robert_Wadlow">Robert Pershing Wadlow</a> (1918–1940).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sim <span class="sc">|&gt;</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(height <span class="sc">&lt;</span> <span class="dv">272</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> <span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  `height &lt; 272`     n percent
  &lt;lgl&gt;          &lt;int&gt;   &lt;dbl&gt;
1 FALSE           1761    17.6
2 TRUE            8239    82.4</code></pre>
</div>
</div>
<section id="rethinking-a-farewell-to-epsilon." class="level4" data-number="4.3.2.1">
<h4 data-number="4.3.2.1" class="anchored" data-anchor-id="rethinking-a-farewell-to-epsilon."><span class="header-section-number">4.3.2.1</span> Rethinking: A farewell to epsilon.</h4>
</section>
<section id="overthinking-model-definition-to-bayes-theorem-again." class="level4" data-number="4.3.2.2">
<h4 data-number="4.3.2.2" class="anchored" data-anchor-id="overthinking-model-definition-to-bayes-theorem-again."><span class="header-section-number">4.3.2.2</span> Overthinking: Model definition to Bayes’ theorem again.</h4>
</section>
</section>
<section id="grid-approximation-of-the-posterior-distribution." class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="grid-approximation-of-the-posterior-distribution."><span class="header-section-number">4.3.3</span> Grid approximation of the posterior distribution.</h3>
<p>This can be a handy preparatory step before we fit the model with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu    =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">140</span>, <span class="at">to =</span> <span class="dv">160</span>, <span class="at">length.out =</span> n),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">4</span>, <span class="at">to =</span> <span class="dv">9</span>, <span class="at">length.out =</span> n))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 40,000
Columns: 2
$ mu    &lt;dbl&gt; 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140,…
$ sigma &lt;dbl&gt; 4.000000, 4.025126, 4.050251, 4.075377, 4.100503, 4.125628, 4.15…</code></pre>
</div>
</div>
<p><code>d_grid</code> contains every combination of <code>mu</code> and <code>sigma</code> across their specified values. Instead of base-<strong>R</strong> <code>sapply()</code>, we’ll do the computations by making a custom function which we’ll then plug into <code>purrr::map2()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>grid_function <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(<span class="at">x =</span> d2<span class="sc">$</span>height, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’re ready to complete the tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_likelihood =</span> <span class="fu">map2</span>(<span class="at">.x =</span> mu, <span class="at">.y =</span> sigma, <span class="at">.f =</span> grid_function)) <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(log_likelihood) <span class="sc">|&gt;</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior_mu    =</span> <span class="fu">dnorm</span>(<span class="at">x =</span> mu, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>, <span class="at">log =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">prior_sigma =</span> <span class="fu">dunif</span>(<span class="at">x =</span> sigma, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">product =</span> log_likelihood <span class="sc">+</span> prior_mu <span class="sc">+</span> prior_sigma) <span class="sc">|&gt;</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probability =</span> <span class="fu">exp</span>(product <span class="sc">-</span> <span class="fu">max</span>(product)))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
     mu sigma log_likelihood prior_mu prior_sigma product probability
  &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;
1   140  4            -3813.    -5.72       -3.91  -3822.           0
2   140  4.03         -3778.    -5.72       -3.91  -3787.           0
3   140  4.05         -3743.    -5.72       -3.91  -3753.           0
4   140  4.08         -3709.    -5.72       -3.91  -3719.           0
5   140  4.10         -3676.    -5.72       -3.91  -3686.           0
6   140  4.13         -3644.    -5.72       -3.91  -3653.           0</code></pre>
</div>
</div>
<p>In the final <code>d_grid</code>, the <code>probability</code> vector contains the posterior probabilities across values of <code>mu</code> and <code>sigma</code>. We can make a contour plot with <code>geom_contour()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma, <span class="at">z =</span> probability)) <span class="sc">+</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_contour</span>() <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma)) <span class="sc">+</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d_grid<span class="sc">$</span>mu),</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d_grid<span class="sc">$</span>sigma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>We’ll make our heat map with <code>geom_raster()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma, <span class="at">fill =</span> probability)) <span class="sc">+</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(<span class="at">interpolate =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"B"</span>) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="sampling-from-the-posterior." class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="sampling-from-the-posterior."><span class="header-section-number">4.3.4</span> Sampling from the posterior.</h3>
<p>We can use <code>dplyr::sample_n()</code> to sample rows, with replacement, from <code>d_grid</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="fl">1e4</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">weight =</span> probability)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma)) <span class="sc">+</span> </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.9</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu[samples]),</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma[samples]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>We can use <code>pivot_longer()</code> and then <code>facet_wrap()</code> to plot the densities for both <code>mu</code> and <code>sigma</code> at once.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey33"</span>) <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">labeller =</span> label_parsed, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<p>We’ll use the <strong>tidybayes</strong> package to compute their posterior modes and 95% HDIs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mode_hdi</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  name   value .lower .upper .width .point .interval
  &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 mu    155.   154.   155.     0.95 mode   hdi      
2 sigma   7.82   7.19   8.35   0.95 mode   hdi      </code></pre>
</div>
</div>
<section id="overthinking-sample-size-and-the-normality-of-sigmas-posterior." class="level4" data-number="4.3.4.1">
<h4 data-number="4.3.4.1" class="anchored" data-anchor-id="overthinking-sample-size-and-the-normality-of-sigmas-posterior."><span class="header-section-number">4.3.4.1</span> Overthinking: Sample size and the normality of <span class="math inline">\(\sigma\)</span>’s posterior.</h4>
<p>Here’s <code>d3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>(d3 <span class="ot">&lt;-</span> <span class="fu">sample</span>(d2<span class="sc">$</span>height, <span class="at">size =</span> <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 147.3200 154.9400 168.9100 156.8450 165.7350 151.7650 165.7350 156.2100
 [9] 144.7800 154.9400 151.1300 147.9550 149.8600 162.5600 161.9250 164.4650
[17] 160.9852 151.7650 163.8300 149.8600</code></pre>
</div>
</div>
<p>For our first step using <code>d3</code>, we’ll redefine <code>d_grid</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Note we've redefined the ranges of `mu` and `sigma`</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu    =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">150</span>, <span class="at">to =</span> <span class="dv">170</span>, <span class="at">length.out =</span> n),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">4</span>, <span class="at">to =</span> <span class="dv">20</span>, <span class="at">length.out =</span> n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, we’ll redefine our custom <code>grid_function()</code> function to operate over the <code>height</code> values of <code>d3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>grid_function <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, sigma) {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(d3, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>()</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’ll use the amended <code>grid_function()</code> to make the posterior.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>d_grid <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_likelihood =</span> <span class="fu">map2_dbl</span>(<span class="at">.x =</span> mu, <span class="at">.y =</span> sigma, <span class="at">.f =</span> grid_function)) <span class="sc">|&gt;</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior_mu    =</span> <span class="fu">dnorm</span>(<span class="at">x =</span> mu, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>, <span class="at">log =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">prior_sigma =</span> <span class="fu">dunif</span>(<span class="at">x =</span> sigma, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">50</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">product =</span> log_likelihood <span class="sc">+</span> prior_mu <span class="sc">+</span> prior_sigma) <span class="sc">|&gt;</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probability =</span> <span class="fu">exp</span>(product <span class="sc">-</span> <span class="fu">max</span>(product)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we’ll <code>sample_n()</code> and plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="ot">&lt;-</span> d_grid <span class="sc">|&gt;</span>  </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="fl">1e4</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">weight =</span> probability)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma)) <span class="sc">+</span> </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.9</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu[samples]),</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(sigma[samples]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>Behold the updated densities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>d_grid_samples <span class="sc">|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey33"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">labeller =</span> label_parsed, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="576"></p>
</div>
</div>
</section>
</section>
<section id="finding-the-posterior-distribution-with-quap-stan." class="level3" data-number="4.3.5">
<h3 data-number="4.3.5" class="anchored" data-anchor-id="finding-the-posterior-distribution-with-quap-stan."><span class="header-section-number">4.3.5</span> Finding the posterior distribution with <del><code>quap()</code></del> <code>stan()</code>.</h3>
<p>Here we rewrite the statistical model, this time using font color to help differentiate the likelihood from the prior(s).</p>
<p><span class="math display">\[
\begin{align*}
\color{red}{\text{heights}_i} &amp; \color{red}\sim \color{red}{\operatorname{Normal}(\mu, \sigma)} &amp;&amp; \color{red}{\text{likelihood}} \\
\color{blue}\mu &amp; \color{blue}\sim \color{blue}{\operatorname{Normal}(178, 20)} &amp;&amp; \color{blue}{\text{prior}} \\
\color{blue}\sigma &amp; \color{blue}\sim \color{blue}{\operatorname{Uniform}(0, 50)}
\end{align*}
\]</span></p>
<p>For <strong>rstan</strong>, first we define the model code, which is a character string specifying the model with a series of blocks. Perhaps the most fundamental of these are the <code>model</code>, <code>parameters</code>, and <code>model</code> blocks. Note that whereas we typically use the <code>#</code> mark to make comments in <strong>R</strong> code, we use <code>//</code> for comments in <strong>rstan</strong> model code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="st">  real mu;</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);  // Likelihood</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="st">  mu ~ normal(178, 20);        // Priors</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we use the <code>tidybayes::compose_data()</code> function to convert the data to a list, which is the format expected by <strong>rstan</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ height: num [1:352(1d)] 152 140 137 157 145 ...
 $ weight: num [1:352(1d)] 47.8 36.5 31.9 53 41.3 ...
 $ age   : num [1:352(1d)] 63 63 65 41 51 35 32 27 19 54 ...
 $ male  : int [1:352(1d)] 1 0 0 1 0 1 0 1 0 1 ...
 $ n     : int 352</code></pre>
</div>
</div>
<p>Note how the <code>compose_data()</code> function automatically added a variable called <code>n</code>, which tells the number of rows in the original data frame. If you look at the <code>model_code</code> above, you’ll see how I used that value when defining the vector of <code>height</code> values.</p>
<p>Now we fit the model with the <code>stan()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Default settings</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># To make it reproducible</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m4<span class="fl">.1</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

         mean se_mean   sd    5.5%   94.5% n_eff Rhat
mu     154.59    0.01 0.41  153.94  155.25  2711    1
sigma    7.78    0.01 0.30    7.32    8.26  3292    1
lp__  -895.75    0.02 0.99 -897.62 -894.80  1726    1

Samples were drawn using NUTS(diag_e) at Wed Jul 31 18:17:42 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Here’s the second model with the stronger prior for <span class="math inline">\(\mu\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="st">  real mu;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="st">  mu ~ normal(178, 0.1);       // This prior has been updated</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code,</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the model summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m4<span class="fl">.2</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

          mean se_mean   sd     5.5%    94.5% n_eff Rhat
mu      177.86    0.00 0.10   177.69   178.03  3207    1
sigma    24.60    0.02 0.94    23.13    26.14  3222    1
lp__  -1301.64    0.03 1.04 -1303.65 -1300.66  1461    1

Samples were drawn using NUTS(diag_e) at Wed Jul 31 18:18:11 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<section id="overthinking-start-values-for-quap-rstan." class="level4" data-number="4.3.5.1">
<h4 data-number="4.3.5.1" class="anchored" data-anchor-id="overthinking-start-values-for-quap-rstan."><span class="header-section-number">4.3.5.1</span> Overthinking: Start values for <del>quap</del> <code>rstan()</code>.</h4>
<p>The Stan folks generally use the language of <em>initial</em> values, rather than <em>start</em> values. But I believe these are basically the same thing. Within the <code>stan()</code> function, you can set these with the <code>init</code> argument, about which you can learn more by executing <code>?stan</code> in your console, or perhaps looking through <a href="https://discourse.mc-stan.org/t/how-to-define-initial-values-in-stan-in-r/16855">this thread</a> on the Stan forums.</p>
</section>
</section>
<section id="sampling-from-a-quap-stan." class="level3" data-number="4.3.6">
<h3 data-number="4.3.6" class="anchored" data-anchor-id="sampling-from-a-quap-stan."><span class="header-section-number">4.3.6</span> Sampling from a <del><code>quap()</code></del> <code>stan()</code>.</h3>
<p>The <code>vcov()</code> function does not work for models fit with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vcov</span>(m4<span class="fl">.1</span>)  <span class="co"># This returns an error message</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, if you really wanted this information, you could get it after putting the HMC chains in a data frame. We do that with the <code>as_draws_df()</code> function from the <strong>posterior</strong> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m4<span class="fl">.1</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(draws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A draws_df: 6 iterations, 1 chains, and 3 variables
   mu sigma lp__
1 155   7.5 -896
2 155   7.0 -899
3 154   7.6 -895
4 154   8.0 -895
5 155   7.6 -895
6 155   7.4 -895
# ... hidden reserved variables {'.chain', '.iteration', '.draw'}</code></pre>
</div>
</div>
<p>When McElreath extracts his posterior draws in the text, he generally calls the object <code>post</code>. Since several of the related functions from the <strong>posterior</strong> and <strong>tidybayes</strong> packages tend to use the language of <em>draws</em>, we’ll do the same and call our posterior draws objects <code>draws</code>.</p>
<p>Now <code>select()</code> the columns containing the draws from the desired parameters and feed them into the <code>cov()</code> function, which will return a variance/covariance matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               mu       sigma
mu     0.16783765 -0.00255372
sigma -0.00255372  0.08895420</code></pre>
</div>
</div>
<p>Here are just the variances, and then the correlation matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variances</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov</span>() <span class="sc">|&gt;</span> </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       mu     sigma 
0.1678377 0.0889542 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               mu       sigma
mu     1.00000000 -0.02089996
sigma -0.02089996  1.00000000</code></pre>
</div>
</div>
<p>With our <code>draws &lt;- as_draws_df(m4.1)</code> code from a few lines above, we’ve already produced the <strong>rstan</strong> version of what McElreath achieved with <code>extract.samples()</code> on page 90. However, what happened under the hood was different. Whereas <strong>rethinking</strong> used the <code>mvnorm()</code> function from the <strong>MASS</strong> package, with <code>posterior::as_draws_df()</code> we extracted the iterations of the HMC chains and put them in a data frame.</p>
<p>The <code>summary()</code> function doesn’t work for <code>as_draws_df()</code> objects quite the way <code>precis()</code> does for posterior data frames from the <strong>rethinking</strong> package. Behold the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       mu            sigma      
 Min.   :153.4   Min.   :6.841  
 1st Qu.:154.3   1st Qu.:7.565  
 Median :154.6   Median :7.765  
 Mean   :154.6   Mean   :7.776  
 3rd Qu.:154.9   3rd Qu.:7.967  
 Max.   :156.2   Max.   :8.891  </code></pre>
</div>
</div>
<p>However, the <code>summarise_draws()</code> function provides a nice summary for columns from <code>as_draws_df()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>() <span class="sc">|&gt;</span> </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 10
  variable   mean median    sd   mad    q5    q95  rhat ess_bulk ess_tail
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 mu       155.   155.    0.41  0.41 154.  155.       1    2750.    2433.
2 sigma      7.78   7.77  0.3   0.3    7.3   8.27     1    3328.    2087.</code></pre>
</div>
</div>
<p>The function comes with three handy <code>default_*_meaures()</code> helper function, which can help give a more focused output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default_summary_measures()</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(<span class="fu">default_summary_measures</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  variable   mean median    sd   mad    q5    q95
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 mu       155.   155.    0.41  0.41 154.  155.  
2 sigma      7.78   7.77  0.3   0.3    7.3   8.27</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default_convergence_measures()</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(<span class="fu">default_convergence_measures</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  variable  rhat ess_bulk ess_tail
  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 mu           1    2750.    2433.
2 sigma        1    3328.    2087.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default_mcse_measures()</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>(<span class="fu">default_mcse_measures</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  variable mcse_mean mcse_median mcse_sd mcse_q5 mcse_q95
  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 mu            0.01        0.01    0.01    0.02     0.02
2 sigma         0.01        0.01    0.01    0.01     0.01</code></pre>
</div>
</div>
<p>You can also compute many of these statistics with explicit <strong>tidyverse</strong> code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd   =</span> <span class="fu">sd</span>(value),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">5.5%</span><span class="st">`</span>  <span class="ot">=</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.055</span>),</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">94.5%</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.945</span>)) <span class="sc">|&gt;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  name    mean    sd `5.5%` `94.5%`
  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1 mu    155.    0.41 154.    155.  
2 sigma   7.78  0.3    7.32    8.26</code></pre>
</div>
</div>
<p>And if you’re willing to drop the posterior <span class="math inline">\(\textit{SD}\)</span>s, you can use <code>tidybayes::mean_hdi()</code>, too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  name   value .lower .upper .width .point .interval
  &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 mu    155.   154.   155.     0.95 mean   qi       
2 sigma   7.78   7.23   8.42   0.95 mean   qi       </code></pre>
</div>
</div>
<section id="overthinking-under-the-hood-with-multivariate-sampling." class="level4" data-number="4.3.6.1">
<h4 data-number="4.3.6.1" class="anchored" data-anchor-id="overthinking-under-the-hood-with-multivariate-sampling."><span class="header-section-number">4.3.6.1</span> Overthinking: Under the hood with multivariate sampling.</h4>
</section>
</section>
</section>
<section id="linear-prediction" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="linear-prediction"><span class="header-section-number">4.4</span> Linear prediction</h2>
<p>Here’s our scatter plot of <code>weight</code> and <code>height</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<section id="rethinking-what-is-regression" class="level4" data-number="4.4.0.1">
<h4 data-number="4.4.0.1" class="anchored" data-anchor-id="rethinking-what-is-regression"><span class="header-section-number">4.4.0.1</span> Rethinking: What is “regression”?</h4>
</section>
<section id="the-linear-model-strategy." class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="the-linear-model-strategy."><span class="header-section-number">4.4.1</span> The linear model strategy.</h3>
<p>Like we did for our first model without a predictor, we’ll use font color to help differentiate between the likelihood and prior(s) of our new univariable model,</p>
<p><span class="math display">\[
\begin{align*}
\color{red}{\text{height}_i} &amp; \color{red}\sim \color{red}{\operatorname{Normal}(\mu_i, \sigma)} &amp;&amp; \color{red}{\text{likelihood}} \\
\color{red}{\mu_i} &amp; \color{red}= \color{red}{\alpha + \beta (\text{weight}_i - \overline{\text{weight}})}  &amp;&amp; \color{red}{\text{\{the linear model is just a special part of the likelihood\}} } \\
\color{blue}\alpha &amp; \color{blue}\sim \color{blue}{\operatorname{Normal}(178, 20)} &amp;&amp; \color{blue}{\text{prior(s)}} \\
\color{blue}\beta  &amp; \color{blue}\sim \color{blue}{\operatorname{Normal}(0, 10)} \\
\color{blue}\sigma &amp; \color{blue}\sim \color{blue}{\operatorname{Uniform}(0, 50)}.
\end{align*}
\]</span></p>
<section id="probability-of-the-data." class="level4" data-number="4.4.1.1">
<h4 data-number="4.4.1.1" class="anchored" data-anchor-id="probability-of-the-data."><span class="header-section-number">4.4.1.1</span> Probability of the data.</h4>
</section>
<section id="linear-model." class="level4" data-number="4.4.1.2">
<h4 data-number="4.4.1.2" class="anchored" data-anchor-id="linear-model."><span class="header-section-number">4.4.1.2</span> Linear model.</h4>
<section id="rethinking-nothing-special-or-natural-about-linear-models." class="level5" data-number="4.4.1.2.1">
<h5 data-number="4.4.1.2.1" class="anchored" data-anchor-id="rethinking-nothing-special-or-natural-about-linear-models."><span class="header-section-number">4.4.1.2.1</span> Rethinking: Nothing special or natural about linear models.</h5>
</section>
<section id="overthinking-units-and-regression-models." class="level5" data-number="4.4.1.2.2">
<h5 data-number="4.4.1.2.2" class="anchored" data-anchor-id="overthinking-units-and-regression-models."><span class="header-section-number">4.4.1.2.2</span> Overthinking: Units and regression models.</h5>
</section>
</section>
<section id="priors." class="level4" data-number="4.4.1.3">
<h4 data-number="4.4.1.3" class="anchored" data-anchor-id="priors."><span class="header-section-number">4.4.1.3</span> Priors.</h4>
<p>Instead of using a loop to make our data for Figure 4.5, we’ll stay within the <strong>tidyverse</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many lines would you like?</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>n_lines <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2971</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n_lines,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_lines, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>),</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_lines, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight)) <span class="sc">|&gt;</span> </span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> a <span class="sc">+</span> b <span class="sc">*</span> (weight <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight)))</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lines)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
      n     a      b weight height
  &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     1  191. -7.06    31.1  289. 
2     1  191. -7.06    63.0   63.5
3     2  199.  0.839   31.1  187. 
4     2  199.  0.839   63.0  214. 
5     3  202.  3.93    31.1  147. 
6     3  202.  3.93    63.0  272. </code></pre>
</div>
</div>
<p>Now we’ll plot the left panel from Figure 4.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> lines <span class="sc">|&gt;</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height, <span class="at">group =</span> n)) <span class="sc">+</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">272</span>), <span class="at">linetype =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"b ~ dnorm(0, 10)"</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>Here’s what <span class="math inline">\(\operatorname{Log-Normal}(0, 1)\)</span> looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">b =</span> <span class="fu">rlnorm</span>(<span class="at">n =</span> <span class="fl">1e4</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> b)) <span class="sc">+</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>Here’s what happens when we compare <span class="math inline">\(\operatorname{Normal}(0, 1)\)</span> with <span class="math inline">\(\log \big ( \operatorname{Log-Normal}(0, 1) \big)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">rnorm           =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fl">1e5</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">`</span><span class="at">log(rlognorm)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">rlnorm</span>(<span class="at">n =</span> <span class="fl">1e5</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">log</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>) <span class="sc">+</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>The formulas for the actual mean and standard deviation for the log-normal distribution itself are:</p>
<p><span class="math display">\[
\begin{align*}
\text{mean}               &amp; = \exp \left (\mu + \frac{\sigma^2}{2} \right) &amp; \text{and} \\
\text{standard deviation} &amp; = \sqrt{[\exp(\sigma ^{2})-1] \; \exp(2\mu +\sigma ^{2})}.
\end{align*}
\]</span></p>
<p>Let’s try our hand at those formulas and compute the mean and standard deviation for <span class="math inline">\(\operatorname{Log-Normal}(0, 1)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>mu    <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(mu <span class="sc">+</span> (sigma<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.648721</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SD</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>((<span class="fu">exp</span>(sigma<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="dv">2</span> <span class="sc">*</span> mu <span class="sc">+</span> sigma<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.161197</code></pre>
</div>
</div>
<p>Let’s confirm with simulated draws from <code>rlnorm()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rlnorm</span>(<span class="at">n =</span> <span class="fl">1e7</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x),</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd   =</span> <span class="fu">sd</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   mean    sd
  &lt;dbl&gt; &lt;dbl&gt;
1  1.65  2.17</code></pre>
</div>
</div>
<p>But okay, “so what [do all these complications] earn us? Do the prior predictive simulation again, now with the Log-Normal prior:” (p.&nbsp;96).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a tibble to annotate the plot</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">weight =</span> <span class="fu">c</span>(<span class="dv">34</span>, <span class="dv">43</span>),</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">height =</span> <span class="fu">c</span>(<span class="dv">0</span> <span class="sc">-</span> <span class="dv">25</span>, <span class="dv">272</span> <span class="sc">+</span> <span class="dv">25</span>),</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">label  =</span> <span class="fu">c</span>(<span class="st">"Embryo"</span>, <span class="st">"World's tallest person (272 cm)"</span>))</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2971</span>)</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n_lines,</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_lines, <span class="at">mean =</span> <span class="dv">178</span>, <span class="at">sd =</span> <span class="dv">20</span>),</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">rlnorm</span>(<span class="at">n =</span> n_lines, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight)) <span class="sc">|&gt;</span> </span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> a <span class="sc">+</span> b <span class="sc">*</span> (weight <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight))) <span class="sc">|&gt;</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height, <span class="at">group =</span> n)) <span class="sc">+</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">272</span>), <span class="at">linetype =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> label),</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">400</span>)) <span class="sc">+</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"log(b) ~ dnorm(0, 1)"</span>)</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine both panels</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">|</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="552"></p>
</div>
</div>
<p>Thus we now have the full Figure 4.5.</p>
<section id="rethinking-whats-the-correct-prior" class="level5" data-number="4.4.1.3.1">
<h5 data-number="4.4.1.3.1" class="anchored" data-anchor-id="rethinking-whats-the-correct-prior"><span class="header-section-number">4.4.1.3.1</span> Rethinking: What’s the correct prior?</h5>
</section>
<section id="rethinking-prior-predictive-simulation-and-p-hacking." class="level5" data-number="4.4.1.3.2">
<h5 data-number="4.4.1.3.2" class="anchored" data-anchor-id="rethinking-prior-predictive-simulation-and-p-hacking."><span class="header-section-number">4.4.1.3.2</span> Rethinking: Prior predictive simulation and <span class="math inline">\(p\)</span>-hacking.</h5>
</section>
</section>
</section>
<section id="finding-the-posterior-distribution." class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="finding-the-posterior-distribution."><span class="header-section-number">4.4.2</span> Finding the posterior distribution.</h3>
<p>Now we get ready to actually fit the model</p>
<p><span class="math display">\[
\begin{align*}
\text{height}_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i &amp; = \alpha + \beta (\text{weight}_i - \overline{\text{weight}}) \\
\alpha &amp; \sim \operatorname{Normal}(178, 20) \\
\beta  &amp; \sim \operatorname{Log-Normal}(0, 1) \\
\sigma &amp; \sim \operatorname{Uniform}(0, 50).
\end{align*}
\]</span></p>
<p>First, here’s the updated <code>model_code</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="st">  real xbar;         // New data point</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] weight;</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real a;</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; b;</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = a + b * (weight - xbar);  // New model syntax</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(178, 20);</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ lognormal(0, 1);</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we need to add the mean of the <code>weight</code> column as a new value in the <code>stan_data</code> data list. We’ll call it <code>xbar</code>. Note how this is just a single value, not a vector.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>stan_data<span class="sc">$</span>xbar <span class="ot">&lt;-</span> <span class="fu">mean</span>(stan_data<span class="sc">$</span>weight)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 6
 $ height: num [1:352(1d)] 152 140 137 157 145 ...
 $ weight: num [1:352(1d)] 47.8 36.5 31.9 53 41.3 ...
 $ age   : num [1:352(1d)] 63 63 65 41 51 35 32 27 19 54 ...
 $ male  : int [1:352(1d)] 1 0 0 1 0 1 0 1 0 1 ...
 $ n     : int 352
 $ xbar  : num 45</code></pre>
</div>
</div>
<p>Now we fit the model with <code>stan()</code>, as before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Look at the <code>print()</code> summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m4<span class="fl">.3</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

         mean se_mean   sd    5.5%   94.5% n_eff Rhat
a      154.60    0.00 0.27  154.17  155.02  4510    1
b        0.90    0.00 0.04    0.84    0.97  4079    1
sigma    5.11    0.00 0.19    4.83    5.43  3751    1
lp__  -749.09    0.03 1.19 -751.34 -747.82  2180    1

Samples were drawn using NUTS(diag_e) at Wed Jul 31 17:55:47 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<section id="rethinking-everything-that-depends-upon-parameters-has-a-posterior-distribution." class="level4" data-number="4.4.2.1">
<h4 data-number="4.4.2.1" class="anchored" data-anchor-id="rethinking-everything-that-depends-upon-parameters-has-a-posterior-distribution."><span class="header-section-number">4.4.2.1</span> Rethinking: Everything that depends upon parameters has a posterior distribution.</h4>
</section>
<section id="overthinking-logs-and-exps-oh-my." class="level4" data-number="4.4.2.2">
<h4 data-number="4.4.2.2" class="anchored" data-anchor-id="overthinking-logs-and-exps-oh-my."><span class="header-section-number">4.4.2.2</span> Overthinking: Logs and exps, oh my.</h4>
<p>With <code>stan()</code>, you can include <code>exp()</code> and other defined functions right in the <code>model</code> formula.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the model</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="st">  real xbar;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] weight;</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real a;</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; log_b;</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = a + exp(log_b) * (weight - xbar);  // Include `exp()` right in the formula</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(178, 20);</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="st">  log_b ~ normal(0, 1);</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the non-linear model</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.3</span>b <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> model_code,</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m4<span class="fl">.3</span>b, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

         mean se_mean   sd    5.5%   94.5% n_eff Rhat
a      154.60    0.01 0.27  154.16  155.03  2790    1
log_b    0.01    0.00 0.01    0.00    0.04  3334    1
sigma    5.15    0.00 0.20    4.85    5.49  2865    1
lp__  -755.86    0.03 1.23 -758.14 -754.50  1692    1

Samples were drawn using NUTS(diag_e) at Wed Jul 31 17:58:15 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>We can exponentiate the <code>log_b</code> parameter to convert it back to the <span class="math inline">\(\beta\)</span> scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m4<span class="fl">.3</span>b) <span class="sc">|&gt;</span> </span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">b =</span> <span class="fu">exp</span>(log_b)) <span class="sc">|&gt;</span> </span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
      b .lower .upper .width .point .interval
  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1  1.01   1.00   1.05   0.95 mean   qi       </code></pre>
</div>
</div>
</section>
</section>
<section id="interpreting-the-posterior-distribution." class="level3" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="interpreting-the-posterior-distribution."><span class="header-section-number">4.4.3</span> Interpreting the posterior distribution.</h3>
<section id="rethinking-what-do-parameters-mean" class="level5" data-number="4.4.3.0.1">
<h5 data-number="4.4.3.0.1" class="anchored" data-anchor-id="rethinking-what-do-parameters-mean"><span class="header-section-number">4.4.3.0.1</span> Rethinking: What do parameters mean?</h5>
</section>
<section id="tables-of-marginal-distributions." class="level4" data-number="4.4.3.1">
<h4 data-number="4.4.3.1" class="anchored" data-anchor-id="tables-of-marginal-distributions."><span class="header-section-number">4.4.3.1</span> Tables of marginal distributions.</h4>
<p>We can get an exhaustive summary by simply inputting the <code>stan()</code> model fit object directly into <code>summarise_draws()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.3</span> <span class="sc">|&gt;</span> </span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 10
  variable     mean   median     sd    mad       q5      q95  rhat ess_bulk
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 a         155.     155.    0.269  0.266   154.     155.     1.00    4520.
2 b           0.905    0.904 0.0414 0.0419    0.837    0.973  1.00    4063.
3 sigma       5.11     5.10  0.190  0.189     4.82     5.44   1.00    3843.
4 lp__     -749.    -749.    1.19   0.968  -751.    -748.     1.00    2101.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Though not needed in this application, you can also use <code>summarise_draws()</code> after first calling <code>as_draws_df()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.3</span> <span class="sc">|&gt;</span> </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>() <span class="sc">|&gt;</span> </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_draws</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 10
  variable     mean   median     sd    mad       q5      q95  rhat ess_bulk
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 a         155.     155.    0.269  0.266   154.     155.     1.00    4520.
2 b           0.905    0.904 0.0414 0.0419    0.837    0.973  1.00    4063.
3 sigma       5.11     5.10  0.190  0.189     4.82     5.44   1.00    3843.
4 lp__     -749.    -749.    1.19   0.968  -751.    -748.     1.00    2101.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Compute the variance/covariance matrix with <code>as_draws_df()</code> and <code>cov()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.3</span> <span class="sc">|&gt;</span> </span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>() <span class="sc">|&gt;</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu<span class="sc">:</span>sigma) <span class="sc">|&gt;</span> </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov</span>() <span class="sc">|&gt;</span> </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          a     b sigma
a     0.072 0.000 0.001
b     0.000 0.002 0.000
sigma 0.001 0.000 0.036</code></pre>
</div>
</div>
<p>Here’s how the <code>pairs()</code> function works for a model fit with <code>stan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(m4<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="432"></p>
</div>
</div>
<p>The <code>pairs()</code> function takes several arguments which can alter its output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(m4<span class="fl">.3</span>, </span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">cex =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">gap =</span> <span class="fl">0.25</span>,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel =</span> <span class="st">"points"</span>,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"sigma"</span>),</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">pch =</span> <span class="dv">19</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid" width="432"></p>
</div>
</div>
</section>
<section id="plotting-posterior-inference-against-the-data." class="level4" data-number="4.4.3.2">
<h4 data-number="4.4.3.2" class="anchored" data-anchor-id="plotting-posterior-inference-against-the-data."><span class="header-section-number">4.4.3.2</span> Plotting posterior inference against the data.</h4>
<p>Here is the code for Figure 4.6. Note how we extract the posterior means first, save the values, and input those into the arguments within <code>geom_abline()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute, extract, and save the posterior means</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>a_stan <span class="ot">&lt;-</span> <span class="fu">summarise_draws</span>(m4<span class="fl">.3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"a"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(mean)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>b_stan <span class="ot">&lt;-</span> <span class="fu">summarise_draws</span>(m4<span class="fl">.3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"b"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(mean)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the `weight_c` column</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_c =</span> weight <span class="sc">-</span> <span class="fu">mean</span>(weight)) </span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span> </span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_c, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> a_stan, <span class="at">slope =</span> b_stan,</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"weight"</span>,</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">6</span> <span class="sc">*</span> <span class="dv">10</span> <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight),</span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">6</span> <span class="sc">*</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid" width="288"></p>
</div>
</div>
</section>
<section id="adding-uncertainty-around-the-mean." class="level4" data-number="4.4.3.3">
<h4 data-number="4.4.3.3" class="anchored" data-anchor-id="adding-uncertainty-around-the-mean."><span class="header-section-number">4.4.3.3</span> Adding uncertainty around the mean.</h4>
<p>It’s easy to extract all the posterior draws from a <code>stan()</code> model with <code>as_draws_df()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_draws_df</span>(m4<span class="fl">.3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,000
Columns: 7
$ a          &lt;dbl&gt; 154.4306, 154.5734, 154.4522, 154.3828, 154.4476, 154.4773,…
$ b          &lt;dbl&gt; 0.9446215, 0.9187776, 0.9058252, 0.8661769, 0.9061876, 0.89…
$ sigma      &lt;dbl&gt; 4.900342, 5.098300, 4.958741, 5.076583, 5.114658, 5.211086,…
$ lp__       &lt;dbl&gt; -748.7815, -747.6992, -747.9981, -748.3969, -747.8140, -747…
$ .chain     &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ .iteration &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …
$ .draw      &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …</code></pre>
</div>
</div>
<p>As far as the workflow in McElreath’s R code 4.48 and 4.49 goes, we’ll do this in a series of steps. First, we make a tibble with a column showing the four levels of <code>n</code>, and then save the subset versions of the <code>d2</code> data in a nested column by way of <code>map()</code>. We save the results as <code>n_df</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>n_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">n =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">150</span>, <span class="dv">352</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(<span class="at">.x =</span> n, <span class="at">.f =</span><span class="sc">~</span> d2 <span class="sc">|&gt;</span> </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>.x)))</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
      n data          
  &lt;dbl&gt; &lt;list&gt;        
1    10 &lt;df [10 × 5]&gt; 
2    50 &lt;df [50 × 5]&gt; 
3   150 &lt;df [150 × 5]&gt;
4   352 &lt;df [352 × 5]&gt;</code></pre>
</div>
</div>
<p>Now make a <code>stan_data</code> column with the data in a list for <strong>rstan</strong>. Note how we included the <code>xbar</code> component in the list by defining it right within <code>compose_data()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>n_df <span class="ot">&lt;-</span> n_df <span class="sc">|&gt;</span> </span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stan_data =</span> <span class="fu">map</span>(<span class="at">.x =</span> data, <span class="at">.f =</span><span class="sc">~</span> .x <span class="sc">|&gt;</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">compose_data</span>(<span class="at">xbar =</span> <span class="fu">mean</span>(.x<span class="sc">$</span>weight))))</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
      n data           stan_data       
  &lt;dbl&gt; &lt;list&gt;         &lt;list&gt;          
1    10 &lt;df [10 × 5]&gt;  &lt;named list [7]&gt;
2    50 &lt;df [50 × 5]&gt;  &lt;named list [7]&gt;
3   150 &lt;df [150 × 5]&gt; &lt;named list [7]&gt;
4   352 &lt;df [352 × 5]&gt; &lt;named list [7]&gt;</code></pre>
</div>
</div>
<p>Next, redefine the <code>model_code</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="st">  real xbar;         // new data point</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] weight;</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real a;</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; b;</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = a + b * (weight - xbar);</span></span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);</span></span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(178, 20);</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ lognormal(0, 1);</span></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unlike with the models above where we compiled and samples from the models all in one <code>stan()</code> call, here we’ll use a 2-step procedure. For the first step, we compile the <code>model_code</code> object with the <code>stan_model()</code> function. We’ll save the results as an object called <code>stan_dso</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>stan_dso <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> model_code)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>stan_model()</code> function returns an object of S4 class <code>stanmodel</code>, and the code is compiled into a so-called dynamic shared object (DSO), which is why we’ve save our results as <code>stan_dso</code>. To learn more, execute <code>?stan_model</code> for the documentation.</p>
<p>For the second step, we sample from the <code>stan_dso</code> object with the <code>sampling()</code> function, saving the model fits in the <code>sampling</code> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>n_df <span class="ot">&lt;-</span> n_df <span class="sc">|&gt;</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sampling =</span> <span class="fu">map</span>(<span class="at">.x =</span> stan_data, </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span><span class="sc">~</span> <span class="fu">sampling</span>(</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> .x,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">object =</span> stan_dso, </span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now extract 20 rows from the model fits with <code>as_draws_df()</code> and <code>slice_sample()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>n_df <span class="ot">&lt;-</span> n_df <span class="sc">|&gt;</span> </span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">as_draws_df =</span> <span class="fu">map</span>(<span class="at">.x =</span> sampling,</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">.f =</span><span class="sc">~</span> <span class="fu">as_draws_df</span>(.x) <span class="sc">|&gt;</span> </span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">20</span>)))</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
      n data           stan_data        sampling        as_draws_df        
  &lt;dbl&gt; &lt;list&gt;         &lt;list&gt;           &lt;list&gt;          &lt;list&gt;             
1    10 &lt;df [10 × 5]&gt;  &lt;named list [7]&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df [20 × 7]&gt;
2    50 &lt;df [50 × 5]&gt;  &lt;named list [7]&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df [20 × 7]&gt;
3   150 &lt;df [150 × 5]&gt; &lt;named list [7]&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df [20 × 7]&gt;
4   352 &lt;df [352 × 5]&gt; &lt;named list [7]&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df [20 × 7]&gt;</code></pre>
</div>
</div>
<p>We’ll need to extract the <code>xbar</code> values for easy <strong>tidyverse</strong> wrangling, and then we’ll adjust the <code>n</code> column for nicer plot formatting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>n_df <span class="ot">&lt;-</span> n_df <span class="sc">|&gt;</span> </span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xbar =</span> <span class="fu">map_dbl</span>(<span class="at">.x =</span> stan_data,</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span><span class="sc">~</span> .x[[<span class="st">"xbar"</span>]]),</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">n =</span> <span class="fu">str_c</span>(<span class="st">"italic(n)=="</span>, n) <span class="sc">|&gt;</span> </span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">str_c</span>(<span class="st">"italic(n)=="</span>, <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">150</span>, <span class="dv">352</span>))))</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  n              data           stan_data    sampling        as_draws_df  xbar
  &lt;fct&gt;          &lt;list&gt;         &lt;list&gt;       &lt;list&gt;          &lt;list&gt;      &lt;dbl&gt;
1 italic(n)==10  &lt;df [10 × 5]&gt;  &lt;named list&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df&gt;   45.7
2 italic(n)==50  &lt;df [50 × 5]&gt;  &lt;named list&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df&gt;   44.9
3 italic(n)==150 &lt;df [150 × 5]&gt; &lt;named list&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df&gt;   45.5
4 italic(n)==352 &lt;df [352 × 5]&gt; &lt;named list&gt; &lt;stanfit[,4,4]&gt; &lt;draws_df&gt;   45.0</code></pre>
</div>
</div>
<p>Now we plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>n_df <span class="sc">|&gt;</span> </span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n, data, xbar) <span class="sc">|&gt;</span> </span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight <span class="sc">-</span> xbar, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> n_df <span class="sc">|&gt;</span> </span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(n, xbar, as_draws_df) <span class="sc">|&gt;</span> </span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">unnest</span>(as_draws_df),</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">intercept =</span> a, <span class="at">slope =</span> b,</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group =</span> .draw),</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"weight"</span>,</span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">6</span> <span class="sc">*</span> <span class="dv">10</span> <span class="sc">-</span> <span class="fu">mean</span>(d2<span class="sc">$</span>weight),</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">6</span> <span class="sc">*</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> n, <span class="at">labeller =</span> label_parsed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid" width="576"></p>
</div>
</div>
</section>
<section id="plotting-regression-intervals-and-contours." class="level4" data-number="4.4.3.4">
<h4 data-number="4.4.3.4" class="anchored" data-anchor-id="plotting-regression-intervals-and-contours."><span class="header-section-number">4.4.3.4</span> Plotting regression intervals and contours.</h4>
<p>Since we used <code>weight_c</code> to fit our model, we might first want to understand what exactly the mean value is for <code>weight</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(d2<span class="sc">$</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 44.99049</code></pre>
</div>
</div>
<p>This is the same as the <code>xbar</code> value saved in the <code>stan_data</code> object from above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>stan_data<span class="sc">$</span>xbar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 44.99049</code></pre>
</div>
</div>
<p>If we’re interested in <span class="math inline">\(\mu\)</span> at <code>weight</code> = 50, that implies we’re also interested in <span class="math inline">\(\mu\)</span> at <code>weight_c</code> + 5.01. Within the context of our model, we compute this with <span class="math inline">\(\alpha + \beta \cdot 5.01\)</span>. Here we’ll extract the HMC draws from <code>m4.3</code> with <code>as_draws_df()</code>, and then define the <code>mu_at_50</code> column using the same basic algebra McElreath used in his R code 4.50.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m4<span class="fl">.3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu_at_50 =</span> a <span class="sc">+</span> b <span class="sc">*</span> (<span class="dv">50</span> <span class="sc">-</span> stan_data<span class="sc">$</span>xbar))</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(draws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A draws_df: 6 iterations, 1 chains, and 5 variables
    a    b sigma lp__ mu_at_50
1 154 0.94   4.9 -749      159
2 155 0.92   5.1 -748      159
3 154 0.91   5.0 -748      159
4 154 0.87   5.1 -748      159
5 154 0.91   5.1 -748      159
6 154 0.90   5.2 -748      159
# ... hidden reserved variables {'.chain', '.iteration', '.draw'}</code></pre>
</div>
</div>
<p>Here is a version McElreath’s Figure 4.8 density plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu_at_50)) <span class="sc">+</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">adjust =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"gray65"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(mu[<span class="st">"height | weight = 50"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>We’ll use <code>mean_hdi()</code> to get both 89% and 95% HDIs, along with the mean.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">|&gt;</span> </span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(mu_at_50, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.89</span>, <span class="fl">0.95</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  mu_at_50 .lower .upper .width .point .interval
     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1     159.   159.   160.   0.89 mean   hdi      
2     159.   158.   160.   0.95 mean   hdi      </code></pre>
</div>
</div>
<p>The <code>fitted()</code> functions are not available for <code>stan()</code> models. However, we can adjust our <code>as_draws_df()</code> output (i.e., <code>draws</code>) with <code>expand_grid()</code> to compute the fitted values by hand. We save the results as <code>draws_fitted_df</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>draws_fitted_df <span class="ot">&lt;-</span> draws <span class="sc">|&gt;</span> </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw, a, b, sigma) <span class="sc">|&gt;</span> </span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight =</span> <span class="dv">25</span><span class="sc">:</span><span class="dv">70</span>) <span class="sc">|&gt;</span> </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height =</span> a <span class="sc">+</span> b <span class="sc">*</span> (weight <span class="sc">-</span> stan_data<span class="sc">$</span>xbar))</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(draws_fitted_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  .draw     a     b sigma weight height
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt;  &lt;dbl&gt;
1     1  154. 0.945  4.90     25   136.
2     1  154. 0.945  4.90     26   136.
3     1  154. 0.945  4.90     27   137.
4     1  154. 0.945  4.90     28   138.
5     1  154. 0.945  4.90     29   139.
6     1  154. 0.945  4.90     30   140.</code></pre>
</div>
</div>
<p>Here’s how to use that output to make Figure 4.9.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> draws_fitted_df <span class="sc">|&gt;</span> </span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.draw <span class="sc">&lt;=</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">color =</span> <span class="st">"navyblue"</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> d2 <span class="sc">|&gt;</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">data =</span> draws_fitted_df,</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), </span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>)</span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine, adjust, and display</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2) <span class="sc">&amp;</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight),</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<section id="rethinking-overconfident-intervals." class="level5" data-number="4.4.3.4.1">
<h5 data-number="4.4.3.4.1" class="anchored" data-anchor-id="rethinking-overconfident-intervals."><span class="header-section-number">4.4.3.4.1</span> Rethinking: Overconfident intervals.</h5>
</section>
<section id="overthinking-how-link-works." class="level5" data-number="4.4.3.4.2">
<h5 data-number="4.4.3.4.2" class="anchored" data-anchor-id="overthinking-how-link-works."><span class="header-section-number">4.4.3.4.2</span> Overthinking: How <code>link</code> works.</h5>
<p>With a <strong>brms</strong>-based workflow, we can use functions like base-<strong>R</strong> <code>fitted()</code> and <strong>tidybayes</strong> convenience functions like <code>add_epred_draws()</code> in places where McElreath used <code>link()</code> in the text. Sadly, those functions aren’t available for models fit with <strong>rstan</strong>. Either we hand-compute the expected values with a workflow like above, or in later chapters we’ll see how to build them into the Stan model via the <code>generated quantities</code> block.</p>
</section>
</section>
<section id="prediction-intervals." class="level4" data-number="4.4.3.5">
<h4 data-number="4.4.3.5" class="anchored" data-anchor-id="prediction-intervals."><span class="header-section-number">4.4.3.5</span> Prediction intervals.</h4>
<p>We can add posterior-predictions to <code>draws_fitted_df</code> by way of the <code>rnorm()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>draws_fitted_df <span class="ot">&lt;-</span> draws_fitted_df <span class="sc">|&gt;</span> </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">height_pred =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> height, <span class="at">sd =</span> sigma))</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(draws_fitted_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  .draw     a     b sigma weight height height_pred
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt;  &lt;dbl&gt;       &lt;dbl&gt;
1     1  154. 0.945  4.90     25   136.        142.
2     1  154. 0.945  4.90     26   136.        140.
3     1  154. 0.945  4.90     27   137.        144.
4     1  154. 0.945  4.90     28   138.        134.
5     1  154. 0.945  4.90     29   139.        139.
6     1  154. 0.945  4.90     30   140.        136.</code></pre>
</div>
</div>
<p>Here’s Figure 4.10.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is new</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">data =</span> draws_fitted_df,</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">y =</span> height_pred),</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">data =</span> draws_fitted_df,</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>weight),</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">range</span>(d2<span class="sc">$</span>height))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-87-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<section id="rethinking-two-kinds-of-uncertainty." class="level5" data-number="4.4.3.5.1">
<h5 data-number="4.4.3.5.1" class="anchored" data-anchor-id="rethinking-two-kinds-of-uncertainty."><span class="header-section-number">4.4.3.5.1</span> Rethinking: Two kinds of uncertainty.</h5>
</section>
<section id="overthinking-rolling-your-own-sim." class="level5" data-number="4.4.3.5.2">
<h5 data-number="4.4.3.5.2" class="anchored" data-anchor-id="overthinking-rolling-your-own-sim."><span class="header-section-number">4.4.3.5.2</span> Overthinking: Rolling your own <code>sim</code>.</h5>
<p>With a <strong>brms</strong>-based workflow, we can use functions like base-<strong>R</strong> <code>predict()</code> and <strong>tidybayes</strong> convenience functions like <code>add_predicted_draws()</code> in places where McElreath used <code>sim()</code> in the text. Sadly, those functions aren’t available for models fit with <strong>rstan</strong>. Either we hand-compute the expected values with a workflow like above, or in later chapters we’ll see how to build them into the Stan model via the <code>generated quantities</code> block.</p>
</section>
</section>
</section>
</section>
<section id="curves-from-lines" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="curves-from-lines"><span class="header-section-number">4.5</span> Curves from lines</h2>
<section id="polynomial-regression." class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="polynomial-regression."><span class="header-section-number">4.5.1</span> Polynomial regression.</h3>
<p>Remember <code>d</code>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 544
Columns: 4
$ height &lt;dbl&gt; 151.7650, 139.7000, 136.5250, 156.8450, 145.4150, 163.8300, 149…
$ weight &lt;dbl&gt; 47.82561, 36.48581, 31.86484, 53.04191, 41.27687, 62.99259, 38.…
$ age    &lt;dbl&gt; 63.0, 63.0, 65.0, 41.0, 51.0, 35.0, 32.0, 27.0, 19.0, 54.0, 47.…
$ male   &lt;int&gt; 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, …</code></pre>
</div>
</div>
<p>McElreath suggested we plot <code>height</code> against <code>weight</code> using the full sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="dv">42</span>, <span class="at">y =</span> <span class="dv">115</span>,</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"This relation is</span><span class="sc">\n</span><span class="st">visibly curved."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-89-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>We might standardize our <code>weight</code> variable like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_s =</span> (weight <span class="sc">-</span> <span class="fu">mean</span>(weight)) <span class="sc">/</span> <span class="fu">sd</span>(weight)) <span class="sc">|&gt;</span> </span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_s2 =</span> weight_s<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While we were at it, we just went ahead and computed the <code>weight_s2</code> variable. We can express our statistical model as</p>
<p><span class="math display">\[
\begin{align*}
\text{height}_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i   &amp; = \alpha + \beta_1 \text{weight-s}_i + \beta_2 \text{weight-s}^2_i \\
\alpha  &amp; \sim \operatorname{Normal}(178, 20) \\
\beta_1 &amp; \sim \operatorname{Log-Normal}(0, 1) \\
\beta_2 &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma  &amp; \sim \operatorname{Uniform}(0, 50).
\end{align*}
\]</span></p>
<p>Define and save the <code>quadratic_model_code</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>quadratic_model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] weight_s;</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real a;</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; b1;</span></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real b2;</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = a + b1 * weight_s + b2 * weight_s^2;</span></span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(178, 20);</span></span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a><span class="st">  b1 ~ lognormal(0, 1);</span></span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a><span class="st">  b2 ~ normal(0, 1);</span></span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Update the <code>stan_data</code> to include <code>weight_s</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(height, weight_s) <span class="sc">|&gt;</span> </span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compose_data</span>()</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What?</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ height  : num [1:544(1d)] 152 140 137 157 145 ...
 $ weight_s: num [1:544(1d)] 0.8299 0.0595 -0.2545 1.1843 0.385 ...
 $ n       : int 544</code></pre>
</div>
</div>
<p>Fit the quadratic model, <code>m4.5</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> quadratic_model_code,</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m4<span class="fl">.5</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

          mean se_mean   sd     5.5%    94.5% n_eff Rhat
a       146.05    0.01 0.37   145.45   146.65  2286    1
b1       21.74    0.01 0.30    21.27    22.22  2707    1
b2       -7.79    0.01 0.28    -8.24    -7.33  2381    1
sigma     5.81    0.00 0.18     5.54     6.10  3165    1
lp__  -1263.66    0.03 1.44 -1266.31 -1262.00  1880    1

Samples were drawn using NUTS(diag_e) at Wed Jul 31 18:01:20 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Here’s how to make the middle panel of Figure 4.11.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the HMC draws and wrangle</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m4<span class="fl">.5</span>) <span class="sc">|&gt;</span> </span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight_s =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">min</span>(d<span class="sc">$</span>weight_s), <span class="at">to =</span> <span class="fu">max</span>(d<span class="sc">$</span>weight_s), <span class="at">length.out =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> a <span class="sc">+</span> b1 <span class="sc">*</span> weight_s <span class="sc">+</span> b2 <span class="sc">*</span> weight_s<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predict =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> fitted, <span class="at">sd =</span> sigma)) <span class="sc">|&gt;</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_s)) <span class="sc">+</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d,</span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> predict),</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted),</span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"quadratic"</span>)</span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-95-1.png" class="img-fluid" width="216"></p>
</div>
</div>
<p>Define and fit the cubic model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>cubic_model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] weight_s;</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real a;</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; b1;</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real b2;</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="st">  real b3;</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = a + b1 * weight_s + b2 * weight_s^2 + b3 * weight_s^3;</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(178, 20);</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a><span class="st">  b1 ~ lognormal(0, 1);</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a><span class="st">  b2 ~ normal(0, 10);</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a><span class="st">  b3 ~ normal(0, 10);</span></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> cubic_model_code, </span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m4<span class="fl">.6</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

          mean se_mean   sd     5.5%    94.5% n_eff Rhat
a       146.74    0.01 0.33   146.22   147.26  2579    1
b1       15.01    0.01 0.49    14.22    15.77  2239    1
b2       -6.54    0.01 0.27    -6.97    -6.11  2404    1
b3        3.60    0.00 0.23     3.21     3.97  2195    1
sigma     4.86    0.00 0.15     4.62     5.11  2984    1
lp__  -1134.88    0.04 1.61 -1137.82 -1132.93  1661    1

Samples were drawn using NUTS(diag_e) at Wed Jul 31 18:02:32 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Here’s how to make the right panel of Figure 4.11.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m4<span class="fl">.6</span>) <span class="sc">|&gt;</span> </span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight_s =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">min</span>(d<span class="sc">$</span>weight_s), <span class="at">to =</span> <span class="fu">max</span>(d<span class="sc">$</span>weight_s), <span class="at">length.out =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> a <span class="sc">+</span> b1 <span class="sc">*</span> weight_s <span class="sc">+</span> b2 <span class="sc">*</span> weight_s<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> b3 <span class="sc">*</span> weight_s<span class="sc">^</span><span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predict =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> fitted, <span class="at">sd =</span> sigma)) <span class="sc">|&gt;</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_s)) <span class="sc">+</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d,</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> predict),</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted),</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"cubic"</span>)</span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-98-1.png" class="img-fluid" width="216"></p>
</div>
</div>
<p>Fit the simple linear model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>linear_model_code <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] height;</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] weight_s;</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a><span class="st">  real a;</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; b1;</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=50&gt; sigma;</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu;</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = a + b1 * weight_s;</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a><span class="st">  height ~ normal(mu, sigma);</span></span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(178, 20);</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a><span class="st">  b1 ~ lognormal(0, 1);</span></span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ uniform(0, 50);</span></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>m4<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> linear_model_code,</span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s how to make the first panel of Figure 4.11, and then combine to display the full figure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(m4<span class="fl">.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">weight_s =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">min</span>(d<span class="sc">$</span>weight_s), <span class="at">to =</span> <span class="fu">max</span>(d<span class="sc">$</span>weight_s), <span class="at">length.out =</span> <span class="dv">50</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> a <span class="sc">+</span> b1 <span class="sc">*</span> weight_s) <span class="sc">|&gt;</span> </span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predict =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> fitted, <span class="at">sd =</span> sigma)) <span class="sc">|&gt;</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_s)) <span class="sc">+</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> d,</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> height),</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> predict),</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted),</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.width =</span> <span class="fl">0.89</span>,</span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"royalblue"</span>, <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"royalblue"</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="st">"linear"</span>)</span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3) <span class="sc">&amp;</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">range</span>(d<span class="sc">$</span>height))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_files/figure-html/unnamed-chunk-100-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="rethinking-linear-additive-funky." class="level5" data-number="4.5.1.0.1">
<h5 data-number="4.5.1.0.1" class="anchored" data-anchor-id="rethinking-linear-additive-funky."><span class="header-section-number">4.5.1.0.1</span> Rethinking: Linear, additive, funky.</h5>
</section>
<section id="overthinking-converting-back-to-natural-scale." class="level5" data-number="4.5.1.0.2">
<h5 data-number="4.5.1.0.2" class="anchored" data-anchor-id="overthinking-converting-back-to-natural-scale."><span class="header-section-number">4.5.1.0.2</span> Overthinking: Converting back to natural scale.</h5>
</section>
</section>
<section id="splines." class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="splines."><span class="header-section-number">4.5.2</span> Splines.</h3>
<p>I’ll flesh this section out, later. For now, check out <a href="https://vincentarelbundock.github.io/rethinking2/04.html">Arel-Bundock’s code</a> for this part of the chapter.</p>
</section>
<section id="smooth-functions-for-a-rough-world." class="level3" data-number="4.5.3">
<h3 data-number="4.5.3" class="anchored" data-anchor-id="smooth-functions-for-a-rough-world."><span class="header-section-number">4.5.3</span> Smooth functions for a rough world.</h3>
</section>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.0 (2024-04-24)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] posterior_1.6.0    rstan_2.32.6       StanHeaders_2.32.7 tidybayes_3.0.6   
 [5] patchwork_1.2.0    lubridate_1.9.3    forcats_1.0.0      stringr_1.5.1     
 [9] dplyr_1.1.4        purrr_1.0.2        readr_2.1.5        tidyr_1.3.1       
[13] tibble_3.2.1       ggplot2_3.5.1      tidyverse_2.0.0   

loaded via a namespace (and not attached):
 [1] gtable_0.3.5         tensorA_0.36.2.1     xfun_0.43           
 [4] QuickJSR_1.1.3       htmlwidgets_1.6.4    processx_3.8.4      
 [7] inline_0.3.19        lattice_0.22-6       callr_3.7.6         
[10] tzdb_0.4.0           ps_1.7.6             vctrs_0.6.5         
[13] tools_4.4.0          generics_0.1.3       curl_5.2.1          
[16] stats4_4.4.0         parallel_4.4.0       fansi_1.0.6         
[19] pkgconfig_2.0.3      KernSmooth_2.23-22   Matrix_1.7-0        
[22] checkmate_2.3.1      distributional_0.4.0 RcppParallel_5.1.7  
[25] lifecycle_1.0.4      farver_2.1.1         compiler_4.4.0      
[28] munsell_0.5.1        codetools_0.2-20     htmltools_0.5.8.1   
[31] yaml_2.3.8           pillar_1.9.0         arrayhelpers_1.1-0  
[34] abind_1.4-5          tidyselect_1.2.1     digest_0.6.35       
[37] svUnit_1.0.6         stringi_1.8.4        labeling_0.4.3      
[40] fastmap_1.1.1        grid_4.4.0           colorspace_2.1-0    
[43] cli_3.6.3            magrittr_2.0.3       loo_2.8.0           
[46] pkgbuild_1.4.4       utf8_1.2.4           withr_3.0.0         
[49] scales_1.3.0         backports_1.5.0      timechange_0.3.0    
[52] rmarkdown_2.26       matrixStats_1.3.0    gridExtra_2.3       
[55] hms_1.1.3            coda_0.19-4.1        evaluate_0.23       
[58] knitr_1.46           V8_4.4.2             ggdist_3.3.2        
[61] viridisLite_0.4.2    rlang_1.1.4          isoband_0.2.7       
[64] Rcpp_1.0.12          glue_1.7.0           rstudioapi_0.16.0   
[67] jsonlite_1.8.8       R6_2.5.1            </code></pre>
</div>
</div>
</section>
<section id="comments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="comments">Comments</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="list" style="display: none">
<div id="ref-howell2001demography" class="csl-entry" role="listitem">
Howell, N. (2001). <em>Demography of the dobe! <span>Kung</span></em> (2nd Edition). Routledge. <a href="https://www.routledge.com/Demography-of-the-Dobe-Kung/Howell/p/book/9780202306490">https://www.routledge.com/Demography-of-the-Dobe-Kung/Howell/p/book/9780202306490</a>
</div>
<div id="ref-howell2010life" class="csl-entry" role="listitem">
Howell, N. (2010). <em>Life histories of the <span>Dobe</span>! <span>Kung</span>: <span>Food</span>, fatness, and well-being over the life span</em> (Vol. 4). Univ of California Press. <a href="https://www.ucpress.edu/book/9780520262348/life-histories-of-the-dobe-kung">https://www.ucpress.edu/book/9780520262348/life-histories-of-the-dobe-kung</a>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="ASKurz/Statistical_Rethinking_2_with_rstan" data-repo-id="R_kgDOMeljUg" data-category="General" data-category-id="DIC_kwDOMeljUs4ChZXD" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sampling the Imaginary</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The Many Variables &amp; The Spurious Waffles</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>